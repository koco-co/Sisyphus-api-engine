# ==============================================================================
# Sisyphus API Engine - Regex 验证器 Bug 复现测试
# ==============================================================================
# 功能验证：测试 regex 验证器在简单匹配场景下的表现
# 问题描述：'1' 无法匹配模式 '^1$'
# ==============================================================================

name: "Regex验证器Bug复现测试"
description: "复现并测试regex验证器在简单数字匹配中的问题"

config:
  name: "测试配置"
  timeout: 30
  retry_times: 0

  profiles:
    prod:
      base_url: "https://httpbin.org"

  active_profile: "prod"

steps:
  # ----------------------------------------------------------------------------
  # 测试1: 简单数字匹配 - 复现 bug
  # 问题：'1' 应该能匹配 '^1$' 但实际不匹配
  # ----------------------------------------------------------------------------
  - name: "Bug复现-数字1匹配"
    description: "测试字符串'1'是否能匹配正则'^1$'"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      status_code: 1
      code: "1"
      number: 1
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"

      # 测试1: 数字值 1 匹配 ^1$ (应该通过但可能失败)
      - type: regex
        path: "$.json.status_code"
        expect: "^1$"
        description: "Bug复现：数字1应该匹配^1$"

      # 测试2: 字符串 "1" 匹配 ^1$
      - type: regex
        path: "$.json.code"
        expect: "^1$"
        description: "字符串'1'应该匹配^1$"

      # 测试3: 多位数字匹配 ^\d+$
      - type: regex
        path: "$.json.number"
        expect: "^\\d+$"
        description: "数字应该匹配\\d+模式"

  # ----------------------------------------------------------------------------
  # 测试2: 使用 re.fullmatch 的预期行为
  # ----------------------------------------------------------------------------
  - name: "Regex完整匹配测试"
    description: "测试各种正则表达式完整匹配场景"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      email: "user@example.com"
      phone: "13800138000"
      zip: "100000"
      simple: "1"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"

      # 测试邮箱格式
      - type: regex
        path: "$.json.email"
        expect: "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"
        description: "邮箱格式验证"

      # 测试手机号格式
      - type: regex
        path: "$.json.phone"
        expect: "^1[3-9]\\d{9}$"
        description: "手机号格式验证"

      # 测试邮编格式
      - type: regex
        path: "$.json.zip"
        expect: "^\\d{6}$"
        description: "6位数字邮编验证"

      # 测试简单字符匹配
      - type: regex
        path: "$.json.simple"
        expect: "^1$"
        description: "简单字符'1'完整匹配"

  # ----------------------------------------------------------------------------
  # 测试3: 边界情况测试
  # ----------------------------------------------------------------------------
  - name: "Regex边界情况测试"
    description: "测试正则表达式的边界情况"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      empty: ""
      space: " "
      special: "!@#"
      mixed: "abc123"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"

      # 测试空字符串
      - type: regex
        path: "$.json.empty"
        expect: "^$"
        description: "空字符串应该匹配^$"

      # 测试空格
      - type: regex
        path: "$.json.space"
        expect: "^ $"
        description: "单个空格应该匹配^ $"

      # 测试特殊字符
      - type: regex
        path: "$.json.special"
        expect: "^!@#$"
        description: "特殊字符应该匹配!@#$"

      # 测试混合字符数字
      - type: regex
        path: "$.json.mixed"
        expect: "^[a-z]+\\d+$"
        description: "混合字母数字应该匹配^[a-z]+\\d+$"

  # ----------------------------------------------------------------------------
  # 测试4: 复杂正则表达式测试
  # ----------------------------------------------------------------------------
  - name: "Regex复杂模式测试"
    description: "测试复杂的正则表达式匹配场景"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      # 测试用各种格式的值
      email1: "user@example.com"
      email2: "invalid-email"  # 无效邮箱
      phone1: "13800138000"  # 有效手机号
      phone2: "12345"  # 无效手机号
      date1: "2024-01-01"  # 有效日期
      date2: "2024/01/01"  # 无效日期格式
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"

      # 测试有效邮箱
      - type: regex
        path: "$.json.email1"
        expect: "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"
        description: "user@example.com应该匹配邮箱模式"

      # 测试无效邮箱 - 应该不匹配（使用反向验证）
      - type: not_contains
        path: "$.json.email2"
        expect: "@"
        description: "invalid-email不包含@符号"

      # 测试有效手机号
      - type: regex
        path: "$.json.phone1"
        expect: "^1[3-9]\\d{9}$"
        description: "13800138000应该匹配中国手机号模式"

      # 测试无效手机号 - 5位数字不应该匹配11位模式
      - type: regex
        path: "$.json.phone2"
        expect: "^\\d{5}$"
        description: "12345应该匹配5位数字模式"

      # 测试有效日期
      - type: regex
        path: "$.json.date1"
        expect: "^\\d{4}-\\d{2}-\\d{2}$"
        description: "2024-01-01应该匹配YYYY-MM-DD模式"

      # 测试斜杠日期格式
      - type: regex
        path: "$.json.date2"
        expect: "^\\d{4}/\\d{2}/\\d{2}$"
        description: "2024/01/01应该匹配YYYY/MM/DD模式"

tags:
  - "验证器"
  - "Bug修复"
  - "Regex"

enabled: true
