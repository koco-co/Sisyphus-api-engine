# ==============================================================================
# Sisyphus API Engine - 验证器修复验证测试
# ==============================================================================
# 功能验证：测试修复后的验证器功能
# - gte/lte: 大于等于/小于等于验证器
# - in: 多值验证器
# - regex: 正则表达式验证器
# - starts_with/ends_with: 字符串前缀/后缀验证器
# ==============================================================================

name: "验证器修复验证测试"
description: "测试修复后的验证器功能（gte/lte/in/regex/starts_with/ends_with）"

config:
  name: "测试配置"
  timeout: 30
  retry_times: 0

  profiles:
    prod:
      base_url: "https://httpbin.org"

  active_profile: "prod"

# ============================================================================
# 测试步骤
# ============================================================================
steps:
  # ----------------------------------------------------------------------------
  # 步骤1: gte 比较器测试 - 大于等于
  # ----------------------------------------------------------------------------
  - name: "gte大于等于验证器"
    description: "测试gte大于等于验证器"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      value: 100
      score: 95
      count: 100
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
      # 测试大于
      - type: gte
        path: "$.json.value"
        expect: 100
        description: "100 >= 100 应该为真"
      # 测试等于
      - type: gte
        path: "$.json.count"
        expect: 100
        description: "100 >= 100 应该为真"
      # 测试小于
      - type: gte
        path: "$.json.score"
        expect: 90
        description: "95 >= 90 应该为真"

  # ----------------------------------------------------------------------------
  # 步骤2: lte 比较器测试 - 小于等于
  # ----------------------------------------------------------------------------
  - name: "lte小于等于验证器"
    description: "测试lte小于等于验证器"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      value: 50
      score: 80
      count: 50
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
      # 测试小于
      - type: lte
        path: "$.json.value"
        expect: 100
        description: "50 <= 100 应该为真"
      # 测试等于
      - type: lte
        path: "$.json.count"
        expect: 50
        description: "50 <= 50 应该为真"
      # 测试大于
      - type: lte
        path: "$.json.score"
        expect: 90
        description: "80 <= 90 应该为真"

  # ----------------------------------------------------------------------------
  # 步骤3: in 比较器测试 - 多值验证
  # ----------------------------------------------------------------------------
  - name: "in多值验证器"
    description: "测试in多值验证器"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      status: "success"
      code: 200
      role: "admin"
      environment: "production"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
      # 测试字符串在列表中
      - type: in
        path: "$.json.status"
        expect: ["success", "pending", "failed"]
        description: "status应该在允许的状态列表中"
      # 测试数字在列表中
      - type: in
        path: "$.json.code"
        expect: [200, 201, 204]
        description: "code应该在允许的状态码列表中"
      # 测试角色在列表中
      - type: in
        path: "$.json.role"
        expect: ["admin", "user", "guest"]
        description: "role应该在允许的角色列表中"
      # 测试环境在列表中
      - type: in
        path: "$.json.environment"
        expect: ["development", "staging", "production"]
        description: "environment应该在允许的环境列表中"

  # ----------------------------------------------------------------------------
  # 步骤4: regex 比较器测试 - 正则表达式验证
  # ----------------------------------------------------------------------------
  - name: "regex正则表达式验证器"
    description: "测试regex正则表达式验证器"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      email: "user@example.com"
      phone: "13800138000"
      zipcode: "100000"
      ipv4: "192.168.1.1"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
      # 测试邮箱正则验证
      - type: regex
        path: "$.json.email"
        expect: "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"
        description: "验证邮箱格式"
      # 测试手机号正则验证
      - type: regex
        path: "$.json.phone"
        expect: "^1[3-9]\\d{9}$"
        description: "验证中国手机号格式"
      # 测试邮编正则验证
      - type: regex
        path: "$.json.zipcode"
        expect: "^\\d{6}$"
        description: "验证6位数字邮编"
      # 测试IP地址正则验证
      - type: regex
        path: "$.json.ipv4"
        expect: "^\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}$"
        description: "验证IPv4地址格式"

  # ----------------------------------------------------------------------------
  # 步骤5: starts_with 比较器测试 - 前缀匹配
  # ----------------------------------------------------------------------------
  - name: "starts_with前缀匹配验证器"
    description: "测试starts_with前缀匹配验证器"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      url: "https://www.example.com"
      filepath: "/var/log/app.log"
      jwt: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
      # 测试URL协议前缀
      - type: starts_with
        path: "$.json.url"
        expect: "https://"
        description: "验证URL使用HTTPS协议"
      # 测试文件路径前缀
      - type: starts_with
        path: "$.json.filepath"
        expect: "/var/log/"
        description: "验证日志文件路径前缀"
      # 测试JWT编码前缀
      - type: starts_with
        path: "$.json.jwt"
        expect: "eyJ"
        description: "验证JWT Base64编码前缀"

  # ----------------------------------------------------------------------------
  # 步骤6: ends_with 比较器测试 - 后缀匹配
  # ----------------------------------------------------------------------------
  - name: "ends_with后缀匹配验证器"
    description: "测试ends_with后缀匹配验证器"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      image: "photo.png"
      document: "report.pdf"
      script: "app.js"
      domain: "example.com"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
      # 测试图片文件后缀
      - type: ends_with
        path: "$.json.image"
        expect: ".png"
        description: "验证图片为PNG格式"
      # 测试文档文件后缀
      - type: ends_with
        path: "$.json.document"
        expect: ".pdf"
        description: "验证文档为PDF格式"
      # 测试脚本文件后缀
      - type: ends_with
        path: "$.json.script"
        expect: ".js"
        description: "验证脚本为JavaScript文件"
      # 测试域名后缀
      - type: ends_with
        path: "$.json.domain"
        expect: ".com"
        description: "验证域名为.com后缀"

  # ----------------------------------------------------------------------------
  # 步骤7: 综合验证测试 - 结合多种验证器
  # ----------------------------------------------------------------------------
  - name: "综合验证器测试"
    description: "综合使用多种验证器进行验证"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      user:
        id: 100
        name: "testuser"
        email: "user@example.com"
        age: 25
        role: "admin"
        status: "active"
        website: "https://example.com"
        avatar: "avatar.png"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"

      # 数值验证
      - type: gte
        path: "$.json.user.id"
        expect: 1
        description: "用户ID应大于等于1"
      - type: gte
        path: "$.json.user.age"
        expect: 18
        description: "用户年龄应大于等于18"
      - type: lte
        path: "$.json.user.age"
        expect: 100
        description: "用户年龄应小于等于100"

      # 字符串验证
      - type: starts_with
        path: "$.json.user.website"
        expect: "https://"
        description: "网站URL应使用HTTPS"
      - type: ends_with
        path: "$.json.user.avatar"
        expect: ".png"
        description: "头像应为PNG格式"
      - type: regex
        path: "$.json.user.email"
        expect: "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"
        description: "邮箱格式应正确"

      # 列表验证
      - type: in
        path: "$.json.user.role"
        expect: ["admin", "user", "guest"]
        description: "角色应在允许列表中"
      - type: in
        path: "$.json.user.status"
        expect: ["active", "inactive", "pending"]
        description: "状态应在允许列表中"

# ============================================================================
# 标签
# ============================================================================
tags:
  - "验证"
  - "修复"
  - "测试"

enabled: true
