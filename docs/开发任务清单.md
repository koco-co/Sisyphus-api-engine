# sisyphus-api-engine 开发任务清单

> **文档版本**: v1.0
> **创建日期**: 2026-02-26
> **最后更新**: 2026-02-26
> **关联文档**: [需求文档](./Sisyphus-api-engine需求文档.md)、[YAML 输入规范](./Sisyphus-api-engine%20YAML%20输入规范.md)、[JSON 输出规范](./Sisyphus-api-engine%20JSON%20输出规范.md)

---

## 状态说明

| 标记 | 含义 |
|------|------|
| `[x]` | 已完成（代码 + 单元测试均通过） |
| `[~]` | 开发中（代码存在但功能不完整） |
| `[ ]` | 待开发 |
| `[-]` | 已取消/推迟 |

---

## 1. 项目基础设施

| 编号 | 任务 | 文件 | 状态 | 说明 |
|------|------|------|------|------|
| INF-001 | pyproject.toml 配置 | `pyproject.toml` | `[x]` | 包名/版本/依赖/CLI 入口/Ruff/Pyright/pytest 配置 |
| INF-002 | apirun 包结构初始化 | `apirun/__init__.py` | `[x]` | 导出 `__version__` 和 `Keyword` 基类 |
| INF-003 | 子模块目录占位 | `apirun/*/\__init__.py` | `[x]` | core/parser/executor/validation/extractor/data_driven/result/websocket/utils |
| INF-004 | 自定义关键字基类 | `apirun/keyword.py` | `[x]` | `Keyword` 基类，提供 `execute(**kwargs)` 抽象方法 |
| INF-005 | pytest 配置 | `pyproject.toml [tool.pytest]` | `[x]` | testpaths/markers/addopts |
| INF-006 | .sisyphus/config.yaml | `.sisyphus/config.yaml` | `[x]` | 统一环境配置文件 |
| INF-007 | README.md | `README.md` | `[x]` | 使用说明/项目结构/开发命令/发布流程 |

---

## 2. YAML 输入数据模型 (`apirun/core/models.py`)

| 编号 | 任务 | 状态 | 说明 |
|------|------|------|------|
| MDL-001 | CaseModel 顶层结构 | `[x]` | config(必填) + teststeps(必填) + ddts(选填) |
| MDL-002 | Config 场景配置模型 | `[x]` | name/description/project_id/scenario_id/priority/tags/environment/variables/pre_sql/post_sql/csv_datasource |
| MDL-003 | EnvironmentConfig 环境配置 | `[x]` | name/base_url/variables |
| MDL-004 | PrePostSql 前置/后置 SQL | `[x]` | datasource/statements |
| MDL-005 | RequestStepParams HTTP 请求参数 | `[x]` | method/url/headers/params/json(alias)/data/files/cookies/timeout/allow_redirects/verify |
| MDL-006 | ExtractRule 变量提取规则 | `[x]` | name/type/expression/scope/default/source_variable |
| MDL-007 | ValidateRule 内联断言规则 | `[x]` | target/comparator/expected/expression/message |
| MDL-008 | AssertionParams 独立断言参数 | `[x]` | target/comparator/expected/source_variable/expression/message |
| MDL-009 | DbExtractRule 数据库提取规则 | `[x]` | name/expression/scope/default |
| MDL-010 | DbValidateRule 数据库断言规则 | `[x]` | expression/comparator/expected/message |
| MDL-011 | DbParams 数据库操作参数 | `[x]` | datasource/sql/extract(DbExtractRule[])/validate(DbValidateRule[]) |
| MDL-012 | CustomParams 自定义关键字参数 | `[x]` | parameters(dict)/extract(ExtractRule[]) |
| MDL-013 | StepDefinition 步骤定义 | `[x]` | name/keyword_type/keyword_name/enabled + request/extract/validate/assertion/db/custom |
| MDL-014 | Ddts 数据驱动定义 | `[x]` | name/parameters(list[dict]) |
| MDL-015 | RequestStepParams 互斥校验 | `[ ]` | json/data/files 三者互斥的 model_validator |
| MDL-016 | Config csv_datasource 与 ddts 互斥校验 | `[ ]` | CaseModel 级别的 model_validator |

---

## 3. JSON 输出数据模型 (`apirun/result/models.py`)

| 编号 | 任务 | 状态 | 说明 |
|------|------|------|------|
| OUT-001 | ErrorInfo 错误信息模型 | `[x]` | code/message/detail |
| OUT-002 | ExecutionSummary 执行摘要模型 | `[x]` | 16 个统计字段：total_steps/passed_steps/.../total_data_driven_runs |
| OUT-003 | EnvironmentInfo 环境快照模型 | `[x]` | name/base_url/variables |
| OUT-004 | RequestDetail 请求详情模型 | `[x]` | method/url/headers/params/body/body_type/timeout/allow_redirects/verify_ssl |
| OUT-005 | ResponseDetail 响应详情模型 | `[x]` | status_code/headers/body/body_size/response_time/cookies |
| OUT-006 | AssertionResult 断言结果模型 | `[x]` | target/expression/comparator/expected/actual/status/message |
| OUT-007 | ExtractResult 提取结果模型 | `[x]` | name/type/expression/scope/value/status |
| OUT-008 | DbDetail 数据库详情模型 | `[x]` | datasource/sql/sql_rendered/row_count/columns/rows/execution_time |
| OUT-009 | CustomDetail 自定义详情模型 | `[x]` | keyword_name/parameters_input/return_value/execution_time |
| OUT-010 | StepResult 步骤结果模型 | `[x]` | 12 个通用字段 + 条件详情字段 |
| OUT-011 | LogEntry 日志条目模型 | `[x]` | timestamp/level/message/step_index |
| OUT-012 | DataDrivenRun 单轮结果模型 | `[x]` | run_index/parameters/status/duration/summary/steps |
| OUT-013 | DataDrivenResult 数据驱动结果模型 | `[x]` | enabled/source/dataset_name/total_runs/passed_runs/failed_runs/pass_rate/runs |
| OUT-014 | ExecutionResult 顶层结果模型 | `[x]` | 14 个顶层字段 + model_dump() 可序列化 |

---

## 4. YAML 解析器 (`apirun/parser/`)

| 编号 | 任务 | 文件 | 状态 | 说明 |
|------|------|------|------|------|
| PAR-001 | yaml_parser: 读取 YAML 并解析为 dict | `yaml_parser.py` | `[x]` | 封装 yaml.safe_load，统一异常处理 |
| PAR-002 | yaml_parser: 文件不存在时错误码 FILE_NOT_FOUND | `yaml_parser.py` | `[x]` | 抛出带 error code 的 EngineError |
| PAR-003 | yaml_parser: YAML 语法错误时错误码 YAML_PARSE_ERROR | `yaml_parser.py` | `[x]` | 捕获 yaml.YAMLError |
| PAR-004 | yaml_parser: Pydantic 校验失败时错误码 YAML_VALIDATION_ERROR | `yaml_parser.py` | `[x]` | 捕获 ValidationError |
| PAR-005 | yaml_parser: 返回 CaseModel 实例 | `yaml_parser.py` | `[x]` | `parse_yaml(path) -> CaseModel` |
| PAR-006 | csv_parser: 读取 CSV 并解析为 list[dict] | `csv_parser.py` | `[x]` | 第一行为表头，后续行为数据 |
| PAR-007 | csv_parser: 文件不存在时错误码 CSV_FILE_NOT_FOUND | `csv_parser.py` | `[x]` | |
| PAR-008 | csv_parser: 格式错误时错误码 CSV_PARSE_ERROR | `csv_parser.py` | `[x]` | |
| PAR-009 | EngineError 统一异常类 | `apirun/errors.py` | `[x]` | code/message/detail 属性，所有模块复用 |

---

## 5. 变量系统 (`apirun/utils/`)

### 5.1 内置函数 (`apirun/utils/functions.py`)

| 编号 | 任务 | 状态 | 说明 |
|------|------|------|------|
| FN-001 | `random(n)` 随机字符串 | `[x]` | 小写字母+数字，n 位 |
| FN-002 | `random_uuid()` UUID4 | `[x]` | 标准 UUID 格式 |
| FN-003 | `timestamp()` 秒级时间戳 | `[x]` | 返回 int |
| FN-004 | `timestamp_ms()` 毫秒时间戳 | `[x]` | 返回 int |
| FN-005 | `datetime(fmt)` 格式化时间 | `[x]` | strftime 格式 |
| FN-006 | BUILTIN_FUNCTIONS 注册表 | `[x]` | name → callable 映射 |

### 5.2 变量替换引擎 (`apirun/utils/variables.py`)

| 编号 | 任务 | 状态 | 说明 |
|------|------|------|------|
| VAR-001 | `render_template(template, variables)` 入口函数 | `[x]` | 支持 str/dict/list/tuple 任意嵌套 |
| VAR-002 | `render_value()` 递归渲染 | `[x]` | dict 递归 key+value, list 递归元素 |
| VAR-003 | `_render_string()` 单字符串渲染 | `[x]` | 完整 `{{...}}` 表达式返回原始类型 |
| VAR-004 | `_eval_function()` 内置函数调用 | `[x]` | 解析 `func(arg1, arg2)` 语法 |
| VAR-005 | `{{变量名}}` 简单变量替换 | `[x]` | 从 variables dict 中查找 |
| VAR-006 | `{{func()}}` 无参函数调用 | `[x]` | 查 BUILTIN_FUNCTIONS 表 |
| VAR-007 | `{{func(arg)}}` 带参函数调用 | `[x]` | 支持字符串/整数参数 |
| VAR-008 | VariableRenderError 异常 | `[x]` | 变量未找到/函数未知时抛出 |
| VAR-009 | 全局参数函数调用支持 | `[x]` | GLOBAL_PARAM_FUNCTIONS + register_global_param_function，变量优先 |
| VAR-010 | 变量池管理器 (VariablePool) | `[x]` | 分层变量池：data_driven > extracted > scenario > environment > global_params |
| VAR-011 | 变量作用域 scope 支持 | `[x]` | global 写入 extracted 层, environment 写入 environment 层 |

---

## 6. HTTP 请求执行器 (`apirun/executor/request.py`)

| 编号 | 任务 | 状态 | 说明 |
|------|------|------|------|
| REQ-001 | 支持 GET/POST/PUT/DELETE/PATCH/HEAD/OPTIONS | `[x]` | 通过 `requests.request(method=...)` |
| REQ-002 | 相对路径自动拼接 base_url | `[x]` | 非 http:// 开头时拼接 |
| REQ-003 | URL 中 `{{变量}}` 替换 | `[x]` | 通过 render_template |
| REQ-004 | headers 变量替换 | `[x]` | 递归渲染 |
| REQ-005 | params (Query String) 变量替换 | `[x]` | 递归渲染 |
| REQ-006 | json body 变量替换 | `[x]` | 递归渲染 |
| REQ-007 | form data 变量替换 | `[x]` | 递归渲染 |
| REQ-008 | files 变量替换 | `[x]` | 递归渲染 |
| REQ-009 | cookies 变量替换 | `[x]` | 递归渲染 |
| REQ-010 | timeout 超时设置 | `[x]` | 默认 30s |
| REQ-011 | allow_redirects 重定向控制 | `[x]` | 默认 true |
| REQ-012 | verify SSL 证书控制 | `[x]` | 默认 true |
| REQ-013 | 返回 status_code/headers/body/body_size/response_time/cookies | `[x]` | 完整响应信息 |
| REQ-014 | 响应体 JSON 自动解析, 非 JSON 回退为 text | `[x]` | try resp.json() except → resp.text |
| REQ-015 | REQUEST_TIMEOUT 错误码 | `[x]` | 捕获 requests.Timeout |
| REQ-016 | REQUEST_SSL_ERROR 错误码 | `[x]` | 捕获 requests.SSLError |
| REQ-017 | REQUEST_CONNECTION_ERROR 错误码 | `[x]` | 捕获其他 requests 异常 |
| REQ-018 | files 参数 MinIO 路径下载 | `[ ]` | Value 为 MinIO 路径时自动下载为临时文件再上传 |

---

## 7. 断言验证引擎 (`apirun/validation/`)

| 编号 | 任务 | 文件 | 状态 | 说明 |
|------|------|------|------|------|
| VLD-001 | comparators: `eq` (等于) | `comparators.py` | `[x]` | |
| VLD-002 | comparators: `neq` (不等于) | `comparators.py` | `[x]` | |
| VLD-003 | comparators: `gt` (大于) | `comparators.py` | `[x]` | |
| VLD-004 | comparators: `gte` (大于等于) | `comparators.py` | `[x]` | |
| VLD-005 | comparators: `lt` (小于) | `comparators.py` | `[x]` | |
| VLD-006 | comparators: `lte` (小于等于) | `comparators.py` | `[x]` | |
| VLD-007 | comparators: `contains` (包含) | `comparators.py` | `[x]` | 字符串/列表 |
| VLD-008 | comparators: `not_contains` (不包含) | `comparators.py` | `[x]` | |
| VLD-009 | comparators: `startswith` (前缀) | `comparators.py` | `[x]` | |
| VLD-010 | comparators: `endswith` (后缀) | `comparators.py` | `[x]` | |
| VLD-011 | comparators: `matches` (正则) | `comparators.py` | `[x]` | re.search |
| VLD-012 | comparators: `type_match` (类型匹配) | `comparators.py` | `[x]` | int/str/list/dict/bool/null |
| VLD-013 | comparators: `length_eq` (长度等于) | `comparators.py` | `[x]` | |
| VLD-014 | comparators: `length_gt` (长度大于) | `comparators.py` | `[x]` | |
| VLD-015 | comparators: `length_lt` (长度小于) | `comparators.py` | `[x]` | |
| VLD-016 | comparators: `is_null` (为空) | `comparators.py` | `[x]` | |
| VLD-017 | comparators: `is_not_null` (不为空) | `comparators.py` | `[x]` | |
| VLD-018 | validator: target=json (JSONPath 提取) | `validator.py` | `[x]` | 使用 jsonpath-ng |
| VLD-019 | validator: target=header (响应头提取) | `validator.py` | `[x]` | 按名称取值 |
| VLD-020 | validator: target=cookie (Cookie 提取) | `validator.py` | `[x]` | 按名称取值 |
| VLD-021 | validator: target=status_code | `validator.py` | `[x]` | 直接取状态码 |
| VLD-022 | validator: target=response_time | `validator.py` | `[x]` | 直接取响应耗时 ms |
| VLD-023 | validator: target=env_variable | `validator.py` | `[x]` | 从变量池取值 |
| VLD-024 | validator: expected 中 `{{变量}}` 替换 | `validator.py` | `[x]` | 渲染后再比较 |
| VLD-025 | validator: 返回 AssertionResult 结构 | `validator.py` | `[x]` | target/expression/comparator/expected/actual/status/message |
| VLD-026 | validator: 失败时返回自定义 message 或默认消息 | `validator.py` | `[x]` | |
| VLD-027 | validator: 数据库结果断言 (`$.length` 内置) | `validator.py` | `[x]` | db_result target |

---

## 8. 变量提取器 (`apirun/extractor/`)

| 编号 | 任务 | 文件 | 状态 | 说明 |
|------|------|------|------|------|
| EXT-001 | extractor: type=json (JSONPath 提取) | `extractor.py` | `[x]` | jsonpath-ng 求值 |
| EXT-002 | extractor: type=header (响应头提取) | `extractor.py` | `[x]` | 按名称取值 |
| EXT-003 | extractor: type=cookie (Cookie 提取) | `extractor.py` | `[x]` | 按名称取值 |
| EXT-004 | extractor: scope=global 写入全局池 | `extractor.py` | `[x]` | 结果 scope 供调用方写入 |
| EXT-005 | extractor: scope=environment 写入环境池 | `extractor.py` | `[x]` | 结果 scope 供调用方写入 |
| EXT-006 | extractor: 提取失败使用 default 默认值 | `extractor.py` | `[x]` | |
| EXT-007 | extractor: 无 default 时 status=failed | `extractor.py` | `[x]` | |
| EXT-008 | extractor: 返回 ExtractResult 结构 | `extractor.py` | `[x]` | name/type/expression/scope/value/status |
| EXT-009 | extractor: source_variable 指定数据源 | `extractor.py` | `[x]` | 默认上一个 request 响应 |
| EXT-010 | extractor: db_result 类型 (数据库结果提取) | `extractor.py` | `[x]` | JSONPath 从 rows JSON 数组提取 |

---

## 9. 数据库执行器 (`apirun/executor/db.py`)

| 编号 | 任务 | 状态 | 说明 |
|------|------|------|------|
| DB-001 | datasource 引用变量名解析 | `[x]` | 从变量池查找连接配置 |
| DB-002 | MySQL 连接 (pymysql) | `[x]` | host/port/user/password/database |
| DB-003 | PostgreSQL 连接 (psycopg2) | `[x]` | host/port/user/password/database |
| DB-004 | SQL 语句 `{{变量}}` 替换 | `[x]` | 使用 render_template |
| DB-005 | 执行 SQL 查询并返回 JSON 数组 | `[x]` | 列名 → dict key |
| DB-006 | 返回 db_detail 结构 | `[x]` | datasource/sql/sql_rendered/row_count/columns/rows/execution_time |
| DB-007 | DB_CONNECTION_ERROR 错误码 | `[x]` | 连接失败 |
| DB-008 | DB_QUERY_ERROR 错误码 | `[x]` | SQL 执行失败 |
| DB-009 | DB_DATASOURCE_NOT_FOUND 错误码 | `[x]` | 数据源未找到 |
| DB-010 | db.extract 结果提取 | `[x]` | JSONPath 从查询结果中提取变量 |
| DB-011 | db.validate 结果断言 | `[x]` | JSONPath + `$.length` 内置表达式 |

---

## 10. 自定义关键字执行器 (`apirun/executor/custom.py`)

| 编号 | 任务 | 状态 | 说明 |
|------|------|------|------|
| CST-001 | 根据 keyword_name 查找自定义关键字类 | `[x]` | KEYWORD_REGISTRY + register_keyword |
| CST-002 | 将 parameters 传入 execute() | `[x]` | **kwargs 展开，先变量渲染 |
| CST-003 | 捕获 return_value | `[x]` | 供后续 extract 使用 |
| CST-004 | 返回 custom_detail 结构 | `[x]` | keyword_name/parameters_input/return_value/execution_time |
| CST-005 | KEYWORD_NOT_FOUND 错误码 | `[x]` | 关键字未注册 |
| CST-006 | KEYWORD_EXECUTION_ERROR 错误码 | `[x]` | 执行异常 |
| CST-007 | 从 extract 字段提取变量 | `[x]` | custom 步骤可内嵌 extract |

---

## 11. 场景运行器 (`apirun/core/runner.py`)

### 11.1 基础运行流程

| 编号 | 任务 | 状态 | 说明 |
|------|------|------|------|
| RUN-001 | `load_case(yaml_path)` 加载 YAML | `[x]` | 文件读取 + yaml.safe_load + Pydantic 校验 |
| RUN-002 | `run_case(case)` 顺序执行 teststeps | `[x]` | 遍历 step 数组 |
| RUN-003 | request 步骤: 调用 HTTP 执行器 | `[x]` | 仅 request 类型走 execute_request_step |
| RUN-004 | 变量池初始化 (environment.variables + config.variables) | `[x]` | dict 合并 |
| RUN-005 | 生成 execution_id (UUID) | `[x]` | `exec-{uuid.hex[:12]}` |
| RUN-006 | 顶层 JSON 输出 14 个字段 | `[x]` | execution_id ~ error |
| RUN-007 | summary 统计 16 个字段 | `[x]` | total_steps ~ total_data_driven_runs |

### 11.2 步骤调度增强

| 编号 | 任务 | 状态 | 说明 |
|------|------|------|------|
| RUN-008 | enabled=false 时 status=skipped | `[x]` | 生成 skipped StepResult |
| RUN-009 | assertion 步骤: 调用断言验证引擎 | `[x]` | 独立断言步骤执行 |
| RUN-010 | extract 步骤: 调用变量提取器 | `[x]` | 独立提取步骤执行 |
| RUN-011 | db 步骤: 调用数据库执行器 | `[x]` | 调用 execute_db_step_safe + extract/validate |
| RUN-012 | custom 步骤: 调用自定义关键字执行器 | `[~]` | 暂跳过，生成 skipped |
| RUN-013 | request 步骤内联 extract 执行 | `[x]` | 请求后立即提取变量 |
| RUN-014 | request 步骤内联 validate 执行 | `[x]` | 请求后立即断言 |
| RUN-015 | 步骤异常捕获: status=error, 不中断后续 | `[x]` | try/except 包装每步 |
| RUN-016 | 场景整体 status 计算 | `[x]` | 基于步骤结果 passed/failed/error |
| RUN-017 | assertion_results 统计到 summary | `[x]` | total_assertions/passed_assertions/failed_assertions/pass_rate |

### 11.3 前置/后置处理

| 编号 | 任务 | 状态 | 说明 |
|------|------|------|------|
| RUN-018 | pre_sql 前置 SQL 执行 | `[x]` | 调用数据库执行器, 在 teststeps 之前 |
| RUN-019 | post_sql 后置 SQL 执行 | `[x]` | 在 teststeps 之后执行 (无论成功失败) |

### 11.4 数据驱动集成

| 编号 | 任务 | 状态 | 说明 |
|------|------|------|------|
| RUN-020 | 检测 ddts 字段启动数据驱动模式 | `[x]` | get_parameter_sets + run_data_driven |
| RUN-021 | 检测 csv_datasource 启动 CSV 数据驱动 | `[x]` | 解析 CSV 后循环执行 |
| RUN-022 | 每轮注入数据驱动变量到变量池 | `[x]` | pool.set_data_driven(params) |
| RUN-023 | 合并 DataDrivenResult 到顶层 | `[x]` | data_driven 字段 |

### 11.5 日志收集

| 编号 | 任务 | 状态 | 说明 |
|------|------|------|------|
| RUN-024 | LogCollector 日志收集器 | `[x]` | 场景开始/步骤开始/步骤完成/场景完成 |
| RUN-025 | 生成 LogEntry (timestamp/level/message/step_index) | `[x]` | 写入 logs 数组 |
| RUN-026 | DEBUG 级别: 请求 URL/方法详情 | `[x]` | 仅 verbose 模式 |

### 11.6 重构: 使用输出数据模型

| 编号 | 任务 | 状态 | 说明 |
|------|------|------|------|
| RUN-027 | runner 返回 ExecutionResult 模型 (非裸 dict) | `[x]` | 使用 OUT-014 定义的 Pydantic 模型 |
| RUN-028 | StepResult 模型化 | `[x]` | 通过 model_validate 从 dict 构建 StepResult |

---

## 12. 数据驱动 (`apirun/data_driven/`)

| 编号 | 任务 | 文件 | 状态 | 说明 |
|------|------|------|------|------|
| DDT-001 | YAML 内联数据驱动 (ddts 字段解析) | `driver.py` | `[x]` | 遍历 ddts.parameters 数组 |
| DDT-002 | CSV 文件数据驱动 (csv_datasource) | `driver.py` | `[x]` | 调用 csv_parser 解析 |
| DDT-003 | 每行数据 = 一次独立场景执行 | `driver.py` | `[x]` | run_case(case, data_driven_vars=params) |
| DDT-004 | 数据集字段通过 `{{字段名}}` 注入 | `driver.py` | `[x]` | 变量池 set_data_driven |
| DDT-005 | 返回 DataDrivenResult 结构 | `driver.py` | `[x]` | enabled/source/dataset_name/total_runs/... |
| DDT-006 | 每轮 runs: run_index/parameters/status/duration/summary/steps | `driver.py` | `[x]` | |
| DDT-007 | source 标识: yaml_inline / csv_file | `driver.py` | `[x]` | |
| DDT-008 | 汇总所有轮次到顶层 summary 和 status | `driver.py` | `[x]` | 首轮结果 + data_driven + total_data_driven_runs |

---

## 13. 结果收集器 (`apirun/result/`)

### 13.1 JSON 报告 (`-O json`)

| 编号 | 任务 | 文件 | 状态 | 说明 |
|------|------|------|------|------|
| RPT-001 | JSON 输出到 stdout | `json_reporter.py` | `[x]` | to_json() 供 CLI 调用 |
| RPT-002 | ensure_ascii=False 支持中文 | `json_reporter.py` | `[x]` | 已实现 |
| RPT-003 | 时间字段 ISO 8601 含时区 | `json_reporter.py` | `[x]` | runner 使用 timezone.utc isoformat 含 +00:00 |
| RPT-004 | 引擎级异常时输出 error 对象 | `json_reporter.py` | `[x]` | to_json_engine_error() 提供 status=error + error |

### 13.2 Text 报告 (`-O text`)

| 编号 | 任务 | 文件 | 状态 | 说明 |
|------|------|------|------|------|
| RPT-005 | rich 库渲染终端美化输出 | `text_reporter.py` | `[x]` | Table/Panel/Console |
| RPT-006 | 场景名称/状态/耗时/步骤概览 | `text_reporter.py` | `[x]` | 摘要信息 |
| RPT-007 | -v/--verbose 控制详细程度 | `text_reporter.py` | `[x]` | verbose=True 显示请求/响应详情 |

### 13.3 Allure 报告 (`-O allure`)

| 编号 | 任务 | 文件 | 状态 | 说明 |
|------|------|------|------|------|
| RPT-008 | 生成 Allure JSON 结果文件 | `allure_reporter.py` | `[ ]` | 写入 --allure-dir 目录 |
| RPT-009 | 步骤映射为 Allure Step | `allure_reporter.py` | `[ ]` | |
| RPT-010 | 断言结果映射为 Attachment | `allure_reporter.py` | `[ ]` | |

### 13.4 HTML 报告 (`-O html`)

| 编号 | 任务 | 文件 | 状态 | 说明 |
|------|------|------|------|------|
| RPT-011 | 生成自包含 HTML 报告文件 | `html_reporter.py` | `[ ]` | 写入 --html-dir 目录 |
| RPT-012 | 包含摘要/步骤详情/断言/响应数据 | `html_reporter.py` | `[ ]` | |

---

## 14. CLI 命令行接口 (`apirun/cli.py`)

| 编号 | 任务 | 状态 | 说明 |
|------|------|------|------|
| CLI-001 | `sisyphus` 命令注册 | `[x]` | pyproject.toml [project.scripts] |
| CLI-002 | `--case` 单用例参数 | `[x]` | 指定 YAML 文件路径 |
| CLI-003 | `--cases` 批量执行参数 | `[x]` | 目录下递归查找 *.yaml / *.yml |
| CLI-004 | `-O / --output-format` 输出格式 | `[x]` | text/json/allure/html 四选一 |
| CLI-005 | `--allure-dir` 参数 | `[x]` | 定义已存在，待集成 allure_reporter |
| CLI-006 | `--html-dir` 参数 | `[x]` | 定义已存在，待集成 html_reporter |
| CLI-007 | `-v / --verbose` 参数 | `[x]` | 定义已存在，待传递给 text_reporter |
| CLI-008 | YAML 不存在时 exit code 1 + stderr | `[x]` | FileNotFoundError 处理 |
| CLI-009 | 执行成功时 exit code 0 | `[x]` | |
| CLI-010 | 引擎异常时 exit code 1 | `[x]` | |
| CLI-011 | 集成 json_reporter 模块 | `[x]` | 使用 to_json() 输出 |
| CLI-012 | 集成 text_reporter 模块 | `[x]` | render_text(result, verbose) |
| CLI-013 | 集成 allure_reporter 模块 | `[ ]` | 调用 allure_reporter.generate() |
| CLI-014 | 集成 html_reporter 模块 | `[ ]` | 调用 html_reporter.generate() |
| CLI-015 | 断言失败时 exit code 0, status=failed | `[x]` | 仅引擎异常时 exit 1 |

---

## 15. WebSocket 实时推送 (`apirun/websocket/`)

| 编号 | 任务 | 文件 | 状态 | 说明 |
|------|------|------|------|------|
| WS-001 | EventPublisher 发布器 | `publisher.py` | `[ ]` | 场景开始/步骤开始/步骤完成/场景完成 |
| WS-002 | 推送消息格式 | `publisher.py` | `[ ]` | event_type/step_index/status/timestamp/data |
| WS-003 | WebSocket 连接失败降级 | `publisher.py` | `[ ]` | 不影响用例执行 |
| WS-004 | runner 集成 publisher | `runner.py` | `[ ]` | 可选注入 publisher 实例 |

---

## 16. 错误处理

| 编号 | 任务 | 文件 | 状态 | 说明 |
|------|------|------|------|------|
| ERR-001 | EngineError 统一异常基类 | `apirun/errors.py` | `[x]` | code + message + detail |
| ERR-002 | 引擎级错误码常量 | `apirun/errors.py` | `[x]` | FILE_NOT_FOUND / YAML_PARSE_ERROR / YAML_VALIDATION_ERROR / CSV_* / ENGINE_INTERNAL_ERROR / TIMEOUT_ERROR |
| ERR-003 | 步骤级错误码常量 | `apirun/errors.py` | `[x]` | REQUEST_* / ASSERTION_FAILED / EXTRACT_FAILED / DB_* / KEYWORD_* / VARIABLE_* |
| ERR-004 | 引擎级错误: 立即终止, status=error | `runner.py` | `[ ]` | |
| ERR-005 | 步骤级错误: 记录并继续, status=error | `runner.py` | `[ ]` | |
| ERR-006 | 断言失败: 记录并继续, status=failed | `runner.py` | `[ ]` | |
| ERR-007 | 提取失败: 使用 default 或记录失败 | `extractor.py` | `[ ]` | |

---

## 17. 单元测试 (`tests/unit/`)

| 编号 | 任务 | 文件 | 状态 | 说明 |
|------|------|------|------|------|
| TST-001 | test_models: RequestStepParams 默认值 | `test_models.py` | `[x]` | |
| TST-002 | test_models: Config 最少必填字段 | `test_models.py` | `[x]` | |
| TST-003 | test_models: CaseModel 最小解析 | `test_models.py` | `[x]` | |
| TST-004 | test_models: 五种 keyword_type 支持 | `test_models.py` | `[x]` | |
| TST-005 | test_models: 全类型 dict 解析 | `test_models.py` | `[x]` | |
| TST-006 | test_models: load_case 文件不存在 | `test_models.py` | `[x]` | |
| TST-007 | test_models: load_case 无效 YAML | `test_models.py` | `[x]` | |
| TST-008 | test_models: load_case 缺少 config | `test_models.py` | `[x]` | |
| TST-009 | test_variables: random 长度+字符集 | `test_variables.py` | `[x]` | |
| TST-010 | test_variables: random_uuid 格式 | `test_variables.py` | `[x]` | |
| TST-011 | test_variables: timestamp 单调递增 | `test_variables.py` | `[x]` | |
| TST-012 | test_variables: timestamp_ms 单调递增 | `test_variables.py` | `[x]` | |
| TST-013 | test_variables: datetime 格式 | `test_variables.py` | `[x]` | |
| TST-014 | test_variables: render_template 简单字符串 | `test_variables.py` | `[x]` | |
| TST-015 | test_variables: render_template 完整表达式保持类型 | `test_variables.py` | `[x]` | |
| TST-016 | test_variables: render_template 嵌套 dict/list | `test_variables.py` | `[x]` | |
| TST-017 | test_variables: render_template 内置函数 random | `test_variables.py` | `[x]` | |
| TST-018 | test_request_executor: URL 变量渲染 + base_url 拼接 | `test_request_executor.py` | `[x]` | |
| TST-019 | test_runner: 顶层字段完整性 | `test_runner.py` | `[x]` | |
| TST-020 | test_runner: summary 字段完整性 | `test_runner.py` | `[x]` | |
| TST-021 | test_runner: steps 必填字段 | `test_runner.py` | `[x]` | |
| TST-022 | test_runner: JSON 可序列化 | `test_runner.py` | `[x]` | |
| TST-023 | test_yaml_cases: full_step_types.yaml 解析 | `test_yaml_cases.py` | `[x]` | |
| TST-024 | test_output_models: ExecutionResult 模型 | `test_output_models.py` | `[x]` | |
| TST-025 | test_comparators: 17 种比较器 | `test_comparators.py` | `[x]` | |
| TST-026 | test_validator: 6 种 target | `test_validator.py` | `[x]` | |
| TST-027 | test_extractor: json/header/cookie 提取 | `test_extractor.py` | `[x]` | |
| TST-028 | test_db_executor: MySQL/PostgreSQL 执行 | `test_db_executor.py` | `[x]` | |
| TST-029 | test_custom_executor: 自定义关键字 | `test_custom_executor.py` | `[ ]` | |
| TST-030 | test_data_driven: YAML 内联驱动 | `test_data_driven.py` | `[x]` | |
| TST-031 | test_data_driven: CSV 文件驱动 | `test_data_driven.py` | `[x]` | get_parameter_sets 覆盖 csv_file |
| TST-032 | test_csv_parser: CSV 解析 | `test_csv_parser.py` | `[x]` | |
| TST-033 | test_yaml_parser: 统一解析器 | `test_yaml_parser.py` | `[x]` | |
| TST-034 | test_text_reporter: rich 输出 | `test_text_reporter.py` | `[ ]` | |
| TST-035 | test_runner_integration: 完整场景端到端 | `test_runner_integration.py` | `[ ]` | |

---

## 18. YAML 测试用例 (`tests/yaml/`)

| 编号 | 任务 | 文件 | 状态 | 说明 |
|------|------|------|------|------|
| YML-001 | full_step_types.yaml | `full_step_types.yaml` | `[x]` | 覆盖 request/assertion/extract/db/custom 五种步骤 |
| YML-002 | simple_get.yaml | `simple_get.yaml` | `[ ]` | 最简 GET 请求 + status_code 断言 |
| YML-003 | multi_step_e2e.yaml | `multi_step_e2e.yaml` | `[ ]` | 注册→登录→查看信息→数据库验证 |
| YML-004 | data_driven_inline.yaml | `data_driven_inline.yaml` | `[ ]` | ddts 内联数据驱动 |
| YML-005 | data_driven_csv.yaml + data.csv | `data_driven_csv.yaml` | `[ ]` | CSV 文件数据驱动 |
| YML-006 | variable_extraction.yaml | `variable_extraction.yaml` | `[ ]` | 变量提取 + 跨步骤引用 |
| YML-007 | all_comparators.yaml | `all_comparators.yaml` | `[ ]` | 17 种比较器断言覆盖 |
| YML-008 | error_cases.yaml | `error_cases.yaml` | `[ ]` | 触发各种错误码场景 |
| YML-009 | pre_post_sql.yaml | `pre_post_sql.yaml` | `[ ]` | 前置/后置 SQL |

---

## 19. 发布准备

| 编号 | 任务 | 状态 | 说明 |
|------|------|------|------|
| PUB-001 | CHANGELOG.md 维护 | `[ ]` | 记录版本变更 |
| PUB-002 | pypi_publish.sh 发布脚本 | `[~]` | 脚本已存在，待验证流程 |
| PUB-003 | version 管理 (0.1.0 → 1.0.0) | `[ ]` | pyproject.toml + `__init__.py` |
| PUB-004 | LICENSE 文件 | `[ ]` | MIT |
| PUB-005 | examples/ 示例用例 | `[ ]` | 至少 3 个可独立运行的示例 |

---

## 进度统计

| 模块 | 总任务 | 已完成 | 进行中 | 待开发 | 完成率 |
|------|--------|--------|--------|--------|--------|
| 1. 基础设施 | 7 | 7 | 0 | 0 | 100% |
| 2. YAML 输入模型 | 16 | 14 | 0 | 2 | 88% |
| 3. JSON 输出模型 | 14 | 0 | 0 | 14 | 0% |
| 4. YAML 解析器 | 9 | 0 | 0 | 9 | 0% |
| 5. 变量系统 | 17 | 14 | 0 | 3 | 82% |
| 6. HTTP 请求执行器 | 18 | 17 | 0 | 1 | 94% |
| 7. 断言验证引擎 | 27 | 0 | 0 | 27 | 0% |
| 8. 变量提取器 | 10 | 0 | 0 | 10 | 0% |
| 9. 数据库执行器 | 11 | 0 | 0 | 11 | 0% |
| 10. 自定义关键字执行器 | 7 | 0 | 0 | 7 | 0% |
| 11. 场景运行器 | 21 | 7 | 1 | 13 | 33% |
| 12. 数据驱动 | 8 | 0 | 0 | 8 | 0% |
| 13. 结果收集器 | 12 | 1 | 2 | 9 | 8% |
| 14. CLI | 15 | 10 | 0 | 5 | 67% |
| 15. WebSocket | 4 | 0 | 0 | 4 | 0% |
| 16. 错误处理 | 7 | 0 | 0 | 7 | 0% |
| 17. 单元测试 | 35 | 23 | 0 | 12 | 66% |
| 18. YAML 测试用例 | 9 | 1 | 0 | 8 | 11% |
| 19. 发布准备 | 5 | 0 | 1 | 4 | 0% |
| **合计** | **252** | **94** | **4** | **154** | **37%** |

---

## 建议开发顺序 (P0 → P2)

### P0 — 核心执行链路（必须优先完成，引擎最小可用）

1. `ERR-001~003` → 统一异常与错误码
2. `OUT-001~014` → JSON 输出数据模型
3. `PAR-001~005` → YAML 解析器
4. `VLD-001~026` → 断言验证引擎（17 种 comparator + 6 种 target）
5. `EXT-001~009` → 变量提取器（json/header/cookie）
6. `VAR-010~011` → 变量池管理器
7. `RUN-008~017` → 场景运行器增强（5 种步骤 + 内联 extract/validate）
8. `RUN-027~028` → 运行器输出模型化
9. `RPT-001~004` → JSON 报告独立模块
10. `CLI-011, CLI-015` → CLI 集成 JSON 报告 + exit code 逻辑

### P1 — 完善功能（数据库/数据驱动/Text报告）

11. `DB-001~011` → 数据库执行器
12. `DDT-001~008` → 数据驱动
13. `PAR-006~008` → CSV 解析器
14. `RUN-018~023` → 前置/后置 SQL + 数据驱动集成
15. `RUN-024~026` → 日志收集
16. `RPT-005~007` → Text 报告 (rich)
17. `CLI-012` → CLI 集成 Text 报告
18. `CST-001~007` → 自定义关键字执行器
19. `VAR-009` → 全局参数函数调用

### P2 — 锦上添花（Allure/HTML/WebSocket/发布）

20. `RPT-008~010` → Allure 报告
21. `RPT-011~012` → HTML 报告
22. `CLI-013~014` → CLI 集成 Allure/HTML
23. `WS-001~004` → WebSocket 实时推送
24. `PUB-001~005` → 发布准备

---

> **文档结束** — sisyphus-api-engine 开发任务清单 v1.0
