# Sisyphus API Engine - 项目重构学习大纲与任务清单

> **文档说明**: 本文档是项目重构的总体规划，包含学习路径、任务清单和进度跟踪。
> **更新时间**: 2026-02-03
> **当前状态**: 进行中

---

## 📋 目录

- [学习路径规划](#学习路径规划)
- [任务清单](#任务清单)
- [工作流程规范](#工作流程规范)
- [进度跟踪](#进度跟踪)

---

## 🎯 学习路径规划

本项目采用**渐进式学习路径**，从核心基础到高级功能，共分为14个阶段。每个阶段都遵循"理解→Review→测试→文档"的完整循环。

### 学习路径总览图

```
第一阶段: 核心数据模型
    ↓
第二阶段: 配置管理
    ↓
第三阶段: 变量系统
    ↓
第四阶段: 解析器
    ↓
第五阶段: 执行器基础
    ↓
第六阶段: HTTP请求执行 ←─────┐
    ↓                          │
第七阶段: 验证系统              │
    ↓                          │
第八阶段: 变量提取              │ 依赖关系
    ↓                          │
第九阶段: 步骤执行类型          │
    ↓                          │
第十阶段: 测试用例执行          │
    ↓                          │
第十一阶段: 数据驱动测试 ───────┘
    ↓
第十二阶段: 结果收集和输出
    ↓
第十三阶段: 实用工具
    ↓
第十四阶段: 命令行接口
```

### 各阶段详细说明

#### **第一阶段: 核心数据模型** 📦

**学习目标**: 理解整个框架的数据结构基础

**涉及文件**:
- `apirun/core/models.py`

**核心概念**:
- `@dataclass` 装饰器使用
- `HttpMethod` 枚举类型
- `ProfileConfig` 环境配置模型
- `GlobalConfig` 全局配置模型
- `TestCase` 测试用例模型
- `TestStep` 测试步骤模型
- `ValidationRule` 验证规则模型
- `Extractor` 提取器模型
- `StepResult` / `TestCaseResult` 结果模型
- `PerformanceMetrics` 性能指标模型
- `ErrorInfo` 错误信息模型

**简单示例**:
```yaml
name: "测试用例示例"
steps:
  - name: "示例步骤"
    type: request
    url: "https://api.example.com/users"
```

**详细文档**: `docs/01_第一阶段_核心数据模型.md` (待创建)

---

#### **第二阶段: 配置管理** ⚙️

**学习目标**: 掌握多环境配置和全局配置管理

**涉及文件**:
- `apirun/core/global_config_manager.py`

**核心概念**:
- 全局配置文件 `.sisyphus/config.yaml`
- 配置优先级机制
- Profile 环境切换
- 配置继承和覆盖

**简单示例**:
```yaml
# .sisyphus/config.yaml
profiles:
  dev:
    base_url: "https://api.dev.com"
  prod:
    base_url: "https://api.prod.com"
```

**详细文档**: `docs/02_第二阶段_配置管理.md` (待创建)

---

#### **第三阶段: 变量系统** 🔧

**学习目标**: 理解变量作用域、模板渲染和条件求值

**涉及文件**:
- `apirun/core/variable_manager.py`
- `apirun/core/template_functions.py`
- `apirun/core/condition_evaluator.py`

**核心概念**:
- 变量作用域优先级
- Jinja2 模板语法（`${}` 分隔符）
- 内置模板函数（`random_string`, `uuid`, `now`, `base64_encode` 等）
- 条件表达式求值

**简单示例**:
```yaml
variables:
  username: "${random_string(8)}"
  timestamp: "${now()}"

steps:
  - name: "使用变量"
    url: "${base_url}/users/${username}"
```

**详细文档**: `docs/03_第三阶段_变量系统.md` (待创建)

---

#### **第四阶段: 解析器** 📝

**学习目标**: 掌握 YAML 解析和验证

**涉及文件**:
- `apirun/parser/v2_yaml_parser.py`
- `apirun/validator/yaml_validator.py`

**核心概念**:
- YAML 语法解析
- `!include` 标签支持
- 多环境配置解析
- YAML 语法验证

**简单示例**:
```python
from apirun.parser.v2_yaml_parser import V2YamlParser

parser = V2YamlParser()
test_case = parser.parse("test.yaml")
```

**详细文档**: `docs/04_第四阶段_解析器.md` (待创建)

---

#### **第五阶段: 执行器基础** 🏗️

**学习目标**: 理解步骤执行基类和重试机制

**涉及文件**:
- `apirun/executor/step_executor.py`
- `apirun/core/retry.py`

**核心概念**:
- `StepExecutor` 抽象基类
- 重试策略（固定/指数/线性）
- 重试条件配置
- 错误分类和处理

**简单示例**:
```yaml
steps:
  - name: "带重试的步骤"
    type: request
    url: "${base_url}/api"
    retry_policy:
      max_attempts: 3
      strategy: exponential
```

**详细文档**: `docs/05_第五阶段_执行器基础.md` (待创建)

---

#### **第六阶段: HTTP请求执行** 🌐

**学习目标**: 掌握 HTTP/HTTPS 请求执行

**涉及文件**:
- `apirun/executor/api_executor.py`

**核心概念**:
- HTTP 方法支持（GET/POST/PUT/DELETE/PATCH/HEAD/OPTIONS）
- 请求参数配置（query/headers/body/json）
- 响应处理
- SSL 证书验证
- 超时配置

**简单示例**:
```yaml
steps:
  - name: "HTTP POST 请求"
    type: request
    method: POST
    url: "${base_url}/users"
    headers:
      Content-Type: "application/json"
    json:
      name: "张三"
      age: 25
```

**详细文档**: `docs/06_第六阶段_HTTP请求执行.md` (待创建)

---

#### **第七阶段: 验证系统** ✅

**学习目标**: 理解断言验证机制

**涉及文件**:
- `apirun/validation/` 目录
- `apirun/validation/engine.py`
- `apirun/validation/comparators.py`

**核心概念**:
- JSONPath 数据提取
- 比较器类型（eq/ne/gt/lt/contains/regex/type 等）
- 逻辑运算符（and/or/not）
- 自定义错误消息

**简单示例**:
```yaml
steps:
  - name: "验证响应"
    type: request
    url: "${base_url}/users/1"
    validations:
      - type: eq
        path: "$.code"
        expect: 200
        error_message: "状态码必须为200"
      - type: contains
        path: "$.data.name"
        expect: "张三"
```

**详细文档**: `docs/07_第七阶段_验证系统.md` (待创建)

---

#### **第八阶段: 变量提取** 📤

**学习目标**: 掌握从响应中提取变量

**涉及文件**:
- `apirun/extractor/` 目录
- `apirun/extractor/jsonpath_extractor.py`
- `apirun/extractor/regex_extractor.py`
- `apirun/extractor/header_extractor.py`
- `apirun/extractor/cookie_extractor.py`

**核心概念**:
- JSONPath 提取
- 正则表达式提取
- Header 提取
- Cookie 提取
- 默认值支持

**简单示例**:
```yaml
steps:
  - name: "提取用户ID"
    type: request
    url: "${base_url}/users"
    extractors:
      - type: jsonpath
        name: user_id
        path: "$.data[0].id"
        default: "0"
```

**详细文档**: `docs/08_第八阶段_变量提取.md` (待创建)

---

#### **第九阶段: 步骤执行类型** 🔄

**学习目标**: 掌握各种步骤类型执行

**涉及文件**:
- `apirun/executor/wait_executor.py`
- `apirun/executor/loop_executor.py`
- `apirun/executor/concurrent_executor.py`
- `apirun/executor/poll_executor.py`
- `apirun/executor/database_executor.py`
- `apirun/executor/script_executor.py`

**核心概念**:
- 等待机制（固定延迟/条件等待）
- 循环控制（for/while）
- 并发执行
- 轮询执行
- 数据库操作
- 脚本执行（Python/JavaScript）

**简单示例**:
```yaml
steps:
  - name: "等待条件满足"
    type: wait
    duration: 5
    condition: "${status} == 'ready'"

  - name: "循环执行"
    type: loop
    loop_type: for
    iterations: 3
    steps:
      - name: "重复请求"
        type: request
        url: "${base_url}/api"
```

**详细文档**: `docs/09_第九阶段_步骤执行类型.md` (待创建)

---

#### **第十阶段: 测试用例执行** 🎯

**学习目标**: 理解测试用例的整体执行流程

**涉及文件**:
- `apirun/executor/test_case_executor.py`
- `apirun/core/dependency_analyzer.py`

**核心概念**:
- 测试用例执行调度
- 步骤依赖分析
- 依赖拓扑排序
- 步骤控制（skip_if/only_if/depends_on）
- Setup/Teardown 钩子

**简单示例**:
```yaml
steps:
  - name: "登录获取token"
    type: request
    url: "${base_url}/login"
    extractors:
      - type: jsonpath
        name: token
        path: "$.data.token"

  - name: "使用token访问接口"
    type: request
    url: "${base_url}/user/profile"
    depends_on:
      - "登录获取token"
    headers:
      Authorization: "Bearer ${token}"
```

**详细文档**: `docs/10_第十阶段_测试用例执行.md` (待创建)

---

#### **第十一阶段: 数据驱动测试** 📊

**学习目标**: 掌握数据驱动测试

**涉及文件**:
- `apirun/data_driven/` 目录
- `apirun/data_driven/data_source.py`
- `apirun/data_driven/iterator.py`

**核心概念**:
- CSV 数据源
- JSON 数据源
- 数据库数据源
- 数据迭代器

**简单示例**:
```yaml
config:
  data_source:
    type: csv
    file_path: "data/users.csv"
  variable_prefix: "user"

steps:
  - name: "使用数据变量"
    type: request
    url: "${base_url}/users/${user.username}"
```

**详细文档**: `docs/11_第十一阶段_数据驱动测试.md` (待创建)

---

#### **第十二阶段: 结果收集和输出** 📈

**学习目标**: 理解测试结果收集和多格式输出

**涉及文件**:
- `apirun/result/` 目录
- `apirun/result/collector.py`
- `apirun/result/json_exporter.py`
- `apirun/result/html_exporter.py`
- `apirun/result/junit_exporter.py`
- `apirun/result/allure_exporter.py`

**核心概念**:
- 结果收集器
- JSON 格式输出
- HTML 报告生成
- JUnit XML 报告
- Allure 报告集成

**简单示例**:
```bash
# 输出不同格式
sisyphus --cases test.yaml --format json -o result.json
sisyphus --cases test.yaml --format html -o report.html
sisyphus --cases test.yaml --allure
```

**详细文档**: `docs/12_第十二阶段_结果收集和输出.md` (待创建)

---

#### **第十三阶段: 实用工具** 🛠️

**学习目标**: 了解项目中的实用工具模块

**涉及文件**:
- `apirun/utils/` 目录

**核心概念**:
- 日志系统
- 控制台输出
- 性能监控
- 错误处理工具
- 模板工具
- 钩子系统

**详细文档**: `docs/13_第十三阶段_实用工具.md` (待创建)

---

#### **第十四阶段: 命令行接口** 💻

**学习目标**: 掌握命令行工具的使用

**涉及文件**:
- `apirun/cli.py`

**核心概念**:
- 命令行参数解析
- 中英文双语帮助
- 主命令 `sisyphus`
- 验证命令 `sisyphus-validate`

**简单示例**:
```bash
# 基本用法
sisyphus --cases test.yaml

# 指定环境
sisyphus --cases test.yaml --profile prod

# 详细输出
sisyphus --cases test.yaml -v

# 输出格式
sisyphus --cases test.yaml --format json -o result.json
```

**详细文档**: `docs/14_第十四阶段_命令行接口.md` (待创建)

---

## ✅ 任务清单

### 阶段一: 核心数据模型
- [ ] 代码review和中文注释
- [ ] 编写单元测试
- [ ] 创建YAML案例
- [ ] 更新详细文档

### 阶段二: 配置管理
- [ ] 代码review和中文注释
- [ ] 编写单元测试
- [ ] 创建YAML案例
- [ ] 更新详细文档

### 阶段三: 变量系统
- [ ] 代码review和中文注释
- [ ] 编写单元测试
- [ ] 创建YAML案例
- [ ] 更新详细文档

### 阶段四: 解析器
- [ ] 代码review和中文注释
- [ ] 编写单元测试
- [ ] 创建YAML案例
- [ ] 更新详细文档

### 阶段五: 执行器基础
- [ ] 代码review和中文注释
- [ ] 编写单元测试
- [ ] 创建YAML案例
- [ ] 更新详细文档

### 阶段六: HTTP请求执行
- [ ] 代码review和中文注释
- [ ] 编写单元测试
- [ ] 创建YAML案例
- [ ] 更新详细文档

### 阶段七: 验证系统
- [ ] 代码review和中文注释
- [ ] 编写单元测试
- [ ] 创建YAML案例
- [ ] 更新详细文档

### 阶段八: 变量提取
- [ ] 代码review和中文注释
- [ ] 编写单元测试
- [ ] 创建YAML案例
- [ ] 更新详细文档

### 阶段九: 步骤执行类型
- [ ] 代码review和中文注释
- [ ] 编写单元测试
- [ ] 创建YAML案例
- [ ] 更新详细文档

### 阶段十: 测试用例执行
- [ ] 代码review和中文注释
- [ ] 编写单元测试
- [ ] 创建YAML案例
- [ ] 更新详细文档

### 阶段十一: 数据驱动测试
- [ ] 代码review和中文注释
- [ ] 编写单元测试
- [ ] 创建YAML案例
- [ ] 更新详细文档

### 阶段十二: 结果收集和输出
- [ ] 代码review和中文注释
- [ ] 编写单元测试
- [ ] 创建YAML案例
- [ ] 更新详细文档

### 阶段十三: 实用工具
- [ ] 代码review和中文注释
- [ ] 编写单元测试
- [ ] 创建YAML案例

### 阶段十四: 命令行接口
- [ ] 代码review和中文注释
- [ ] 更新详细文档
- [ ] 更新 README.md
- [ ] 更新 CHANGELOG.md

### 清理工作
- [ ] 删除多余的测试文件
- [ ] 删除报告文件
- [ ] 删除问题记录文件
- [ ] 删除测试脚本

---

## 📋 工作流程规范

每个阶段都遵循以下**标准化工作流程**：

### 1. 代码 Review 和中文注释
- 仔细阅读代码，理解逻辑
- 将 Google 规范的英文注释改为中文
- 识别不合理的设计，提出质疑
- 确认后重写逻辑

### 2. 删除旧的测试文件
```bash
# 删除旧的单元测试（保留目录结构）
rm -rf tests/<module>/*.py
# 删除旧的 YAML 案例
rm -rf examples/<old_files>.yaml
```

### 3. 编写单元测试
- 根据重写后的代码，从零编写单元测试
- 使用 Google 规范的中文注释
- 充分考虑测试场景（正常、边界、异常）
- 目标覆盖率：80%+

### 4. 创建 YAML 案例
- 在 `examples/yaml/` 目录创建示例文件
- 文件命名格式：`<阶段编号>_<功能名称>.yaml`
- 覆盖所有关键字和使用场景

### 5. 自测
```bash
# 运行单元测试
pytest tests/<module>/ -v

# 运行 YAML 案例
sisyphus --cases examples/yaml/<test_case>.yaml
```

### 6. 更新详细文档
- 按照 `template_docs.md` 模板规范
- 创建或更新 `<阶段编号>_<功能名称>.md`
- 包含关键字表格、YAML 示例、组合用法

### 7. 更新其他文档
- 更新 `README.md`（引用路径要正确）
- 更新 `CHANGELOG.md`（记录变更）
- 更新 `pyproject.toml`（如需要）

### 8. 原子化提交
```bash
# 按改动点分批提交
git add apirun/<module>/models.py
git commit -m "refactor(core): 📝 将核心数据模型注释改为中文"

git add tests/core/test_models.py
git commit -m "test(core): ✅ 新增核心数据模型单元测试"

git add examples/yaml/01_核心数据模型.yaml
git commit -m "docs(examples): 📝 新增核心数据模型YAML示例"

git add docs/01_第一阶段_核心数据模型.md
git commit -m "docs: 📝 更新核心数据模型详细文档"
```

### 9. 更新任务清单
- 在本文档中标记任务为 `[已完成]`
- 更新进度跟踪表

---

## 📊 进度跟踪

### 整体进度
| 阶段 | 状态 | 完成度 | 备注 |
|-----|------|--------|------|
| 第一阶段: 核心数据模型 | ⏳ 待开始 | 0% | - |
| 第二阶段: 配置管理 | ⏳ 待开始 | 0% | - |
| 第三阶段: 变量系统 | ⏳ 待开始 | 0% | - |
| 第四阶段: 解析器 | ⏳ 待开始 | 0% | - |
| 第五阶段: 执行器基础 | ⏳ 待开始 | 0% | - |
| 第六阶段: HTTP请求执行 | ⏳ 待开始 | 0% | - |
| 第七阶段: 验证系统 | ⏳ 待开始 | 0% | - |
| 第八阶段: 变量提取 | ⏳ 待开始 | 0% | - |
| 第九阶段: 步骤执行类型 | ⏳ 待开始 | 0% | - |
| 第十阶段: 测试用例执行 | ⏳ 待开始 | 0% | - |
| 第十一阶段: 数据驱动测试 | ⏳ 待开始 | 0% | - |
| 第十二阶段: 结果收集和输出 | ⏳ 待开始 | 0% | - |
| 第十三阶段: 实用工具 | ⏳ 待开始 | 0% | - |
| 第十四阶段: 命令行接口 | ⏳ 待开始 | 0% | - |
| 清理工作 | ⏳ 待开始 | 0% | - |

### 提交记录
| 日期 | 阶段 | 提交内容 | 提交哈希 |
|------|------|----------|----------|
| - | - | - | - |

---

## 📚 参考文档

- [CLAUDE.md](../CLAUDE.md) - 项目概述和架构说明
- [API-Engine输入协议规范.md](./API-Engine输入协议规范.md) - YAML 语法规范
- [API-Engine输出协议规范.md](./API-Engine输出协议规范.md) - 输出格式规范
- [template_docs.md](./template_docs.md) - 文档模板规范

---

## 🎓 学习建议

1. **循序渐进**: 严格按照阶段顺序学习，不要跳过基础
2. **动手实践**: 每个阶段都要运行示例和测试
3. **理解优先**: 理解核心概念后再深入细节
4. **文档同步**: 代码和文档保持同步更新
5. **测试驱动**: 先写测试，再写代码

---

**文档维护**: 本文档随着项目进展持续更新，最后更新于 2026-02-03
