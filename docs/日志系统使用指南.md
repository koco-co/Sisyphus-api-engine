# 日志系统使用指南

Sisyphus API Engine 提供了增强的日志系统,支持多种日志级别、文件输出和详细的执行追踪。

## 功能特性

- ✅ **多种日志级别**: DEBUG, INFO, WARNING, ERROR, CRITICAL
- ✅ **彩色控制台输出**: 易于区分不同级别的日志
- ✅ **日志文件输出**: 支持将日志保存到文件
- ✅ **变量变更追踪**: 记录变量值的变更历史
- ✅ **性能指标记录**: 记录请求耗时等性能数据
- ✅ **结构化日志**: 便于解析和分析

## 命令行参数

### 基本使用

```bash
# 使用默认日志级别 (INFO)
sisyphus --cases test.yaml

# 设置日志级别为 DEBUG (最详细)
sisyphus --cases test.yaml --log-level debug

# 设置日志级别为 WARNING (只显示警告和错误)
sisyphus --cases test.yaml --log-level warning

# 保存日志到文件
sisyphus --cases test.yaml --log-file execution.log

# 组合使用: DEBUG 级别 + 日志文件
sisyphus --cases test.yaml --log-level debug --log-file debug.log
```

### 可用的日志级别

- `debug` - 最详细,包含所有调试信息
- `info` - 默认级别,显示常规信息
- `warning` - 只显示警告和错误
- `error` - 只显示错误信息

### 日志文件示例

```bash
# 生成详细日志
sisyphus --cases test.yaml --log-level debug --log-file test-debug.log

# 查看日志文件
cat test-debug.log

# 实时查看日志
tail -f test-debug.log
```

## YAML 配置

在 YAML 测试用例中也可以启用 verbose 模式:

```yaml
config:
  name: "测试配置"
  verbose: true  # 启用详细输出
  timeout: 30
```

## 日志输出示例

### INFO 级别输出

```
2026-02-02 16:33:09 - INFO - 📋 开始执行测试用例: examples/33_详细日志功能.yaml
2026-02-02 16:33:09 - INFO - 📄 日志文件: test-execution.log
```

### DEBUG 级别输出

DEBUG 级别包含更详细的信息:
- 每个步骤的详细输入输出
- 变量值的变更历史
- 验证失败时的详细对比
- 性能分析数据

示例:
```
2026-02-02 16:35:12 - DEBUG - 🚀 开始执行步骤: 测试1 (request)
2026-02-02 16:35:12 - DEBUG -    详情: {"url": "https://httpbin.org/get", ...}
2026-02-02 16:35:14 - DEBUG - ✨ 提取成功: response_url = https://httpbin.org/get?test_param=value1 (路径: $.url)
2026-02-02 16:35:14 - DEBUG - ✅ 步骤完成: 测试1 - 耗时: 1.234s
```

## 日志系统 API

如果你需要在自定义代码中使用日志系统:

```python
from apirun.utils.logger import get_logger, LogConfig

# 获取全局日志实例
logger = get_logger()

# 记录日志
logger.info("信息消息")
logger.warning("警告消息")
logger.error("错误消息")

# 记录步骤执行
logger.log_step_start("步骤名称", "request", url="http://example.com")
logger.log_step_end("步骤名称", "passed", 1.5)

# 记录变量变更
logger.log_variable_change("user_id", None, 12345, "extraction")

# 记录验证失败
logger.log_validation_failure("eq", "$.json.code", 200, 404, "Expected 200 but got 404")

# 记录性能指标
logger.log_performance_metrics("API 请求", {
    "total_time": 2.5,
    "dns_time": 0.1,
    "tcp_time": 0.2
})

# 导出变量历史
logger.export_history("variable-history.json")
```

## 配置选项

### LogConfig 参数

```python
from apirun.utils.logger import LogConfig, SisyphusLogger

config = LogConfig(
    level="DEBUG",                      # 日志级别
    log_file="execution.log",            # 日志文件路径
    console_output=True,                 # 是否输出到控制台
    include_timestamps=True,             # 是否包含时间戳
    include_variable_changes=True,       # 是否记录变量变更
    include_performance=True,            # 是否记录性能指标
    format_template=None                 # 自定义日志格式
)

logger = SisyphusLogger("my_logger", config)
```

## 使用场景

### 1. 调试测试用例

```bash
# 使用 DEBUG 级别查看详细信息
sisyphus --cases test.yaml --log-level debug
```

### 2. 保存执行日志

```bash
# 保存日志用于后续分析
sisyphus --cases test.yaml --log-file logs/test-$(date +%Y%m%d-%H%M%S).log
```

### 3. CI/CD 集成

```bash
# 在 CI 中只显示错误,但保存完整日志
sisyphus --cases test.yaml --log-level error --log-file ci.log
```

### 4. 性能分析

```bash
# 使用 DEBUG 级别查看性能指标
sisyphus --cases test.yaml --log-level debug --log-file performance.log
```

## 日志文件格式

日志文件包含:
- 时间戳
- 日志级别
- 日志消息
- 详细信息(根据级别)

示例:
```
2026-02-02 16:35:12 - sisyphus - INFO - 📋 开始执行测试用例: test.yaml
2026-02-02 16:35:12 - sisyphus - DEBUG - 🚀 开始执行步骤: 步骤1 (request)
2026-02-02 16:35:14 - sisyphus - DEBUG - ✅ 步骤完成: 步骤1 - 耗时: 1.234s
```

## 注意事项

1. **日志级别选择**:
   - 开发调试时使用 `debug`
   - 正常测试使用 `info` (默认)
   - 生产环境使用 `warning` 或 `error`

2. **性能影响**:
   - DEBUG 级别会产生大量日志,可能影响性能
   - 建议只在需要调试时使用 DEBUG

3. **日志文件大小**:
   - 长时间运行或大量测试会产生较大的日志文件
   - 建议定期清理或使用日志轮转

4. **敏感信息**:
   - 日志文件可能包含敏感数据(密码、Token等)
   - 注意日志文件的存储和访问权限

## 相关功能

- **变量追踪**: 配合日志系统查看变量变更历史
- **性能指标**: 查看详细的请求耗时数据
- **Allure 报告**: 结合日志和报告进行问题分析
