# Sisyphus API Engine - 提取器使用指南

**版本**: v2.0
**更新日期**: 2026-02-02
**适用框架**: Sisyphus API Engine v2.0+

---

## 目录

1. [概述](#概述)
2. [提取器基础](#提取器基础)
3. [JSONPath提取器](#jsonpath提取器)
4. [多值提取功能](#多值提取功能) ⭐ 新增
5. [条件提取功能](#条件提取功能) ⭐ 新增
6. [正则表达式提取器](#正则表达式提取器)
7. [HTTP Header提取器](#http-header提取器)
8. [Cookie提取器](#cookie提取器)
9. [默认值支持](#默认值支持)
10. [提取器最佳实践](#提取器最佳实践)
11. [常见问题](#常见问题)
12. [完整示例](#完整示例)

---

## 概述

提取器(Extractors)是 Sisyphus API Engine 的核心功能之一,用于从 HTTP 响应中提取数据并保存为变量,供后续步骤使用。

### 提取器的工作原理

1. **接收响应数据**: 从 HTTP 响应中获取 JSON 数据、Headers、Cookies 等
2. **应用提取规则**: 使用指定的提取器类型和表达式提取数据
3. **保存为变量**: 将提取的值保存为变量,供后续步骤引用

### 基本语法

```yaml
extractors:
  - type: <提取器类型>
    name: <变量名>
    path/expression: <提取表达式>
    default: <默认值>  # 可选
    description: <提取描述>
```

---

## 提取器基础

### 完整的提取规则结构

```yaml
extractors:
  - type: jsonpath                    # 提取器类型(必填)
    name: user_id                     # 变量名(必填)
    path: "$.data.user.id"            # 提取路径/表达式(必填)
    default: "anonymous"              # 默认值(可选)
    description: "提取用户ID"          # 提取描述(推荐)
```

### 字段说明

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `type` | string | ✅ | 提取器类型(jsonpath/regex/header/cookie) |
| `name` | string | ✅ | 变量名,提取后的值保存为此变量 |
| `path`/`expression` | string | ✅ | 提取路径或表达式(根据类型不同) |
| `default` | any | ❌ | 默认值,提取失败时返回此值 |
| `description` | string | ❌ | 提取描述,用于文档和调试 |

### 使用提取的变量

```yaml
# 在后续步骤中引用提取的变量
steps:
  - name: "使用提取的变量"
    type: request
    url: "${base_url}/users/${user_id}"  # 使用提取的user_id变量
    method: GET
```

---

## JSONPath提取器

JSONPath提取器是最常用和最强大的提取器,支持从 JSON 响应中提取任意数据。

### 基本语法

```yaml
extractors:
  - type: jsonpath
    name: <变量名>
    path: <JSONPath表达式>
    default: <默认值>  # 可选
```

### JSONPath基础语法

| 语法 | 说明 | 示例 |
|------|------|------|
| `$` | 根节点 | `$` |
| `.` | 子节点 | `$.data.user.id` |
| `[*]` | 通配符,匹配所有数组元素 | `$.items[*].name` |
| `[0]` | 数组索引 | `$.users[0]` |
| `[0:2]` | 数组切片 | `$.users[0:2]` |
| `..` | 递归搜索 | `$..user_id` |
| `[?(@.key > 10)]` | 过滤表达式 | `$.items[?(@.price > 100)]` |

### 基础示例

```yaml
# 提取根节点
- type: jsonpath
  name: root_data
  path: "$"

# 提取简单字段
- type: jsonpath
  name: username
  path: "$.data.user.name"
  description: "提取用户名"

# 提取数组元素
- type: jsonpath
  name: first_user
  path: "$.users[0]"
  description: "提取第一个用户"

# 提取数组最后一个元素
- type: jsonpath
  name: last_user
  path: "$.users[-1]"
  description: "提取最后一个用户"

# 提取数组切片(前3个元素)
- type: jsonpath
  name: top3_users
  path: "$.users[0:3]"
  description: "提取前3个用户"
```

### 高级示例

```yaml
# 提取所有数组元素的某个字段(返回数组)
- type: jsonpath
  name: all_usernames
  path: "$.users[*].name"
  description: "提取所有用户名"

# 递归搜索(在任意层级查找)
- type: jsonpath
  name: user_id
  path: "$..user_id"
  description: "递归查找user_id"

# 过滤数组
- type: jsonpath
  name: active_users
  path: "$.users[?(@.is_active == true)]"
  description: "提取激活的用户"

# 复杂嵌套路径
- type: jsonpath
  name: avatar_url
  path: "$.data.user.profile.avatar.url"
  description: "提取嵌套头像URL"
```

### JSONPath增强函数

Sisyphus 支持增强的 JSONPath 函数,用于数据处理。

#### 数组函数

```yaml
# 数组长度
- type: jsonpath
  name: user_count
  path: "$.users.length()"
  description: "用户总数"

# 数组求和
- type: jsonpath
  name: total_price
  path: "$.items[*].price.sum()"
  description: "价格总和"

# 数组平均值
- type: jsonpath
  name: avg_price
  path: "$.items[*].price.avg()"
  description: "平均价格"

# 数组最小值
- type: jsonpath
  name: min_price
  path: "$.items[*].price.min()"
  description: "最低价格"

# 数组最大值
- type: jsonpath
  name: max_price
  path: "$.items[*].price.max()"
  description: "最高价格"

# 数组第一个元素
- type: jsonpath
  name: first_item
  path: "$.items.first()"
  description: "第一个项目"

# 数组最后一个元素
- type: jsonpath
  name: last_item
  path: "$.items.last()"
  description: "最后一个项目"
```

#### 数组操作函数

```yaml
# 数组去重
- type: jsonpath
  name: unique_tags
  path: "$.items[*].tags.unique()"
  description: "去重的标签列表"

# 数组排序
- type: jsonpath
  name: sorted_items
  path: "$.items[*].price.sort()"
  description: "排序后的价格列表"

# 数组反转
- type: jsonpath
  name: reversed_items
  path: "$.items.reverse()"
  description: "反转的数组"

# 数组扁平化
- type: jsonpath
  name: all_values
  path: "$.data.items[*].values.flatten()"
  description: "扁平化的值列表"
```

#### 字符串函数

```yaml
# 转大写
- type: jsonpath
  name: upper_name
  path: "$.user.name.upper()"
  description: "大写用户名"

# 转小写
- type: jsonpath
  name: lower_email
  path: "$.user.email.lower()"
  description: "小写邮箱"

# 去除首尾空格
- type: jsonpath
  name: trimmed_text
  path: "$.message.trim()"
  description: "去除空格的消息"

# 字符串分割
- type: jsonpath
  name: name_parts
  path: "$.full_name.split(' ')"
  description: "姓名分割为数组"

# 数组连接为字符串
- type: jsonpath
  name: joined_tags
  path: "$.tags.join(', ')"
  description: "标签连接为逗号分隔的字符串"
```

#### 对象函数

```yaml
# 获取对象所有键
- type: jsonpath
  name: field_names
  path: "$.data.keys()"
  description: "对象的所有字段名"

# 获取对象所有值
- type: jsonpath
  name: field_values
  path: "$.data.values()"
  description: "对象的所有字段值"
```

#### 检查函数

```yaml
# 包含检查
- type: jsonpath
  name: has_python
  path: "$.tags.contains('python')"
  description: "检查是否包含Python标签"

# 前缀检查
- type: jsonpath
  name: is_https
  path: "$.url.starts_with('https://')"
  description: "检查URL是否使用HTTPS"

# 后缀检查
- type: jsonpath
  name: is_pdf
  path: "$.filename.ends_with('.pdf')"
  description: "检查是否为PDF文件"

# 正则匹配
- type: jsonpath
  name: is_valid_email
  path: "$.email.matches('^[a-z]+@[a-z]+\\.[a-z]+$')"
  description: "验证邮箱格式"
```

### 提取多个值

JSONPath提取器支持提取多个匹配值(当路径返回数组时):

```yaml
# 提取单个值(第一个匹配)
- type: jsonpath
  name: first_username
  path: "$.users[*].name"
  # index参数默认为0,提取第一个元素

# 提取所有值(返回数组)
- type: jsonpath
  name: all_usernames
  path: "$.users[*].name"
  # 当使用通配符[*]时,返回所有匹配值的数组
```

**重要提示**:
- 使用 `$.field[*].subfield` 会提取所有匹配的值作为数组
- 使用 `$.field[0].subfield` 只提取第一个匹配值
- 提取的数组可以在后续步骤中通过 `${variable_name}` 引用

---

## 多值提取功能 ⭐ 新增

多值提取功能允许你一次性提取所有匹配的值到数组中,而不是只提取单个值。

### 基本语法

```yaml
extractors:
  - type: jsonpath
    name: <变量名>
    path: <JSONPath表达式>
    extract_all: true  # 新增参数:提取所有匹配值
    default: <默认值>
    description: <提取描述>
```

### 使用场景

#### 1. 提取所有用户名

```yaml
extractors:
  - type: jsonpath
    name: all_names
    path: "$.data.users[*].name"
    extract_all: true
    description: "提取所有用户名到数组"
```

**响应数据**:
```json
{
  "data": {
    "users": [
      {"name": "Alice", "role": "admin"},
      {"name": "Bob", "role": "user"},
      {"name": "Charlie", "role": "user"}
    ]
  }
}
```

**提取结果**: `all_names = ["Alice", "Bob", "Charlie"]`

#### 2. 结合过滤器使用

```yaml
extractors:
  - type: jsonpath
    name: active_users
    path: "$.data.users[?(@.status == 'active')].name"
    extract_all: true
    description: "提取所有活跃用户的名称"
```

#### 3. 数组聚合函数

```yaml
extractors:
  # 计算数组长度
  - type: jsonpath
    name: user_count
    path: "$.data.users.length()"
    description: "用户数量"

  # 求和
  - type: jsonpath
    name: total_score
    path: "$.data.users[*].score.sum()"
    description: "总分"

  # 平均值
  - type: jsonpath
    name: avg_score
    path: "$.data.users[*].score.avg()"
    description: "平均分"

  # 最大值
  - type: jsonpath
    name: max_score
    path: "$.data.users[*].score.max()"
    description: "最高分"

  # 最小值
  - type: jsonpath
    name: min_score
    path: "$.data.users[*].score.min()"
    description: "最低分"
```

### 使用 index=-1 (向后兼容)

之前的实现方式仍然支持:

```yaml
extractors:
  - type: jsonpath
    name: all_names
    path: "$.data.users[*].name"
    index: -1  # 等同于 extract_all: true
    description: "提取所有用户名"
```

### extract_all vs index

| 参数 | 值 | 行为 | 适用场景 |
|------|-----|------|----------|
| `extract_all` | `true` | 提取所有匹配值为数组 | 语义化,推荐使用 |
| `extract_all` | `false`/未设置 | 使用 `index` 参数 | 默认行为 |
| `index` | `0`/未设置 | 提取第一个匹配值 | 默认行为 |
| `index` | `-1` | 提取所有匹配值为数组 | 向后兼容 |

### 空数组处理

当提取空数组时:
- 如果路径存在但数组为空,返回 `[]` (空列表)
- 如果路径不存在,使用默认值(如果提供)

```yaml
extractors:
  - type: jsonpath
    name: items
    path: "$.data.items[*].id"
    extract_all: true
    default: []  # 空数组时使用空列表
    description: "提取所有项目ID"
```

---

## 条件提取功能 ⭐ 新增

条件提取功能允许你根据条件判断是否提取变量,提供更灵活的数据提取能力。

### 基本语法

```yaml
extractors:
  - type: jsonpath
    name: <变量名>
    path: <JSONPath表达式>
    condition: <条件表达式>  # 新增:条件判断
    on_failure:              # 新增:失败处理
      use_default: <默认值>
    default: <默认值>
    description: <提取描述>
```

### 支持的条件操作符

#### 比较操作符

| 操作符 | 说明 | 示例 |
|--------|------|------|
| `==` | 等于 | `$.code == 200` |
| `!=` | 不等于 | `$.code != 404` |
| `>` | 大于 | `$.count > 0` |
| `<` | 小于 | `$.price < 100` |
| `>=` | 大于等于 | `$.score >= 60` |
| `<=` | 小于等于 | `$.score <= 100` |

#### 逻辑操作符

| 操作符 | 说明 | 示例 |
|--------|------|------|
| `and` | 与逻辑 | `$.code == 200 and $.success == true` |
| `or` | 或逻辑 | `$.code == 200 or $.code == 201` |
| `()` | 括号优先级 | `$.a == 1 and ($.b == 2 or $.c == 3)` |

#### 成员操作符

| 操作符 | 说明 | 示例 |
|--------|------|------|
| `in` | 包含于 | `$.tags in 'python'` |
| `not in` | 不包含于 | `$.tags not in 'java'` |
| `contains` | 包含 | `$.message contains 'success'` |

### 使用场景

#### 1. 条件满足时提取

```yaml
extractors:
  # 只有在 code == 200 时才提取 task_id
  - type: jsonpath
    name: task_id
    path: "$.json.data.id"
    condition: "$.json.code == 200"
    description: "code==200 时提取任务ID"
```

#### 2. 条件不满足时使用默认值

```yaml
extractors:
  # code != 1 时使用默认值
  - type: jsonpath
    name: task_id
    path: "$.json.data.id"
    condition: "$.json.code == 1"
    on_failure:
      use_default: "default-task-999"
    description: "code!=1 时使用默认值"
```

#### 3. 复杂条件组合

```yaml
extractors:
  # code==1 且 data存在时提取
  - type: jsonpath
    name: task_id
    path: "$.json.data.id"
    condition: "$.json.code == 1 and $.json.data != null"
    description: "code==1 且 data存在时提取"

  # code==1 或 data 存在时提取
  - type: jsonpath
    name: result
    path: "$.json.data.value"
    condition: "$.json.code == 1 or $.json.data != null"
    description: "code==1 或 data 存在时提取"

  # 使用括号改变优先级
  - type: jsonpath
    name: should_extract
    path: "$.json.data.value"
    condition: "$.json.code == 200 and ($.json.status == 'active' or $.json.status == 'pending')"
    description: "code==200 且 (status为active或pending) 时提取"
```

#### 4. 使用 in 操作符

```yaml
extractors:
  # 检查值是否在数组中
  - type: jsonpath
    name: is_admin
    path: "$.json.user.roles"
    condition: "$.json.user.roles in 'admin'"
    description: "admin 在角色数组中时提取"

  # 检查字符串是否包含关键词
  - type: jsonpath
    name: success_msg
    path: "$.json.message"
    condition: "$.json.message contains 'success'"
    description: "消息包含 success 时提取"
```

#### 5. 数组条件检查

```yaml
extractors:
  # 数组非空时提取
  - type: jsonpath
    name: first_item
    path: "$.json.items[0].name"
    condition: "$.json.items.length() > 0"
    description: "数组非空时提取第一个元素"

  # 计算数组长度
  - type: jsonpath
    name: item_count
    path: "$.json.items.length()"
    description: "计算项目数量"
```

### 条件提取的执行流程

1. **检查条件**: 评估 `condition` 表达式
2. **条件为真**: 正常提取数据
3. **条件为假**:
   - 如果有 `on_failure.use_default`,使用指定的默认值
   - 否则如果有 `default` 参数,使用默认值
   - 如果都没有,跳过提取并记录警告

### 类型推断

条件表达式会自动推断值的类型:
- `true` / `false` → 布尔值
- `null` → None
- `123` → 整数
- `-10` → 负数
- `3.14` → 浮点数
- `'text'` / `"text"` → 字符串

### 错误处理

```yaml
extractors:
  # 提供多重保护
  - type: jsonpath
    name: user_id
    path: "$.json.user.id"
    condition: "$.json.user != null"
    on_failure:
      use_default: "anonymous"  # 条件不满足时的默认值
    default: "unknown"            # 提取失败时的默认值
    description: "安全的用户ID提取"
```

---

## 正则表达式提取器

正则表达式提取器用于从文本中提取符合模式的数据。

### 基本语法

```yaml
extractors:
  - type: regex
    name: <变量名>
    expression: <正则表达式>
    default: <默认值>  # 可选
```

### 基础示例

```yaml
# 提取完整匹配
- type: regex
  name: full_match
  expression: "user_id=([0-9]+)"
  description: "提取用户ID"

# 使用命名组(Python语法)
- type: regex
  name: user_id
  expression: "user_id=(?P<id>[0-9]+)"
  description: "使用命名组提取"

# 提取多个组
# 注意: index参数控制返回哪个组
# index=0: 完整匹配
# index=1: 第一个组
# index=2: 第二个组
- type: regex
  name: email_domain
  expression: "([a-z]+)@([a-z]+\\.[a-z]+)"
  # index=2 返回第二个组(域名部分)
```

### 实用示例

```yaml
# 从HTML中提取链接
- type: regex
  name: first_link
  expression: "<a href=\"([^\"]+)\""
  description: "提取第一个链接"

# 从日志中提取时间戳
- type: regex
  name: timestamp
  expression: "\\[(\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2})\\]"
  description: "提取日志时间戳"

# 从JSON字符串中提取值
- type: regex
  name: token
  expression: "\"token\":\\s*\"([^\"]+)\""
  description: "提取token值"

# 从URL中提取ID
- type: regex
  name: resource_id
  expression: "/resources/([0-9a-f-]+)"
  description: "从URL提取资源ID"
```

### 正则表达式提示

1. **使用原始字符串**: 在YAML中注意转义反斜杠
```yaml
# ✅ 正确: 双反斜杠
expression: "^[a-z]+@[a-z]+\\.[a-z]+$"

# ❌ 错误: 单反斜杠会被YAML解析器移除
expression: "^[a-z]+@[a-z]+\.[a-z]+$"
```

2. **使用非贪婪匹配**:
```yaml
# ✅ 推荐: 非贪婪匹配
expression: "<div>(.*?)</div>"

# ❌ 可能匹配过多: 贪婪匹配
expression: "<div>(.*)</div>"
```

3. **使用捕获组提取特定部分**:
```yaml
# 从 "User: Alice (ID: 123)" 提取 "Alice"
expression: "User:\\s*([^\\s(]+)"
```

---

## HTTP Header提取器

Header提取器用于从HTTP响应头中提取数据。

### 基本语法

```yaml
extractors:
  - type: header
    name: <变量名>
    key: <Header名称>
    default: <默认值>  # 可选
```

### 示例

```yaml
# 提取Content-Type
- type: header
  name: content_type
  key: "Content-Type"
  description: "提取响应内容类型"

# 提取Authorization Token
- type: header
  name: auth_token
  key: "Authorization"
  description: "提取认证令牌"

# 提取自定义Header
- type: header
  name: request_id
  key: "X-Request-ID"
  description: "提取请求ID"

# 提取Location重定向地址
- type: header
  name: redirect_url
  key: "Location"
  description: "提取重定向URL"
```

**注意**:
- Header名称不区分大小写
- 如果Header不存在且未设置默认值,提取会失败

---

## Cookie提取器

Cookie提取器用于从HTTP响应的Cookies中提取数据。

### 基本语法

```yaml
extractors:
  - type: cookie
    name: <变量名>
    key: <Cookie名称>
    default: <默认值>  # 可选
```

### 示例

```yaml
# 提取Session ID
- type: cookie
  name: session_id
  key: "sessionid"
  description: "提取会话ID"

# 提取认证Token
- type: cookie
  name: auth_token
  key: "token"
  description: "提取认证令牌"

# 提取用户偏好设置
- type: cookie
  name: user_theme
  key: "theme"
  description: "提取用户主题设置"

# 提取CSRF Token
- type: cookie
  name: csrf_token
  key: "csrftoken"
  description: "提取CSRF令牌"
```

**注意**:
- Cookie名称区分大小写
- 如果Cookie不存在且未设置默认值,提取会失败

---

## 默认值支持

从 v2.0 开始,所有提取器都支持默认值。当提取失败时,返回默认值而不是抛出错误。

### 基本用法

```yaml
# JSONPath提取器使用默认值
- type: jsonpath
  name: user_id
  path: "$.data.user.id"
  default: "anonymous"
  description: "提取用户ID,不存在时使用匿名"

# 正则表达式提取器使用默认值
- type: regex
  name: phone
  expression: "1[3-9]\\d{9}"
  default: "00000000000"
  description: "提取手机号,不存在时使用默认值"

# Header提取器使用默认值
- type: header
  name: rate_limit
  key: "X-RateLimit-Remaining"
  default: "100"
  description: "提取剩余请求次数"

# Cookie提取器使用默认值
- type: cookie
  name: session_id
  key: "sessionid"
  default: None
  description: "提取会话ID,不存在时为None"
```

### 默认值使用场景

#### 1. 可选字段提取

```yaml
# 提取可选的用户昵称
- type: jsonpath
  name: nickname
  path: "$.data.user.nickname"
  default: "用户"
  description: "提取昵称,不存在时使用默认值"
```

#### 2. 防止提取失败中断测试

```yaml
# 提取可能不存在的分页信息
- type: jsonpath
  name: next_page
  path: "$.pagination.next"
  default: null
  description: "提取下一页链接"

# 后续可以根据next_page是否存在决定是否继续
```

#### 3. 提供后备数据

```yaml
# 提取API版本,不存在时使用v1
- type: header
  name: api_version
  key: "X-API-Version"
  default: "v1"
  description: "提取API版本,默认v1"
```

#### 4. 错误处理和降级

```yaml
# 尝试提取错误码,不存在则为0(成功)
- type: jsonpath
  name: error_code
  path: "$.error.code"
  default: 0
  description: "提取错误码,默认0表示成功"

# 后续可以根据error_code判断
```

### 默认值最佳实践

**推荐使用默认值的场景**:
1. 可选字段,提取失败不影响测试
2. 需要降级处理的场景
3. 探索性测试,字段可能不存在
4. 多环境测试,字段在不同环境可能不同

**不推荐使用默认值的场景**:
1. 关键业务数据,提取失败应该中断测试
2. 必填字段验证
3. 数据一致性检查

---

## 提取器最佳实践

### 1. 命名规范

**变量命名建议**:
```yaml
# ✅ 推荐: 描述性命名
- name: user_id
- name: auth_token
- name: total_price

# ✅ 推荐: 使用下划线分隔
- name: first_name
- name: last_login_time

# ❌ 不推荐: 过于简单
- name: id
- name: value
- name: data

# ❌ 不推荐: 使用驼峰命名
- name: userId
- name: authToken
```

### 2. 描述性注释

```yaml
# ✅ 推荐: 清晰的描述
- type: jsonpath
  name: user_id
  path: "$.data.user.id"
  description: "从用户响应中提取用户ID,用于后续删除操作"

# ❌ 不推荐: 无描述或描述简单
- type: jsonpath
  name: user_id
  path: "$.data.user.id"
  description: "提取ID"
```

### 3. 提取器选择

**根据数据类型选择提取器**:

| 数据类型 | 推荐提取器 | 示例 |
|---------|-----------|------|
| JSON响应体 | jsonpath | `$.data.user.id` |
| 结构化文本 | regex | `"user_id=([0-9]+)"` |
| HTTP Headers | header | `Authorization` |
| Cookies | cookie | `sessionid` |

### 4. 提取顺序

建议按以下顺序提取变量:

```yaml
extractors:
  # 1. 先提取关键标识符(ID、Token等)
  - type: jsonpath
    name: user_id
    path: "$.data.user.id"

  # 2. 再提取业务数据
  - type: jsonpath
    name: username
    path: "$.data.user.name"

  # 3. 然后提取元数据(时间戳、分页信息等)
  - type: jsonpath
    name: created_at
    path: "$.data.user.created_at"

  # 4. 最后提取可选字段
  - type: jsonpath
    name: avatar_url
    path: "$.data.user.avatar_url"
    default: ""
```

### 5. 提取器与验证器配合

```yaml
# 先验证数据存在,再提取
validations:
  - type: exists
    path: "$.data.user.id"
    expect: true

extractors:
  # 验证通过后再提取
  - type: jsonpath
    name: user_id
    path: "$.data.user.id"
```

### 6. 错误处理策略

**策略1: 使用默认值**
```yaml
- type: jsonpath
  name: discount
  path: "$.data.discount"
  default: 0  # 无折扣时默认0
```

**策略2: 让提取失败中断测试**
```yaml
# 不设置default,提取失败会报错
- type: jsonpath
  name: user_id
  path: "$.data.user.id"
  # 关键数据,不存在应该中断测试
```

**策略3: 条件提取**
```yaml
# 先检查字段存在性
- type: jsonpath
  name: has_field
  path: "$.data.optional_field.exists()"

# 根据存在性决定是否使用
```

---

## 常见问题

### Q1: 提取的变量为什么是null?

**A**: 检查以下几点:
1. JSONPath路径是否正确(区分大小写)
2. 字段是否真的存在于响应中
3. 数组索引是否超出范围
4. 是否需要使用递归搜索 `..`

```bash
# 使用 -v 参数查看完整响应
sisyphus --cases test.yaml -v
```

### Q2: 如何提取数组中的所有值?

**A**: 使用通配符 `[*]`:
```yaml
# 提取所有用户名(返回数组)
- type: jsonpath
  name: all_usernames
  path: "$.users[*].name"

# 后续使用
steps:
  - name: "打印所有用户名"
    type: script
    script: |
      print("${all_usernames}")  # 会打印: ["Alice", "Bob", "Charlie"]
```

### Q3: 正则表达式提取不到数据?

**A**: 检查:
1. 正则表达式语法是否正确
2. 注意YAML中的转义(双反斜杠)
3. 测试响应是否为文本格式(JSON会自动转换为字符串)

```yaml
# ✅ 正确
expression: "user_id=([0-9]+)"

# ❌ 错误
expression: "user_id=([0-9]+)"  # 单反斜杠
```

### Q4: 如何提取嵌套在多个对象中的数据?

**A**: 使用递归搜索 `..`:
```yaml
# 在任意层级查找user_id
- type: jsonpath
  name: user_id
  path: "$..user_id"
  description: "递归查找user_id"

# 返回所有匹配的数组
- type: jsonpath
  name: all_ids
  path: "$..id"
  description: "递归查找所有id"
```

### Q5: Header/Cookie提取失败?

**A**: 检查:
1. Header/Cookie名称是否正确
2. 响应中是否真的包含该Header/Cookie
3. 使用 `-v` 查看完整响应数据

```yaml
# Header不区分大小写
- type: header
  name: auth
  key: "authorization"  # 或 "Authorization" 都可以

# Cookie区分大小写
- type: cookie
  name: session
  key: "sessionId"  # 必须完全匹配
```

### Q6: 如何处理提取的数组数据?

**A**:
```yaml
# 提取数组
- type: jsonpath
  name: items
  path: "$.data.items[*]"

# 在后续步骤中使用数组长度
steps:
  - name: "使用数组长度"
    type: request
    url: "${base_url}/count?total=${items.length()}"
```

### Q7: 默认值什么时候生效?

**A**: 在以下情况返回默认值:
1. JSONPath: 路径不存在或索引越界
2. Regex: 正则表达式不匹配
3. Header: Header不存在
4. Cookie: Cookie不存在

```yaml
# 路径不存在时返回默认值
- type: jsonpath
  name: nickname
  path: "$.data.user.nickname"
  default: "Guest"  # 字段不存在时返回"Guest"
```

### Q8: 如何从嵌套JSON中提取多个字段?

**A**: 使用多个提取器或路径表达式:
```yaml
# 方式1: 分别提取
- type: jsonpath
  name: username
  path: "$.data.user.name"
- type: jsonpath
  name: email
  path: "$.data.user.email"

# 方式2: 提取整个对象
- type: jsonpath
  name: user_info
  path: "$.data.user"
# 后续使用: ${user_info.name}, ${user_info.email}
```

---

## 进阶技巧

### 1. 提取后数据转换

使用JSONPath函数进行数据转换:

```yaml
# 提取并转换为大写
- type: jsonpath
  name: upper_name
  path: "$.user.name.upper()"

# 提取并计算
- type: jsonpath
  name: total
  path: "$.items[*].price.sum()"

# 提取并去重
- type: jsonpath
  name: unique_tags
  path: "$.items[*].tags.unique()"
```

### 2. 条件提取

先检查条件,再提取数据:

```yaml
# 检查字段存在
- type: jsonpath
  name: field_exists
  path: "$.data.optional_field.exists()"

# 后续根据field_exists决定是否使用
```

### 3. 提取器链式使用

在多个步骤中逐步提取:

```yaml
# 步骤1: 提取用户列表
- type: jsonpath
  name: user_list
  path: "$.data.users[*]"

# 步骤2: 提取第一个用户ID
- type: jsonpath
  name: first_user_id
  path: "${user_list}[0].id"

# 步骤3: 使用提取的ID
steps:
  - name: "获取用户详情"
    type: request
    url: "${base_url}/users/${first_user_id}"
```

### 4. 组合使用多种提取器

```yaml
# 从JSON提取Token
- type: jsonpath
  name: token
  path: "$.data.token"

# 从Header提取过期时间
- type: header
  name: expires
  key: "X-Token-Expires"

# 从Cookie提取会话ID
- type: cookie
  name: session_id
  key: "sessionid"
```

### 5. 调试提取器

使用变量引用查看提取的值:

```yaml
# 在后续步骤中打印提取的变量
steps:
  - name: "调试:打印提取的变量"
    type: script
    inline: |
      print(f"user_id: ${user_id}")
      print(f"username: ${username}")
      print(f"token: ${token}")
```

---

## 更多资源

### 示例文件

- `examples/26_增强功能测试.yaml` - 提取器默认值示例
- `examples/` - 更多测试用例示例

### 相关文档

- [API-Engine输入协议规范.md](API-Engine输入协议规范.md) - YAML测试用例完整语法
- [验证器使用指南.md](验证器使用指南.md) - 验证器完整指南
- [CLAUDE.md](../CLAUDE.md) - 项目开发指南

### 外部参考

- [JSONPath 语法](https://goessner.net/articles/JsonPath/)
- [Python 正则表达式](https://docs.python.org/3/library/re.html)
- [HTTP Headers 参考](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers)

---

**文档维护**: Sisyphus API Engine 团队
**最后更新**: 2026-02-02
**版本**: v2.0
