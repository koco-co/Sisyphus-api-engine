name: "异步轮询机制示例"
description: "演示如何使用轮询步骤等待异步操作完成"

config:
  profiles:
    dev:
      base_url: "https://httpbin.org"
      variables:
        test_id: "12345"

steps:
  # 示例 1: 轮询等待状态变为 ACTIVE
  - name: "模拟创建项目"
    type: request
    url: "https://httpbin.org/post"
    method: POST
    body:
      action: "create_project"
      project_name: "test_project"
      initial_status: "INITIALIZING"
    extractors:
      - type: jsonpath
        name: project_id
        path: "$.data.project_id"

  - name: "轮询等待项目就绪"
    type: poll
    url: "https://httpbin.org/post"
    method: POST
    body:
      action: "check_status"
      project_id: "${project_id}"
      # 模拟返回状态
      current_status: "ACTIVE"
    poll_config:
      condition:
        type: jsonpath
        path: "$.data.current_status"
        operator: "eq"
        expect: "ACTIVE"
      max_attempts: 3
      interval: 1000  # 每1秒轮询一次
      timeout: 10000  # 总超时10秒
      backoff: "fixed"  # 固定间隔
    on_timeout:
      behavior: "fail"
      message: "项目初始化超时"

  # 示例 2: 轮询等待数值条件满足
  - name: "轮询等待进度完成"
    type: poll
    url: "https://httpbin.org/post"
    method: POST
    body:
      action: "check_progress"
      progress: 100
    poll_config:
      condition:
        type: jsonpath
        path: "$.data.progress"
        operator: "ge"  # 大于等于
        expect: 100
      max_attempts: 5
      interval: 500
      timeout: 10000
      backoff: "exponential"  # 指数退避

  # 示例 3: 轮询等待特定状态码
  - name: "轮询等待服务可用"
    type: poll
    url: "https://httpbin.org/status/200"
    method: GET
    poll_config:
      condition:
        type: status_code
        operator: "eq"
        expect: 200
      max_attempts: 3
      interval: 2000
      timeout: 15000
      backoff: "linear"  # 线性增长
    on_timeout:
      behavior: "continue"
      message: "服务启动超时，跳过此步骤"

  # 示例 4: 轮询检查数组包含元素
  - name: "轮询等待结果列表"
    type: poll
    url: "https://httpbin.org/post"
    method: POST
    body:
      action: "get_results"
      results:
        - "item1"
        - "item2"
        - "target_item"
    poll_config:
      condition:
        type: jsonpath
        path: "$.data.results"
        operator: "contains"
        expect: "target_item"
      max_attempts: 3
      interval: 1000
      timeout: 8000
      backoff: "fixed"

  # 示例 5: 轮询等待字段存在
  - name: "轮询等待数据生成"
    type: poll
    url: "https://httpbin.org/post"
    method: POST
    body:
      action: "check_data"
      generated_data:
        id: "abc123"
        timestamp: "2024-01-01"
    poll_config:
      condition:
        type: jsonpath
        path: "$.data.generated_data.id"
        operator: "exists"
      max_attempts: 5
      interval: 1500
      timeout: 12000
      backoff: "fixed"

  # 示例 6: 轮询后验证结果
  - name: "验证轮询结果"
    type: request
    url: "https://httpbin.org/post"
    method: POST
    body:
      message: "轮询测试完成"
    validations:
      - type: eq
        path: "$.json.message"
        expect: "轮询测试完成"
