# ==============================================================================
# Sisyphus API Engine - 字符串验证器测试
# ==============================================================================
# 功能说明：演示字符串专用验证器的使用
# - not_contains: 不包含验证
# - starts_with: 前缀匹配
# - ends_with: 后缀匹配
# ==============================================================================

name: "字符串验证器测试"
description: "演示字符串专用验证器的使用（not_contains/starts_with/ends_with）"

config:
  name: "测试配置"
  timeout: 30
  retry_times: 0

  profiles:
    prod:
      base_url: "https://httpbin.org"

  active_profile: "prod"

# ============================================================================
# 测试步骤
# ============================================================================
steps:
  # ----------------------------------------------------------------------------
  # 步骤1: starts_with 比较器 - 前缀匹配
  # 用途：验证字符串以指定内容开头
  # 比较器类型：starts_with
  # 适用场景：验证URL协议、文件路径、编码前缀等
  # ----------------------------------------------------------------------------
  - name: "starts_with前缀匹配-URL协议"
    description: "验证URL以HTTPS协议开头"
    type: request
    method: GET
    url: "${config.profiles.prod.base_url}/get"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
      # 验证URL以https://开头
      - type: starts_with  # 比较器类型：前缀匹配
        path: "$.url"
        expect: "https://"  # 期望前缀
        description: "验证URL使用HTTPS协议"

  # ----------------------------------------------------------------------------
  # 步骤2: starts_with 比较器 - 路径前缀验证
  # 用途：验证文件路径或API路径以指定前缀开头
  # ----------------------------------------------------------------------------
  - name: "starts_with前缀匹配-路径验证"
    description: "验证API路径以指定前缀开头"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      api_path: "/api/v1/users"
      file_path: "/var/log/app.log"
      storage_path: "s3://bucket-name/file.txt"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
      # 验证API路径以/api开头
      - type: starts_with
        path: "$.json.api_path"
        expect: "/api/"
        description: "验证API路径版本"
      # 验证文件路径以/var开头
      - type: starts_with
        path: "$.json.file_path"
        expect: "/var/"
        description: "验证文件路径"
      # 验证存储路径以s3://开头
      - type: starts_with
        path: "$.json.storage_path"
        expect: "s3://"
        description: "验证S3存储路径"

  # ----------------------------------------------------------------------------
  # 步骤3: starts_with 比较器 - 编码和格式前缀
  # 用途：验证数据编码或格式标识
  # ----------------------------------------------------------------------------
  - name: "starts_with前缀匹配-编码格式"
    description: "验证数据以特定编码或格式标识开头"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      data_uri: "data:text/plain;base64,SGVsbG8="
      jwt_token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9."
      uuid: "550e8400-e29b-41d4-a716-446655440000"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
      # 验证Data URI以data:开头
      - type: starts_with
        path: "$.json.data_uri"
        expect: "data:"
        description: "验证Data URI格式"
      # 验证JWT以eyJ开头（Base64编码的JWT头部）
      - type: starts_with
        path: "$.json.jwt_token"
        expect: "eyJ"
        description: "验证JWT编码格式"
      # 验证UUID格式（虽然UUID不以固定前缀开头，但可以验证非空）
      - type: exists
        path: "$.json.uuid"
        expect: true
        description: "验证UUID存在"

  # ----------------------------------------------------------------------------
  # 步骤4: ends_with 比较器 - 后缀匹配
  # 用途：验证字符串以指定内容结尾
  # 比较器类型：ends_with
  # 适用场景：验证文件扩展名、域名、路径后缀等
  # ----------------------------------------------------------------------------
  - name: "ends_with后缀匹配-文件扩展名"
    description: "验证文件名以指定扩展名结尾"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      image_file: "avatar.png"
      document_file: "report.pdf"
      script_file: "app.js"
      config_file: "settings.json"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
      # 验证图片文件以.png结尾
      - type: ends_with  # 比较器类型：后缀匹配
        path: "$.json.image_file"
        expect: ".png"  # 期望后缀
        description: "验证图片文件格式为PNG"
      # 验证文档文件以.pdf结尾
      - type: ends_with
        path: "$.json.document_file"
        expect: ".pdf"
        description: "验证文档文件格式为PDF"
      # 验证脚本文件以.js结尾
      - type: ends_with
        path: "$.json.script_file"
        expect: ".js"
        description: "验证脚本文件为JavaScript"
      # 验证配置文件以.json结尾
      - type: ends_with
        path: "$.json.config_file"
        expect: ".json"
        description: "验证配置文件为JSON格式"

  # ----------------------------------------------------------------------------
  # 步骤5: ends_with 比较器 - 域名和URL后缀
  # 用途：验证域名或URL的后缀
  # ----------------------------------------------------------------------------
  - name: "ends_with后缀匹配-域名验证"
    description: "验证域名和URL的后缀"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      website: "https://www.example.com"
      api_url: "http://api.test.com"
      cdn_url: "https://cdn.example.org"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
      # 验证网站域名以.com结尾
      - type: ends_with
        path: "$.json.website"
        expect: ".com"
        description: "验证网站域名后缀"
      # 验证API域名以.com结尾
      - type: ends_with
        path: "$.json.api_url"
        expect: ".com"
        description: "验证API域名后缀"
      # 验证CDN域名以.org结尾
      - type: ends_with
        path: "$.json.cdn_url"
        expect: ".org"
        description: "验证CDN域名后缀"

  # ----------------------------------------------------------------------------
  # 步骤6: ends_with 比较器 - 路径和查询参数
  # 用途：验证URL路径或查询字符串的后缀
  # ----------------------------------------------------------------------------
  - name: "ends_with后缀匹配-URL路径"
    description: "验证URL路径以指定内容结尾"
    type: request
    method: GET
    url: "${config.profiles.prod.base_url}/get?param1=value1&param2=value2"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
      # 验证URL包含查询参数（以参数结尾）
      - type: ends_with
        path: "$.url"
        expect: "param2=value2"
        description: "验证URL以param2=value2结尾"

  # ----------------------------------------------------------------------------
  # 步骤7: not_contains 比较器 - 不包含验证
  # 用途：验证字符串不包含指定内容
  # 比较器类型：not_contains
  # 适用场景：验证黑名单词汇、敏感信息过滤、错误信息排除等
  # ----------------------------------------------------------------------------
  - name: "not_contains不包含验证-敏感词过滤"
    description: "验证响应中不包含敏感词汇"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      message: "用户操作成功完成"
      description: "API调用返回正常结果"
      error_msg: ""
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
      # 验证消息不包含敏感词"错误"
      - type: not_contains  # 比较器类型：不包含
        path: "$.json.message"
        expect: "错误"  # 不应包含的词汇
        description: "验证消息不包含'错误'"
      # 验证消息不包含敏感词"失败"
      - type: not_contains
        path: "$.json.message"
        expect: "失败"
        description: "验证消息不包含'失败'"
      # 验证描述不包含敏感词"异常"
      - type: not_contains
        path: "$.json.description"
        expect: "异常"
        description: "验证描述不包含'异常'"
      # 验证错误消息为空（不包含任何内容）
      - type: is_empty
        path: "$.json.error_msg"
        expect: true
        description: "验证没有错误消息"

  # ----------------------------------------------------------------------------
  # 步骤8: not_contains 比较器 - 黑名单验证
  # 用途：验证值不在黑名单中
  # ----------------------------------------------------------------------------
  - name: "not_contains不包含验证-黑名单检查"
    description: "验证用户名和内容不在黑名单中"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      username: "validuser123"
      content: "这是正常的内容文本"
      comments: "没有任何敏感信息"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
      # 验证用户名不包含黑名单关键词
      - type: not_contains
        path: "$.json.username"
        expect: "admin"
        description: "验证用户名不包含'admin'"
      - type: not_contains
        path: "$.json.username"
        expect: "root"
        description: "验证用户名不包含'root'"
      - type: not_contains
        path: "$.json.username"
        expect: "system"
        description: "验证用户名不包含'system'"
      # 验证内容不包含敏感词
      - type: not_contains
        path: "$.json.content"
        expect: "密码"
        description: "验证内容不包含'密码'"
      - type: not_contains
        path: "$.json.content"
        expect: "secret"
        description: "验证内容不包含'secret'"
      - type: not_contains
        path: "$.json.content"
        expect: "token"
        description: "验证内容不包含'token'"

  # ----------------------------------------------------------------------------
  # 步骤9: not_contains 比较器 - HTML标签验证
  # 用途：验证文本中不包含HTML标签（防止XSS攻击）
  # ----------------------------------------------------------------------------
  - name: "not_contains不包含验证-XSS防护"
    description: "验证响应不包含危险HTML标签"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      user_input: "普通用户输入内容"
      comment: "这是一段安全的文本"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
      # 验证用户输入不包含script标签
      - type: not_contains
        path: "$.json.user_input"
        expect: "<script>"
        description: "验证不包含script标签"
      # 验证用户输入不包含iframe标签
      - type: not_contains
        path: "$.json.user_input"
        expect: "<iframe>"
        description: "验证不包含iframe标签"
      # 验证评论不包含onclick事件
      - type: not_contains
        path: "$.json.comment"
        expect: "onclick"
        description: "验证不包含onclick事件"
      - type: not_contains
        path: "$.json.comment"
        expect: "javascript:"
        description: "验证不包含javascript:协议"

  # ----------------------------------------------------------------------------
  # 步骤10: 综合字符串验证示例
  # 用途：综合使用多种字符串验证器
  # ----------------------------------------------------------------------------
  - name: "综合字符串验证-文件上传验证"
    description: "综合使用starts_with/ends_with/not_contains验证文件上传"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      file:
        name: "document_v1.pdf"
        path: "/uploads/documents/document_v1.pdf"
        url: "https://cdn.example.com/files/document_v1.pdf"
        size: 2048576
        mime_type: "application/pdf"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"

      # 验证文件名以document开头
      - type: starts_with
        path: "$.json.file.name"
        expect: "document"
        description: "验证文件名前缀"

      # 验证文件名以.pdf结尾
      - type: ends_with
        path: "$.json.file.name"
        expect: ".pdf"
        description: "验证文件扩展名"

      # 验证文件路径以/uploads开头
      - type: starts_with
        path: "$.json.file.path"
        expect: "/uploads/"
        description: "验证上传目录路径"

      # 验证文件路径以.pdf结尾
      - type: ends_with
        path: "$.json.file.path"
        expect: ".pdf"
        description: "验证完整路径的文件扩展名"

      # 验证URL以https://开头
      - type: starts_with
        path: "$.json.file.url"
        expect: "https://"
        description: "验证使用HTTPS协议"

      # 验证URL不以.temp结尾（排除临时文件）
      - type: not_contains
        path: "$.json.file.url"
        expect: ".tmp"
        description: "验证不是临时文件"

      # 验证MIME类型为application/pdf
      - type: eq
        path: "$.json.file.mime_type"
        expect: "application/pdf"
        description: "验证MIME类型"

      # 验证文件大小大于1MB
      - type: gt
        path: "$.json.file.size"
        expect: 1048576
        description: "验证文件大小大于1MB"

  # ----------------------------------------------------------------------------
  # 步骤11: 字符串验证与正则表达式结合
  # 用途：展示字符串验证器与正则验证器的配合使用
  # ----------------------------------------------------------------------------
  - name: "字符串验证与正则表达式配合"
    description: "综合使用starts_with/ends_with/not_contains/regex验证"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      email: "user@example.com"
      phone: "+1-415-555-0132"
      id_card: "110101199001011234"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"

      # 使用starts_with进行简单前缀验证
      - type: starts_with
        path: "$.json.email"
        expect: "user@"
        description: "验证邮箱以user@开头"

      # 使用ends_with进行简单后缀验证
      - type: ends_with
        path: "$.json.email"
        expect: "@example.com"
        description: "验证邮箱域名为@example.com"

      # 使用not_contains排除错误格式
      - type: not_contains
        path: "$.json.phone"
        expect: " "
        description: "验证电话号码不包含空格"

      # 使用regex进行复杂格式验证
      - type: regex
        path: "$.json.email"
        expect: "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"
        description: "验证邮箱格式符合正则表达式"

      # 使用regex验证手机号格式
      - type: regex
        path: "$.json.phone"
        expect: "^\\+\\d{1,3}-\\d{3}-\\d{3}-\\d{4}$"
        description: "验证电话号码格式"

      # 使用not_contains验证身份证不包含常见错误字母（如O、o等）
      - type: not_contains
        path: "$.json.id_card"
        expect: "O"
        description: "验证身份证不包含字母O（容易与数字0混淆）"

      # 使用length_eq验证身份证长度
      - type: length_eq
        path: "$.json.id_card"
        expect: 18
        description: "验证身份证为18位"

  # ----------------------------------------------------------------------------
  # 步骤12: 字符串验证器在数据清理中的应用
  # 用途：验证数据清理和格式化结果
  # ----------------------------------------------------------------------------
  - name: "字符串验证-数据清理验证"
    description: "验证数据清理后的字符串格式"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      cleaned_data:
        username: "testuser_cleaned"
        email: "user@example.com"
        phone: "13800138000"
        url: "https://example.com/api/v1"
        file_path: "/var/log/application.log"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"

      # 验证清理后的用户名不包含特殊字符
      - type: not_contains
        path: "$.json.cleaned_data.username"
        expect: "@"
        description: "验证用户名不包含@符号"
      - type: not_contains
        path: "$.json.cleaned_data.username"
        expect: "."
        description: "验证用户名不包含点号"

      # 验证邮箱已清理（不包含+号）
      - type: not_contains
        path: "$.json.cleaned_data.email"
        expect: "+"
        description: "验证邮箱不包含+号"

      # 验证电话号码已清理（不包含短横线）
      - type: not_contains
        path: "$.json.cleaned_data.phone"
        expect: "-"
        description: "验证电话号码不包含短横线"

      # 验证URL已标准化（以https://开头）
      - type: starts_with
        path: "$.json.cleaned_data.url"
        expect: "https://"
        description: "验证URL使用HTTPS"

      # 验证文件路径以.log结尾
      - type: ends_with
        path: "$.json.cleaned_data.file_path"
        expect: ".log"
        description: "验证日志文件扩展名"

      # 验证清理后的数据不包含空格
      - type: not_contains
        path: "$.json.cleaned_data.username"
        expect: " "
        description: "验证用户名不包含空格"

# ============================================================================
# 标签（用于测试用例分类和过滤）
# ============================================================================
tags:
  - "基础"
  - "断言"
  - "验证"
  - "字符串"
  - "高级"

# 是否启用此测试用例（可选值: true/false）
enabled: true
