# ==============================================================================
# Sisyphus API Engine - 已发现功能验证测试
# =============================================================================
# 功能说明：验证任务清单中已发现但未标记的功能
# 1. skip_if / only_if 步骤控制
# 2. depends_on 依赖控制
# 3. 环境变量注入
# 4. 命令行参数传递
# =============================================================================

name: "已发现功能验证测试"
description: "验证框架已实现但任务清单未标记的功能"
# 注意：步骤数已更新为 7 个

config:
  name: "功能验证配置"
  timeout: 30
  retry_times: 0

  profiles:
    dev:
      base_url: "https://httpbin.org"
      # 环境变量前缀配置
      env_vars:
        prefix: "TEST_"

  active_profile: "dev"

  # 全局变量（可通过命令行参数覆盖）
  variables:
    test_mode: "normal"
    # feature_flag 应该是布尔值，用于 only_if
    feature_flag: true
    # is_production 用于 skip_if
    is_production: false

# ============================================================================
# 测试步骤
# ============================================================================
steps:
  # ----------------------------------------------------------------------------
  # 步骤1: 测试 only_if 功能
  # 功能：只有当条件为真时才执行步骤
  # 条件：${feature_flag} (直接引用布尔值)
  # 预期：此步骤应该执行（因为 feature_flag=true）
  # ----------------------------------------------------------------------------
  - name: "only_if功能测试-条件满足"
    description: "验证only_if在条件为真时执行步骤"
    type: request
    method: GET
    url: "${config.profiles.dev.base_url}/get"
    only_if: "${feature_flag}"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
        description: "验证HTTP状态码"

  # ----------------------------------------------------------------------------
  # 步骤2: 测试 only_if 功能 - 条件不满足
  # 功能：只有当条件为真时才执行步骤
  # 条件：${is_production} (值为 false)
  # 预期：此步骤应该跳过
  # ----------------------------------------------------------------------------
  - name: "only_if功能测试-条件不满足应跳过"
    description: "验证only_if在条件为假时跳过步骤"
    type: request
    method: GET
    url: "${config.profiles.dev.base_url}/get"
    only_if: "${is_production}"  # is_production=false，所以应该跳过
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
    # 注意：此步骤应该被跳过

  # ----------------------------------------------------------------------------
  # 步骤3: 测试 skip_if 功能
  # 功能：当条件为真时跳过步骤
  # 条件：${is_production}
  # 预期：此步骤应该执行（因为 is_production=false）
  # ----------------------------------------------------------------------------
  - name: "skip_if功能测试-条件不满足应执行"
    description: "验证skip_if在条件为假时执行步骤"
    type: request
    method: POST
    url: "${config.profiles.dev.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      message: "测试 skip_if 功能"
      mode: "${test_mode}"
    skip_if: "${is_production}"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
      - type: eq
        path: "$.json.mode"
        expect: "normal"
        description: "验证模式值"

  # ----------------------------------------------------------------------------
  # 步骤4: 测试 skip_if 功能 - 条件满足应跳过
  # 功能：当条件为真时跳过步骤
  # 条件：${feature_flag}
  # 预期：此步骤应该跳过（因为 feature_flag=true）
  # ----------------------------------------------------------------------------
  - name: "skip_if功能测试-条件满足应跳过"
    description: "验证skip_if在条件为真时跳过步骤"
    type: request
    method: POST
    url: "${config.profiles.dev.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      message: "此步骤应被跳过"
    skip_if: "${feature_flag}"  # feature_flag=true，所以应该跳过
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
    # 注意：此步骤应该被跳过

  # ----------------------------------------------------------------------------
  # 步骤5: 测试 depends_on 功能
  # 功能：依赖前面步骤成功执行
  # 预期：如果步骤1成功，此步骤才会执行
  # ----------------------------------------------------------------------------
  - name: "depends_on功能测试"
    description: "验证depends_on依赖控制功能"
    type: request
    method: POST
    url: "${config.profiles.dev.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      reference: "依赖步骤1的执行结果"
      status: "步骤1应该成功"
    depends_on:
      - "only_if功能测试-条件满足"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
      - type: eq
        path: "$.json.reference"
        expect: "依赖步骤1的执行结果"
        description: "验证依赖关系"

  # ----------------------------------------------------------------------------
  # 步骤6: 测试命令行参数覆盖
  # 功能：通过 --override 传递的变量会覆盖 YAML 中的值
  # 使用方式：
  #   sisyphus --cases examples/27_已发现功能验证.yaml --override test_mode=override_test
  # 预期：test_mode 变量值应为 "override_test"（如果通过命令行传递）
  # ----------------------------------------------------------------------------
  - name: "命令行参数测试"
    description: "验证命令行--override参数功能"
    type: request
    method: POST
    url: "${config.profiles.dev.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      mode: "${test_mode}"
      source: "command_line_override_test"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
      - type: eq
        path: "$.json.mode"
        expect: "normal"  # 默认值，通过 --override 可改为其他值
        description: "验证模式值（可通过命令行参数覆盖）"

  # ----------------------------------------------------------------------------
  # 步骤7: 测试环境变量使用
  # 功能：使用通过 --env-prefix 加载的环境变量
  # 使用方式：
  #   export TEST_API_KEY="test_key_123"
  #   sisyphus --cases examples/27_已发现功能验证.yaml --env-prefix TEST_
  # 注意：如果环境变量未设置，此测试可能会失败
  # ----------------------------------------------------------------------------
  - name: "环境变量测试"
    description: "验证环境变量注入功能"
    type: request
    method: POST
    url: "${config.profiles.dev.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      # 如果设置了 TEST_API_KEY 环境变量，它会被加载为 api_key 变量
      # 注意：环境变量名会被转为小写
      api_key: "${api_key if api_key else 'not_set'}"
      message: "环境变量测试"
    skip_if: "${api_key is not defined or api_key is none}"  # 如果环境变量未设置则跳过
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
      - type: ne
        path: "$.json.api_key"
        expect: "not_set"
        description: "验证环境变量已加载"

# ============================================================================
# 标签（用于测试用例分类和过滤）
# ============================================================================
tags:
  - "基础"
  - "功能验证"
  - "步骤控制"
  - "环境变量"
  - "命令行参数"

# 是否启用此测试用例（可选值: true/false）
enabled: true
