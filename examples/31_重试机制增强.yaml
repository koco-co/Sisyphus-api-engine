# ==============================================================================
# Sisyphus API Engine - 重试机制增强测试
# ==============================================================================
# 功能说明：演示增强的 retry_policy 配置
# =============================================================================

name: "重试机制增强测试"
description: "演示使用 retry_policy 配置各种重试策略"

config:
  name: "测试配置"
  timeout: 30
  retry_times: 0

  profiles:
    prod:
      base_url: "https://httpbin.org"

  active_profile: "prod"

steps:
  # ----------------------------------------------------------------------------
  # 测试1: 固定延迟重试策略 (fixed)
  # ----------------------------------------------------------------------------

  - name: "测试1: 固定延迟重试"
    description: "使用 fixed 策略,每次重试间隔相同"
    type: request
    method: GET
    url: "${config.profiles.prod.base_url}/status/500"  # 故意使用会失败的端点
    retry_policy:
      max_attempts: 3  # 最多重试3次
      strategy: fixed  # 固定延迟策略
      base_delay: 1.0  # 每次延迟1秒
      retry_on:
        - network  # 网络错误时重试
        - timeout  # 超时时重试
    validations:
      # 由于使用 500 状态码,这个验证会失败,但会触发重试
      - type: status_code
        path: "$.status_code"
        expect: "200"

  # ----------------------------------------------------------------------------
  # 测试2: 指数退避重试策略 (exponential)
  # ----------------------------------------------------------------------------

  - name: "测试2: 指数退避重试"
    description: "使用 exponential 策略,延迟时间指数增长"
    type: request
    method: GET
    url: "${config.profiles.prod.base_url}/delay/5"  # 延迟5秒的请求
    timeout: 2  # 设置2秒超时,会触发超时重试
    retry_policy:
      max_attempts: 2
      strategy: exponential  # 指数退避策略
      base_delay: 1.0
      max_delay: 10.0
      backoff_multiplier: 2.0  # 每次延迟翻倍
      jitter: true  # 添加随机抖动
      retry_on:
        - timeout  # 仅在超时时重试
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"

  # ----------------------------------------------------------------------------
  # 测试3: 线性增长重试策略 (linear)
  # ----------------------------------------------------------------------------

  - name: "测试3: 线性增长重试"
    description: "使用 linear 策略,延迟时间线性增长"
    type: request
    method: GET
    url: "${config.profiles.prod.base_url}/status/404"
    retry_policy:
      max_attempts: 2
      strategy: linear  # 线性增长策略
      base_delay: 1.0
      max_delay: 5.0
      retry_on:
        - network
        - timeout
      stop_on:
        - assertion  # 遇到断言错误停止重试
        - validation  # 遇到验证错误停止重试
    validations:
      # 404 会导致验证失败,但由于 stop_on 包含 validation,不会重试
      - type: status_code
        path: "$.status_code"
        expect: "200"

  # ----------------------------------------------------------------------------
  # 测试4: 成功案例 - 正常请求不需要重试
  # ----------------------------------------------------------------------------

  - name: "测试4: 正常请求(不触发重试)"
    description: "请求成功,不需要重试"
    type: request
    method: GET
    url: "${config.profiles.prod.base_url}/status/200"
    retry_policy:
      max_attempts: 3
      strategy: exponential
      base_delay: 1.0
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"

  # ----------------------------------------------------------------------------
  # 测试5: 使用 legacy retry_times (向后兼容)
  # ----------------------------------------------------------------------------

  - name: "测试5: 传统 retry_times"
    description: "使用简单的 retry_times 参数(向后兼容)"
    type: request
    method: GET
    url: "${config.profiles.prod.base_url}/status/200"
    retry_times: 2  # 传统方式:简单重试次数
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"

  # ----------------------------------------------------------------------------
  # 测试6: 复杂重试配置示例
  # ----------------------------------------------------------------------------

  - name: "测试6: 复杂重试配置"
    description: "演示完整重试配置的所有参数"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      test: "retry"
    retry_policy:
      max_attempts: 5  # 最多重试5次
      strategy: exponential
      base_delay: 0.5  # 基础延迟0.5秒
      max_delay: 30.0  # 最大延迟30秒
      backoff_multiplier: 2.0  # 延迟倍增因子
      jitter: true  # 启用抖动,避免惊群效应
      retry_on:  # 仅对以下错误类型重试
        - network
        - timeout
        - server_error  # 5xx 错误
      stop_on:  # 遇到以下错误立即停止重试
        - client_error  # 4xx 错误(通常重试无意义)
        - assertion
        - validation
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"

# ============================================================================
# 标签
# ============================================================================
tags:
  - "基础"
  - "重试"
  - "retry_policy"
  - "重试策略"
  - "指数退避"

enabled: true
