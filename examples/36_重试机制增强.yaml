# =============================================================================#
# Sisyphus API Engine - 重试机制增强测试
# =============================================================================#
# 功能说明：演示增强的重试机制配置和使用
# =============================================================================#

name: "重试机制增强测试"
description: "演示多种重试策略和配置选项"

config:
  name: "测试配置"
  timeout: 30
  retry_times: 0

  profiles:
    prod:
      base_url: "https://httpbin.org"

  active_profile: "prod"

steps:
  # ----------------------------------------------------------------------------
  # 测试1: 固定延迟重试策略
  # ----------------------------------------------------------------------------

  - name: "测试1: 固定延迟重试"
    description: "使用固定延迟的重试策略"
    type: request
    method: GET
    url: "https://httpbin.org/status/404"  # 故意返回 404
    retry_policy:
      max_attempts: 3
      strategy: fixed
      base_delay: 1.0
      max_delay: 5.0

  # ----------------------------------------------------------------------------
  # 测试2: 指数退避重试策略
  # ----------------------------------------------------------------------------

  - name: "测试2: 指数退避重试"
    description: "使用指数退避的重试策略（默认）"
    type: request
    method: GET
    url: "https://httpbin.org/status/404"
    retry_policy:
      max_attempts: 3
      strategy: exponential
      base_delay: 1.0
      backoff_multiplier: 2.0
      max_delay: 10.0

  # ----------------------------------------------------------------------------
  # 测试3: 线性递增重试策略
  # ----------------------------------------------------------------------------

  - name: "测试3: 线性递增重试"
    description: "使用线性递增延迟的重试策略"
    type: request
    method: GET
    url: "https://httpbin.org/status/404"
    retry_policy:
      max_attempts: 3
      strategy: linear
      base_delay: 1.0
      max_delay: 5.0

  # ----------------------------------------------------------------------------
  # 测试4: 带抖动的重试
  # ----------------------------------------------------------------------------

  - name: "测试4: 带抖动的重试"
    description: "在延迟中添加随机抖动，避免雷击效应"
    type: request
    method: GET
    url: "https://httpbin.org/status/404"
    retry_policy:
      max_attempts: 3
      strategy: exponential
      base_delay: 1.0
      jitter: true

  # ----------------------------------------------------------------------------
  # 测试5: 较少重试次数
  # ----------------------------------------------------------------------------

  - name: "测试5: 限制重试次数"
    description: "只重试1次，总共执行2次"
    type: request
    method: GET
    url: "https://httpbin.org/status/500"  # 服务器错误
    retry_policy:
      max_attempts: 1  # 只重试1次
      strategy: fixed
      base_delay: 0.5

  # ----------------------------------------------------------------------------
  # 测试6: 成功的请求（带重试配置但不触发）
  # ----------------------------------------------------------------------------

  - name: "测试6: 成功请求"
    description: "配置了重试但请求成功，不会触发重试"
    type: request
    method: GET
    url: "https://httpbin.org/get"
    retry_policy:
      max_attempts: 3
      strategy: fixed
      base_delay: 0.5
    extractors:
      - type: jsonpath
        name: response_url
        path: "$.url"
        description: "提取响应URL"

  # ----------------------------------------------------------------------------
  # 测试7: 验证重试历史记录
  # ----------------------------------------------------------------------------

  - name: "测试7: 验证重试配置"
    description: "验证前面的步骤配置了重试策略"
    type: script
    script: |
      # 检查上一个步骤的结果
      print("验证重试配置功能")
    capture_output: true

  # ----------------------------------------------------------------------------
  # 测试8: 遗留的 retry_times 参数（向后兼容）
  # ----------------------------------------------------------------------------

  - name: "测试8: 遗留 retry_times"
    description: "使用旧的 retry_times 参数（仍然支持）"
    type: request
    method: GET
    url: "https://httpbin.org/status/404"
    retry_times: 2

# ============================================================================
# 标签
# ============================================================================
tags:
  - "重试"
  - "retry"
  - "容错"
  - "网络"

enabled: true
