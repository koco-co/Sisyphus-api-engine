# ==============================================================================
# Sisyphus API Engine - 流程控制示例
# ==============================================================================
# 配套文档：docs/06_流程控制.md
# 功能说明：演示条件执行、步骤依赖、setup/teardown
# ==============================================================================

name: "流程控制示例"
description: "演示skip_if、only_if、depends_on等流程控制"

config:
  profiles:
    prod:
      base_url: "https://httpbin.org"
  active_profile: "prod"
  variables:
    run_optional_tests: true
    skip_cleanup: false

steps:
  # 基础步骤 - 其他步骤可能依赖此步骤
  - name: "初始化测试数据"
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      action: "init"
      test_id: "test_001"
    extractors:
      - name: test_id
        type: jsonpath
        path: "$.json.test_id"
      - name: init_success
        type: jsonpath
        path: "$.json.action"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"

  # 条件执行：only_if
  - name: "可选测试步骤"
    only_if: "${run_optional_tests} == true"
    method: GET
    url: "${config.profiles.prod.base_url}/get"
    params:
      optional: "true"
      test_id: "${test_id}"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"

  # 条件跳过：skip_if
  - name: "可跳过的清理步骤"
    skip_if: "${skip_cleanup} == true"
    method: DELETE
    url: "${config.profiles.prod.base_url}/delete"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"

  # 步骤依赖：depends_on
  - name: "依赖初始化的步骤"
    depends_on: ["初始化测试数据"]
    method: GET
    url: "${config.profiles.prod.base_url}/get"
    params:
      test_id: "${test_id}"
      depends: "初始化测试数据"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"

  # Setup/Teardown示例
  - name: "带前后置的主测试"
    setup:
      - name: "前置准备"
        method: POST
        url: "${config.profiles.prod.base_url}/post"
        body:
          setup: "prepare_data"
    teardown:
      - name: "后置清理"
        method: DELETE
        url: "${config.profiles.prod.base_url}/delete"
    method: GET
    url: "${config.profiles.prod.base_url}/get"
    params:
      main_test: "true"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"

tags:
  - "流程控制"
  - "条件执行"
enabled: true
