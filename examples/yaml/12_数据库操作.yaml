# ==============================================================================
# Sisyphus API Engine - 数据库操作示例
# ==============================================================================
# 配套文档：docs/12_数据库操作.md
# 功能说明：演示数据库查询和操作
# ==============================================================================

name: "数据库操作示例"
description: "演示MySQL/PostgreSQL/SQLite数据库操作"

config:
  profiles:
    prod:
      base_url: "https://httpbin.org"
  active_profile: "prod"
  
  # 数据库配置（实际使用时需配置真实数据库）
  # databases:
  #   test_db:
  #     type: sqlite
  #     database: "test.db"
  #   mysql_db:
  #     type: mysql
  #     host: "localhost"
  #     port: 3306
  #     database: "testdb"
  #     username: "root"
  #     password: "password"

steps:
  # 由于演示环境没有真实数据库，这里展示配置结构
  # 实际使用时替换为真实数据库操作
  
  # 模拟数据库操作流程
  - name: "模拟查询用户数据"
    description: "实际项目中替换为真实数据库查询"
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      operation: "query"
      sql: "SELECT * FROM users WHERE id = 1"
      result:
        id: 1
        username: "testuser"
        email: "test@example.com"
    extractors:
      - name: db_user_id
        type: jsonpath
        path: "$.json.result.id"
      - name: db_username
        type: jsonpath
        path: "$.json.result.username"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"

  # 使用数据库查询结果
  - name: "使用查询结果验证API"
    method: GET
    url: "${config.profiles.prod.base_url}/get"
    params:
      user_id: "${db_user_id}"
      username: "${db_username}"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: 200
      - type: eq
        path: "$.args.user_id"
        expect: "1"

tags:
  - "数据库"
  - "SQL"
enabled: true

# 实际数据库操作示例：
#
# - name: "查询用户"
#   type: database
#   database: "mysql_db"
#   operation: query
#   sql: "SELECT * FROM users WHERE status = 'active'"
#   extractors:
#     - name: user_count
#       path: "$[*]"
#       index: -1  # 返回所有结果
#
# - name: "插入数据"
#   type: database
#   database: "mysql_db"
#   operation: execute
#   sql: "INSERT INTO logs (action, user_id) VALUES ('login', ${user_id})"
#
# - name: "执行脚本"
#   type: database
#   database: "mysql_db"
#   operation: script
#   sql: |
#     UPDATE users SET last_login = NOW() WHERE id = ${user_id};
#     INSERT INTO audit_log (action) VALUES ('user_login');
