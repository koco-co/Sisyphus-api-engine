# ==============================================================================
# Sisyphus API Engine - 脚本执行示例
# ==============================================================================
# 配套文档：docs/11_脚本执行.md
# 功能说明：演示在测试中执行Python脚本
# ==============================================================================

name: "脚本执行示例"
description: "演示Python脚本执行和变量交互"

config:
  profiles:
    prod:
      base_url: "https://httpbin.org"
  active_profile: "prod"

steps:
  # 获取原始数据
  - name: "获取UUID"
    method: GET
    url: "${config.profiles.prod.base_url}/uuid"
    extractors:
      - name: raw_uuid
        type: jsonpath
        path: "$.uuid"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"

  # 使用脚本处理数据
  - name: "脚本处理数据"
    description: "使用Python脚本处理提取的数据"
    type: script
    script: |
      import hashlib
      import time
      
      # 获取前一步提取的变量
      uuid = get_var("raw_uuid")
      
      # 处理数据
      processed = uuid.replace("-", "").upper()
      signature = hashlib.md5(uuid.encode()).hexdigest()
      timestamp = str(int(time.time()))
      
      # 设置新变量供后续步骤使用
      set_var("processed_uuid", processed)
      set_var("signature", signature)
      set_var("timestamp", timestamp)
      
      # 输出日志
      print(f"原始UUID: {uuid}")
      print(f"处理后: {processed}")
      print(f"签名: {signature}")
    script_type: python
    allow_imports: true

  # 使用脚本处理后的变量
  - name: "使用脚本处理结果"
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
      X-Signature: "${signature}"
      X-Timestamp: "${timestamp}"
    body:
      original_uuid: "${raw_uuid}"
      processed_uuid: "${processed_uuid}"
      signature: "${signature}"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"

  # 简单脚本示例（无导入）
  - name: "简单计算脚本"
    type: script
    script: |
      # 简单数学计算
      a = 10
      b = 20
      result = a + b
      set_var("calc_result", str(result))
    script_type: python
    allow_imports: false

  - name: "验证计算结果"
    method: GET
    url: "${config.profiles.prod.base_url}/get"
    params:
      result: "${calc_result}"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
      - type: eq
        path: "$.args.result"
        expect: "30"

tags:
  - "脚本"
  - "Python"
enabled: true
