# ==============================================================================
# Sisyphus API Engine - 详细日志功能测试
# ==============================================================================
# 功能说明：演示详细的执行日志功能
# =============================================================================

name: "详细日志功能测试"
description: "演示使用详细的执行日志记录测试过程"

config:
  name: "测试配置"
  timeout: 30
  retry_times: 0
  verbose: true  # 启用详细输出

  profiles:
    prod:
      base_url: "https://httpbin.org"

  active_profile: "prod"

steps:
  # ----------------------------------------------------------------------------
  # 测试1: 基本请求 - 记录请求和响应详情
  # ----------------------------------------------------------------------------

  - name: "测试1: GET 请求"
    description: "演示基本的 GET 请求和日志记录"
    type: request
    method: GET
    url: "${config.profiles.prod.base_url}/get"
    params:
      test_param: "value1"
    headers:
      Custom-Header: "test-value"
    extractors:
      # 提取响应数据
      - type: jsonpath
        name: response_url
        path: "$.url"
        description: "提取请求 URL"

    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"

  # ----------------------------------------------------------------------------
  # 测试2: POST 请求 - 记录请求体
  # ----------------------------------------------------------------------------

  - name: "测试2: POST 请求"
    description: "演示 POST 请求的日志记录"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      username: "testuser"
      password: "testpass"
      metadata:
        source: "api-test"
        version: "1.0"
    extractors:
      - type: jsonpath
        name: json_data
        path: "$.json"
        description: "提取完整的 JSON 响应"

    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"

      - type: eq
        path: "$.json.username"
        expect: "testuser"
        description: "验证用户名"

  # ----------------------------------------------------------------------------
  # 测试3: 变量提取和使用 - 记录变量变更
  # ----------------------------------------------------------------------------

  - name: "测试3: 变量传递"
    description: "演示变量在步骤间传递"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      # 使用前面步骤提取的变量
      previous_url: "${response_url}"
      message: "Testing variable passing"
    extractors:
      - type: jsonpath
        name: new_data
        path: "$.json.data"
        description: "提取新数据"

    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"

  # ----------------------------------------------------------------------------
  # 测试4: 复杂验证 - 记录验证过程
  # ----------------------------------------------------------------------------

  - name: "测试4: 多重验证"
    description: "演示多个验证规则的日志记录"
    type: request
    method: GET
    url: "${config.profiles.prod.base_url}/headers"
    headers:
      User-Agent: "Sisyphus-Test/1.0"
      Accept: "application/json"

    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"

      - type: contains
        path: "$.headers"
        expect: "User-Agent"
        description: "验证包含 User-Agent"

      - type: contains
        path: "$.headers"
        expect: "Accept"
        description: "验证包含 Accept"

  # ----------------------------------------------------------------------------
  # 测试5: 条件提取 - 记录条件判断
  # ----------------------------------------------------------------------------

  - name: "测试5: 条件提取"
    description: "演示条件提取的日志记录"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      code: 200
      success: true
      data:
        id: "task-123"
        name: "Test Task"
    extractors:
      # 只有在 success == true 时提取
      - type: jsonpath
        name: task_id
        path: "$.json.data.id"
        condition: "$.json.success == true"
        description: "条件: success==true 时提取"

      # 无条件提取用于对比
      - type: jsonpath
        name: response_code
        path: "$.json.code"
        description: "无条件提取响应码"

    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"

# ============================================================================
# 标签
# ============================================================================
tags:
  - "基础"
  - "日志"
  - "logging"
  - "详细输出"
  - "变量追踪"

enabled: true
