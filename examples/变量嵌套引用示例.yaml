name: "变量嵌套引用示例"
description: "演示如何在顶层 variables 中嵌套引用 config.profiles.* 变量"

config:
  # 定义多个环境的配置
  profiles:
    dev:
      base_url: "http://dev.example.com"
      variables:
        test_suffix: "0202093000"
        env: "dev"
        timeout: 30

    ci_62:
      base_url: "http://ci62.example.com"
      variables:
        test_suffix: "TEST001"
        env: "ci"
        timeout: 60

    prod:
      base_url: "http://prod.example.com"
      variables:
        test_suffix: "PROD123"
        env: "production"
        timeout: 120

  active_profile: "dev"

  # ✨ 新功能: 支持在顶层 variables 中嵌套引用 config 变量
  variables:
    # 引用特定 profile 的变量
    category_name: "test_${config.profiles.dev.variables.test_suffix}"

    # 引用多个嵌套变量
    datasource_name: "ds_${config.profiles.dev.variables.test_suffix}"

    # 使用 active_profile 动态构建
    environment: "${config.active_profile}"

    # 复杂嵌套引用
    api_endpoint: "${config.profiles.dev.base_url}/api/v1"

    # 组合多个嵌套引用
    full_resource_name: "${config.active_profile}_${config.profiles.dev.variables.test_suffix}"

steps:
  - name: "验证变量渲染 - category_name"
    type: request
    url: "https://httpbin.org/post"
    method: POST
    body:
      message: "Category name is: ${category_name}"
      expected: "test_0202093000"
    validations:
      - type: eq
        path: "$.json.message"
        expect: "Category name is: test_0202093000"

  - name: "验证变量渲染 - datasource_name"
    type: request
    url: "https://httpbin.org/post"
    method: POST
    body:
      datasource: "${datasource_name}"
      expected: "ds_0202093000"
    validations:
      - type: eq
        path: "$.json.datasource"
        expect: "ds_0202093000"

  - name: "验证变量渲染 - environment"
    type: request
    url: "https://httpbin.org/post"
    method: POST
    body:
      env: "${environment}"
      expected: "dev"
    validations:
      - type: eq
        path: "$.json.env"
        expect: "dev"

  - name: "验证变量渲染 - api_endpoint"
    type: request
    url: "https://httpbin.org/post"
    method: POST
    body:
      endpoint: "${api_endpoint}"
      expected: "http://dev.example.com/api/v1"
    validations:
      - type: eq
        path: "$.json.endpoint"
        expect: "http://dev.example.com/api/v1"

  - name: "验证变量渲染 - full_resource_name"
    type: request
    url: "https://httpbin.org/post"
    method: POST
    body:
      resource: "${full_resource_name}"
      expected: "dev_0202093000"
    validations:
      - type: eq
        path: "$.json.resource"
        expect: "dev_0202093000"
