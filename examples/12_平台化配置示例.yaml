name: "平台化配置示例"
description: "演示测试平台所需的完整配置功能"

config:
  # === 环境配置 ===
  profiles:
    dev:
      base_url: "http://dev-api.example.com"
      timeout: 30
      verify_ssl: false
      variables:
        api_key: "dev-key-12345"
      # 环境覆盖配置（优先级高于默认值）
      overrides:
        timeout: 60  # 覆盖默认的 timeout=30
        retry_times: 3
      priority: 10  # 开发环境优先级较低

    test:
      base_url: "http://test-api.example.com"
      timeout: 20
      verify_ssl: true
      variables:
        api_key: "test-key-67890"
      overrides:
        timeout: 40
      priority: 50  # 测试环境中等优先级

    prod:
      base_url: "http://api.example.com"
      timeout: 10
      verify_ssl: true
      variables:
        api_key: "${API_KEY}"  # 从环境变量读取
      priority: 100  # 生产环境最高优先级

  active_profile: "dev"

  # === 全局变量 ===
  variables:
    app_version: "1.0.0"
    test_id: "TEST-${timestamp}"

  # === 调试模式配置 ===
  debug:
    enabled: true           # 启用调试模式
    variable_tracking: true  # 启用变量变化追踪
    show_request: true       # 显示请求详情
    show_response: true      # 显示响应详情
    log_level: "DEBUG"       # 日志级别

  # === 详细输出模式 ===
  verbose: true

  # === 环境变量配置 ===
  env_vars:
    prefix: "PLATFORM_"      # 环境变量前缀
    load_from_os: true       # 从 OS 环境变量加载
    overrides:              # 环境变量覆盖
      API_TIMEOUT: "60"
      MAX_RETRIES: "3"

  # === 输出控制配置 ===
  output:
    path: "./results/${test_id}_result.json"  # 支持变量替换
    format: "json"          # 输出格式
    include_request: true    # 包含请求详情
    include_response: true   # 包含响应详情
    include_performance: true # 包含性能指标
    include_variables: true  # 包含变量快照
    sensitive_data_mask: true # 敏感数据脱敏

  # === WebSocket 实时推送 ===
  websocket:
    enabled: true
    host: "0.0.0.0"
    port: 8765
    send_progress: true
    send_logs: true
    send_variables: true
    send_performance: true

  # === 超时和重试配置 ===
  timeout: 30
  retry_times: 2

# === 测试步骤 ===
steps:
  - name: "1. 健康检查"
    type: request
    method: GET
    url: "${base_url}/health"
    description: "检查服务健康状态"
    validations:
      - type: eq
        path: "$.status"
        expect: "ok"
        description: "验证服务正常"

  - name: "2. 获取用户信息"
    type: request
    method: GET
    url: "${base_url}/api/users/1"
    headers:
      Authorization: "Bearer ${api_key}"
    description: "测试获取用户信息接口"
    validations:
      - type: eq
        path: "$.id"
        expect: 1
        description: "验证用户ID"
      - type: eq
        path: "$.name"
        expect: "Test User"
        description: "验证用户名"
    extractors:
      - name: user_email
        type: jsonpath
        path: "$.email"
        description: "提取用户邮箱"

  - name: "3. 使用环境覆盖的配置"
    type: request
    method: GET
    url: "${base_url}/api/config"
    description: "验证环境覆盖配置生效（timeout应被覆盖为60）"
    # 这个步骤会使用 profile overrides 中的 timeout=60

  - name: "4. 测试变量追踪"
    type: request
    method: POST
    url: "${base_url}/api/data"
    body:
      user: "${user_email}"
      version: "${app_version}"
      test_id: "${test_id}"
    description: "测试变量追踪功能（在debug模式下会记录变量变化）"
    validations:
      - type: eq
        path: "$.status"
        expect: "success"

  - name: "5. 测试环境变量注入"
    type: request
    method: GET
    url: "${base_url}/api/timeout"
    description: "验证环境变量覆盖生效（API_TIMEOUT=60）"
    # 这个步骤会使用 env_vars overrides 中的配置

# === 说明 ===
# 1. 输出控制: output.path 会自动保存结果到 ./results/ 目录
# 2. 调试模式: debug.enabled=true 会启用变量追踪
# 3. 环境变量: env_vars.prefix="PLATFORM_" 会加载所有 PLATFORM_* 环境变量
# 4. 配置覆盖: profile.overrides 可以覆盖默认配置值
# 5. 优先级: prod 环境的 priority 最高（100），dev 最低（10）
#
# 运行方式:
#   sisyphus-api-engine --cases examples/12_平台化配置示例.yaml
#
# CLI 参数覆盖 YAML:
#   sisyphus-api-engine --cases examples/12_平台化配置示例.yaml --profile prod --debug
#   sisyphus-api-engine --cases examples/12_平台化配置示例.yaml --override timeout=90
#   sisyphus-api-engine --cases examples/12_平台化配置示例.yaml --output custom_result.json
