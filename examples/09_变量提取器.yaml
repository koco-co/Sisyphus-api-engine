# ==============================================================================
# Sisyphus API Engine - 变量提取器测试
# ==============================================================================
# 功能说明：演示从响应中提取变量并在后续步骤中使用
# - JSONPath提取器：从JSON响应中提取数据
# - Header提取器：从响应头中提取数据
# ==============================================================================

name: "变量提取器测试"
description: "演示从响应中提取变量并在后续步骤中使用"

config:
  name: "测试配置"
  timeout: 30
  retry_times: 0

  profiles:
    prod:
      base_url: "https://httpbin.org"

  active_profile: "prod"

# ============================================================================
# 测试步骤
# ============================================================================
steps:
  # ----------------------------------------------------------------------------
  # 步骤1: JSONPath提取器 - 基础字段提取
  # 用途：从JSON响应中提取简单字段
  # 提取器类型：jsonpath
  # 路径语法：$.field
  # ----------------------------------------------------------------------------
  - name: "JSONPath基础提取"
    description: "使用JSONPath提取JSON响应中的基础字段"
    type: request
    method: GET
    url: "${config.profiles.prod.base_url}/get"
    # 变量提取器配置
    extractors:
      # 提取完整的响应URL
      - name: response_url  # 提取后的变量名
        type: jsonpath  # 提取器类型：jsonpath/regex/header/cookie
        path: "$.body.url"  # JSONPath表达式
        description: "提取响应URL"
      # 提取origin字段
      - name: response_origin
        type: jsonpath
        path: "$.body.origin"
        description: "提取origin字段"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"

  # ----------------------------------------------------------------------------
  # 步骤2: 使用提取的变量
  # 用途：在后续步骤中使用之前提取的变量
  # 变量引用语法：${变量名}
  # ----------------------------------------------------------------------------
  - name: "使用提取的变量"
    description: "在请求中使用上一步提取的变量"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      # 使用上一步提取的变量
      original_url: "${response_url}"
      original_origin: "${response_origin}"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
      - type: contains
        path: "$.json.original_url"
        expect: "httpbin.org"
        description: "验证提取的URL包含httpbin.org"

  # ----------------------------------------------------------------------------
  # 步骤3: Header提取器
  # 用途：从HTTP响应头中提取数据
  # 提取器类型：header
  # ----------------------------------------------------------------------------
  - name: "Header提取器"
    description: "从HTTP响应头中提取数据"
    type: request
    method: GET
    url: "${config.profiles.prod.base_url}/headers"
    extractors:
      # 提取响应头中的Content-Type
      - name: content_type
        type: header
        path: "Content-Type"
        description: "提取Content-Type响应头"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"

  # ----------------------------------------------------------------------------
  # 步骤4: 使用提取的Header变量
  # 用途：在后续请求中使用提取的Header变量
  # ----------------------------------------------------------------------------
  - name: "使用提取的Header变量"
    description: "在请求中使用提取的Header变量"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      original_content_type: "${content_type}"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
      - type: contains
        path: "$.json.original_content_type"
        expect: "json"
        description: "验证content_type包含json"

  # ----------------------------------------------------------------------------
  # 步骤5: 综合提取示例
  # 用途：演示从响应中提取多个不同类型的变量
  # ----------------------------------------------------------------------------
  - name: "综合提取示例"
    description: "从响应中提取多个变量"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
      X-Custom-Header: "custom_value_12345"
    body:
      order_id: "ORD-2024-001"
      customer_name: "张三"
      amount: 999.99
    extractors:
      # 提取完整的请求URL
      - name: request_url
        type: jsonpath
        path: "$.body.url"
        description: "提取请求URL"
      # 提取自定义请求头
      - name: custom_header
        type: header
        path: "X-Custom-Header"
        description: "提取自定义请求头"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"

  # ----------------------------------------------------------------------------
  # 步骤6: 使用综合提取的变量
  # 用途：在后续步骤中使用所有提取的变量
  # ----------------------------------------------------------------------------
  - name: "使用综合提取的变量"
    description: "验证所有提取的变量都可用"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      summary:
        url: "${request_url}"
        header: "${custom_header}"
        # 使用之前步骤提取的变量
        original_url: "${response_url}"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
      - type: contains
        path: "$.json.summary.url"
        expect: "httpbin.org"
        description: "验证URL包含httpbin.org"

  # ----------------------------------------------------------------------------
  # 步骤7: Regex提取器 - 新语法（pattern/group）
  # 用途：演示 Regex 提取器使用语义化的 pattern 和 group 字段
  # 增强功能：支持 pattern/group 作为 path/index 的别名
  # ----------------------------------------------------------------------------
  - name: "Regex提取器新语法"
    description: "使用 pattern 和 group 字段（推荐用法）"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      userId: 101809
      userName: "testuser"
      email: "test@example.com"
    extractors:
      # 新语法：使用 pattern 和 group 字段（更语义化）
      - name: extracted_user_id
        type: regex
        pattern: '"userId":\s*(\d+)'
        group: 1
        description: "使用 pattern/group 提取 userId"
      # 旧语法：使用 path 和 index 字段（向后兼容）
      - name: extracted_username
        type: regex
        path: '"userName":\s*"([^"]+)"'
        index: 1
        description: "使用 path/index 提取 userName（兼容旧语法）"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"

  # ----------------------------------------------------------------------------
  # 步骤8: 验证 Regex 提取的变量
  # 用途：验证新语法提取的变量可以正常使用
  # ----------------------------------------------------------------------------
  - name: "验证Regex提取的变量"
    description: "验证使用 pattern/group 提取的变量"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      userId: "${extracted_user_id}"
      userName: "${extracted_username}"
      expectedUserId: "101809"
      expectedUsername: "testuser"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
      - type: eq
        path: "$.json.userId"
        expect: "101809"
        description: "验证提取的 userId"
      - type: eq
        path: "$.json.userName"
        expect: "testuser"
        description: "验证提取的 userName"

  # ----------------------------------------------------------------------------
  # 步骤9: 多提取器同时工作
  # 用途：验证多个提取器配置都能正确执行（Bug修复验证）
  # 修复问题：之前只有最后一个提取器生效
  # ----------------------------------------------------------------------------
  - name: "多提取器同时工作"
    description: "验证多个提取器都能正确执行"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
      X-Custom-Header: "CustomValue123"
    body:
      orderId: "ORD-2024-001"
      amount: 999.99
      userId: 101809
    extractors:
      # 提取器1: JSONPath 提取 orderId
      - name: extract_order_id
        type: jsonpath
        path: "$.body.json.orderId"
        description: "提取订单ID"
      # 提取器2: Regex 提取 amount
      - name: extract_amount
        type: regex
        pattern: '"amount":\s*([\d.]+)'
        group: 1
        description: "提取金额"
      # 提取器3: JSONPath 提取 userId
      - name: extract_user_id
        type: jsonpath
        path: "$.body.json.userId"
        description: "提取用户ID"
      # 提取器4: Header 提取
      - name: extract_custom_header
        type: header
        path: "X-Custom-Header"
        description: "提取自定义响应头"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"

  # ----------------------------------------------------------------------------
  # 步骤10: 验证所有提取器都工作正常
  # 用途：验证多个提取器提取的变量都可用
  # ----------------------------------------------------------------------------
  - name: "验证所有提取器结果"
    description: "验证所有提取器提取的变量都正确"
    type: request
    method: POST
    url: "${config.profiles.prod.base_url}/post"
    headers:
      Content-Type: "application/json"
    body:
      orderId: "${extract_order_id}"
      amount: "${extract_amount}"
      userId: "${extract_user_id}"
      customHeader: "${extract_custom_header}"
    validations:
      - type: status_code
        path: "$.status_code"
        expect: "200"
      - type: eq
        path: "$.json.orderId"
        expect: "ORD-2024-001"
        description: "验证提取的 orderId"
      - type: eq
        path: "$.json.amount"
        expect: "999.99"
        description: "验证提取的 amount"
      - type: eq
        path: "$.json.userId"
        expect: "101809"
        description: "验证提取的 userId"
      - type: eq
        path: "$.json.customHeader"
        expect: "CustomValue123"
        description: "验证提取的自定义头"

# ============================================================================
# 标签
# ============================================================================
tags:
  - "基础"
  - "提取器"
  - "变量"
  - "regex"
  - "多提取器"

enabled: true
