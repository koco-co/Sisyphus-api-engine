name: "综合功能测试"
description: "验证所有核心功能协同工作"

config:
  profiles:
    dev:
      base_url: "https://httpbin.org"
      variables:
        test_suffix: "001"
        env: "dev"
  active_profile: "dev"

  # 验证变量嵌套引用 (任务1)
  variables:
    # 嵌套引用 config 变量
    test_id: "test_${config.profiles.dev.variables.test_suffix}"
    # 引用其他变量
    full_id: "${test_id}_${config.profiles.dev.variables.env}"

steps:
  # 步骤 1: 验证变量渲染
  - name: "验证变量嵌套引用"
    type: request
    url: "https://httpbin.org/post"
    method: POST
    body:
      test_id: "${test_id}"
      full_id: "${full_id}"
      expected_id: "test_001_dev"
    validations:
      - type: eq
        path: "$.form.full_id"
        expect: "test_001_dev"
    extractors:
      - type: jsonpath
        name: response_id
        path: "$.form.test_id"

  # 步骤 2: 验证轮询机制 (任务2)
  - name: "轮询等待特定条件"
    type: poll
    url: "https://httpbin.org/post"
    method: POST
    body:
      status_check: "ready"
      attempt: 1
    poll_config:
      condition:
        type: jsonpath
        path: "$.form.status_check"
        operator: "eq"
        expect: "ready"
      max_attempts: 2
      interval: 500
      timeout: 3000
      backoff: "fixed"

  # 步骤 3: 验证 JSONPath filter (任务3)
  - name: "验证 JSONPath 表达式"
    type: request
    url: "https://httpbin.org/post"
    method: POST
    body:
      items:
        - name: "item1"
          value: 100
        - name: "item2"
          value: 200
        - name: "target"
          value: 300
    extractors:
      # 使用 filter 表达式提取特定元素
      - type: jsonpath
        name: target_item
        path: "$.form.items[?(@.name == 'target')].value"
    validations:
      - type: eq
        path: "$.form.items[?(@.name == 'target')].value"
        expect: 300

  # 步骤 4: 验证条件执行 (任务4)
  - name: "条件执行 - only_if 示例"
    type: request
    url: "https://httpbin.org/post"
    method: POST
    only_if: "${response_id} != null"
    body:
      message: "这个步骤会执行因为 response_id 存在"

  # 步骤 5: 验证验证断言增强 (任务7)
  - name: "复合验证测试"
    type: request
    url: "https://httpbin.org/post"
    method: POST
    body:
      status: "success"
      count: 5
      items: ["a", "b", "c"]
    validations:
      # 多种验证器
      - type: eq
        path: "$.form.status"
        expect: "success"
      - type: gt
        path: "$.form.count"
        expect: 0
      - type: contains
        path: "$.form.items"
        expect: "b"

  # 步骤 6: 验证重试机制 (任务6)
  - name: "验证重试机制"
    type: request
    url: "https://httpbin.org/status/200"
    method: GET
    retry_policy:
      max_attempts: 2
      strategy: fixed
      base_delay: 0.1
    validations:
      - type: eq
        path: "$.status_code"
        expect: 200

  # 步骤 7: 验证内置函数 (任务9)
  - name: "验证内置模板函数"
    type: request
    url: "https://httpbin.org/post"
    method: POST
    body:
      random_val: "${random_str(8)}"
      uuid_val: "${uuid_str()}"
      timestamp: "${date('%Y-%m-%d')}"
    validations:
      - type: exists
        path: "$.form.random_val"
      - type: exists
        path: "$.form.uuid_val"

  # 步骤 8: 验证性能监控 (任务10)
  - name: "性能监控测试"
    type: request
    url: "https://httpbin.org/delay/1"
    method: GET
    # 这个步骤会记录性能数据

  # 步骤 9: 验证提取器 (所有任务相关)
  - name: "综合提取器测试"
    type: request
    url: "https://httpbin.org/post"
    method: POST
    body:
      user_id: "12345"
      user_name: "TestUser"
      user_email: "test@example.com"
      created_at: "2024-01-01"
      tag1: "tag1"
      tag2: "tag2"
      tag3: "tag3"
    extractors:
      # JSONPath 提取扁平字段
      - type: jsonpath
        name: user_id
        path: "$.form.user_id"
      - type: jsonpath
        name: user_name
        path: "$.form.user_name"
      - type: jsonpath
        name: extracted_tag2
        path: "$.form.tag2"

  # 步骤 10: 最终验证
  - name: "最终验证所有功能"
    type: request
    url: "https://httpbin.org/post"
    method: POST
    body:
      summary: "所有核心功能验证完成"
      features_verified:
        - "变量嵌套引用"
        - "异步轮询"
        - "JSONPath增强"
        - "条件执行"
        - "验证断言"
        - "重试机制"
        - "内置函数"
        - "性能监控"
        - "提取器"
    validations:
      - type: eq
        path: "$.form.summary"
        expect: "所有核心功能验证完成"
