# Sisyphus API Engine - 重构任务清单

> **文档说明**: 本文档是项目代码重构的工作清单，用于指导项目代码的 review、重构、测试和文档更新工作。
> **最后更新**: 2026-02-04
> **当前状态**: 进行中

---

## 📋 目录

- [重构目标](#重构目标)
- [工作流程](#工作流程)
- [任务清单](#任务清单)
- [进度跟踪](#进度跟踪)

---

## 🎯 重构目标

### 核心目标
1. **代码规范**: 将所有 Google 规范的英文注释改为中文
2. **代码质量**: Review 所有代码，识别并修复不合理的设计
3. **测试覆盖**: 为每个功能模块补充完整的单元测试（覆盖率 80%+）
4. **使用文档**: 创建 YAML 测试用例编写的学习文档（面向用户）
5. **项目清理**: 删除不需要的测试文件、报告文件、问题记录等

### 重要区分

| 文档类型 | 位置 | 受众 | 目的 |
|----------|------|------|------|
| **重构任务清单** | `重构任务清单.md`（根目录） | 开发者 | 指导项目代码重构工作 |
| **使用学习文档** | `docs/` 目录 | Sisyphus 用户 | 教用户如何编写 YAML 测试用例 |

⚠️ **注意**: `docs/` 目录下的文档是**面向用户的使用教程**，围绕"如何编写 YAML 测试用例"展开，不是围绕"理解项目代码"展开。

---

## 🔄 工作流程

### 标准化流程（每个功能模块）

```
步骤1: 阅读理解代码
  ↓
步骤2: 代码 Review 和中文注释
  ↓
步骤3: 删除旧的测试文件
  ↓
步骤4: 编写单元测试（从零，不参考旧文件）
  ↓
步骤5: 创建 YAML 案例示例
  ↓
步骤6: 自测验证
  ↓
步骤7: 编写使用文档（docs目录，面向用户）
  ↓
步骤8: 更新项目文档（README/CHANGELOG等）
  ↓
步骤9: 原子化提交
  ↓
步骤10: 更新任务清单（标记已完成）
```

### 详细步骤说明

#### 步骤1: 阅读理解代码
- 仔细阅读当前功能模块的所有代码文件
- 理解代码逻辑、设计意图、依赖关系
- 记录发现的问题和改进点

#### 步骤2: 代码 Review 和中文注释
- 将 Google 规范的英文注释改为中文
- 识别不合理的设计，提出质疑
- 确认后重写逻辑
- **发现新功能**: 若发现重构任务清单中未列出的功能，需要：
  - 分析功能特性和归属
  - 调整任务清单内容
  - 同步调整 docs 目录下的文档结构
  - 规划单元测试和 YAML 案例

#### 步骤3: 删除旧的测试文件
```bash
# 删除旧的单元测试（保留目录结构）
rm -rf tests/<module>/*.py

# 删除旧的 YAML 示例
rm -f examples/<old_files>.yaml
```

#### 步骤4: 编写单元测试
- **从零编写**，不参考旧文件
- 使用 Google 规范的中文注释
- 充分考虑测试场景：
  - ✅ 正常场景
  - ✅ 边界场景
  - ✅ 异常场景
- 目标覆盖率：80%+

#### 步骤5: 创建 YAML 案例示例
- 位置：`examples/yaml/<序号>_<功能名称>_<场景>.yaml`
- 覆盖所有关键字和使用场景
- 确保 YAML 可以实际运行

#### 步骤6: 自测验证
```bash
# 运行单元测试
pytest tests/<module>/ -v

# 运行 YAML 案例
sisyphus --cases examples/yaml/<test_case>.yaml
```

#### 步骤7: 编写使用文档（docs目录，面向用户）
- 按照 `docs/template_docs.md` 模板规范
- 创建或更新 `docs/<序号>_<功能名称>.md`
- **重点**: 围绕"如何编写 YAML 测试用例"展开
- 包含内容：
  - YAML 关键字表格（字段、类型、必填、默认值、说明）
  - YAML 使用示例（代码块）
  - 推荐的组合使用方式
  - 常见问题解答

#### 步骤8: 更新项目文档
- 更新 `README.md`（引用路径要正确）
- 更新 `CHANGELOG.md`（记录变更）
- 更新 `pyproject.toml`（如需要）
- 检查所有文档引用路径的正确性

#### 步骤9: 原子化提交
按改动点分批提交：
```bash
# 代码重构提交
git add apirun/<module>/<file>.py
git commit -m "refactor(<module>): 📝 将<功能>注释改为中文"

# 单元测试提交
git add tests/<module>/test_<file>.py
git commit -m "test(<module>): ✅ 新增<功能>单元测试"

# YAML 案例提交
git add examples/yaml/<test_case>.yaml
git commit -m "docs(examples): 📝 新增<功能>YAML示例"

# 使用文档提交
git add docs/<序号>_<功能名称>.md
git commit -m "docs: 📝 更新<功能>使用文档"

# 项目文档更新提交
git add README.md CHANGELOG.md
git commit -m "docs: 📝 更新README和CHANGELOG"
```

#### 步骤10: 更新任务清单
- 在本文档的[任务清单](#任务清单)部分标记任务为 `- [x] ✅ 已完成`
- 更新[进度跟踪](#进度跟踪)部分

---

## 📝 任务清单

### 阶段1: 核心数据模型
- [ ] 1.1 阅读 `apirun/core/models.py`
- [ ] 1.2 代码 Review 和中文注释
  - [ ] HttpMethod 枚举
  - [ ] ErrorCategory 枚举
  - [ ] ProfileConfig 模型
  - [ ] GlobalConfig 模型
  - [ ] TestCase 模型
  - [ ] TestStep 模型
  - [ ] ValidationRule 模型
  - [ ] Extractor 模型
  - [ ] StepResult / TestCaseResult 模型
  - [ ] PerformanceMetrics 模型
  - [ ] ErrorInfo 模型
- [ ] 1.3 删除旧测试: `rm tests/core/test_models.py`
- [ ] 1.4 编写单元测试
- [ ] 1.5 创建 YAML 案例: `examples/yaml/01_数据模型_基础配置.yaml`
- [ ] 1.6 自测验证
- [ ] 1.7 编写使用文档: `docs/01_基础配置与环境管理.md`（面向用户，教如何写YAML）
- [ ] 1.8 更新项目文档
- [ ] 1.9 原子化提交
- [ ] 1.10 更新任务清单

---

### 阶段2: 变量系统
- [ ] 2.1 阅读 `apirun/core/variable_manager.py`, `template_functions.py`, `condition_evaluator.py`
- [ ] 2.2 代码 Review 和中文注释
- [ ] 2.3 删除旧测试
- [ ] 2.4 编写单元测试
- [ ] 2.5 创建 YAML 案例
- [ ] 2.6 自测验证
- [ ] 2.7 编写使用文档: `docs/02_变量使用与模板语法.md`（教用户如何使用变量）
- [ ] 2.8 更新项目文档
- [ ] 2.9 原子化提交
- [ ] 2.10 更新任务清单

---

### 阶段3: YAML 解析器
- [ ] 3.1 阅读 `apirun/parser/v2_yaml_parser.py`, `yaml_validator.py`
- [ ] 3.2 代码 Review 和中文注释
- [ ] 3.3 删除旧测试
- [ ] 3.4 编写单元测试
- [ ] 3.5 创建 YAML 案例
- [ ] 3.6 自测验证
- [ ] 3.7 编写使用文档: `docs/03_YAML测试用例结构.md`（教用户如何编写测试用例）
- [ ] 3.8 更新项目文档
- [ ] 3.9 原子化提交
- [ ] 3.10 更新任务清单

---

### 阶段4: HTTP 请求执行
- [ ] 4.1 阅读 `apirun/executor/api_executor.py`
- [ ] 4.2 代码 Review 和中文注释
- [ ] 4.3 删除旧测试
- [ ] 4.4 编写单元测试
- [ ] 4.5 创建 YAML 案例
- [ ] 4.6 自测验证
- [ ] 4.7 编写使用文档: `docs/04_HTTP请求测试.md`（教用户如何发送HTTP请求）
- [ ] 4.8 更新项目文档
- [ ] 4.9 原子化提交
- [ ] 4.10 更新任务清单

---

### 阶段5: 验证系统
- [ ] 5.1 阅读 `apirun/validation/` 目录
- [ ] 5.2 代码 Review 和中文注释
- [ ] 5.3 删除旧测试
- [ ] 5.4 编写单元测试
- [ ] 5.5 创建 YAML 案例
- [ ] 5.6 自测验证
- [ ] 5.7 编写使用文档: `docs/05_响应验证与断言.md`（教用户如何验证响应）
- [ ] 5.8 更新项目文档
- [ ] 5.9 原子化提交
- [ ] 5.10 更新任务清单

---

### 阶段6: 变量提取
- [ ] 6.1 阅读 `apirun/extractor/` 目录
- [ ] 6.2 代码 Review 和中文注释
- [ ] 6.3 删除旧测试
- [ ] 6.4 编写单元测试
- [ ] 6.5 创建 YAML 案例
- [ ] 6.6 自测验证
- [ ] 6.7 编写使用文档: `docs/06_变量提取技巧.md`（教用户如何提取变量）
- [ ] 6.8 更新项目文档
- [ ] 6.9 原子化提交
- [ ] 6.10 更新任务清单

---

### 阶段7: 步骤执行类型
- [ ] 7.1 阅读各类执行器（wait/loop/concurrent/poll/database/script）
- [ ] 7.2 代码 Review 和中文注释
- [ ] 7.3 删除旧测试
- [ ] 7.4 编写单元测试
- [ ] 7.5 创建 YAML 案例
- [ ] 7.6 自测验证
- [ ] 7.7 编写使用文档: `docs/07_高级步骤控制.md`（教用户如何使用高级步骤）
- [ ] 7.8 更新项目文档
- [ ] 7.9 原子化提交
- [ ] 7.10 更新任务清单

---

### 阶段8: 测试用例执行与依赖管理
- [ ] 8.1 阅读 `apirun/executor/test_case_executor.py`, `dependency_analyzer.py`
- [ ] 8.2 代码 Review 和中文注释
- [ ] 8.3 删除旧测试
- [ ] 8.4 编写单元测试
- [ ] 8.5 创建 YAML 案例
- [ ] 8.6 自测验证
- [ ] 8.7 编写使用文档: `docs/08_测试流程控制.md`（教用户如何控制测试流程）
- [ ] 8.8 更新项目文档
- [ ] 8.9 原子化提交
- [ ] 8.10 更新任务清单

---

### 阶段9: 数据驱动测试
- [ ] 9.1 阅读 `apirun/data_driven/` 目录
- [ ] 9.2 代码 Review 和中文注释
- [ ] 9.3 删除旧测试
- [ ] 9.4 编写单元测试
- [ ] 9.5 创建 YAML 案例
- [ ] 9.6 自测验证
- [ ] 9.7 编写使用文档: `docs/09_数据驱动测试.md`（教用户如何进行数据驱动测试）
- [ ] 9.8 更新项目文档
- [ ] 9.9 原子化提交
- [ ] 9.10 更新任务清单

---

### 阶段10: 结果收集与输出
- [ ] 10.1 阅读 `apirun/result/` 目录
- [ ] 10.2 代码 Review 和中文注释
- [ ] 10.3 删除旧测试
- [ ] 10.4 编写单元测试
- [ ] 10.5 创建 YAML 案例
- [ ] 10.6 自测验证
- [ ] 10.7 编写使用文档: `docs/10_测试结果与报告.md`（教用户如何生成报告）
- [ ] 10.8 更新项目文档
- [ ] 10.9 原子化提交
- [ ] 10.10 更新任务清单

---

### 阶段11: 实用工具与辅助功能
- [ ] 11.1 阅读 `apirun/utils/` 目录
- [ ] 11.2 代码 Review 和中文注释
- [ ] 11.3 删除旧测试
- [ ] 11.4 编写单元测试
- [ ] 11.5 自测验证
- [ ] 11.6 原子化提交
- [ ] 11.7 更新任务清单

---

### 阶段12: 命令行接口
- [ ] 12.1 阅读 `apirun/cli.py`
- [ ] 12.2 代码 Review 和中文注释
- [ ] 12.3 自测验证
- [ ] 12.4 更新 README.md（命令行参数说明）
- [ ] 12.5 更新 CHANGELOG.md
- [ ] 12.6 原子化提交
- [ ] 12.7 更新任务清单

---

### 阶段13: 项目清理
- [ ] 13.1 删除多余的测试报告文件（allure-results/ 等）
- [ ] 13.2 删除问题记录文档
- [ ] 13.3 删除临时测试脚本
- [ ] 13.4 删除总结文件
- [ ] 13.5 确保只保留：
  - ✅ 单元测试（tests/ 目录）
  - ✅ YAML 示例（examples/ 目录）
  - ✅ 使用文档（docs/ 目录）
  - ✅ 核心代码（apirun/ 目录）
- [ ] 13.6 最终提交

---

## 📊 进度跟踪

### 整体进度

| 阶段 | 模块 | 进度 | 备注 |
|-----|------|------|------|
| 1 | 核心数据模型 | ⏳ 0% | 待开始 |
| 2 | 变量系统 | ⏳ 0% | 待开始 |
| 3 | YAML 解析器 | ⏳ 0% | 待开始 |
| 4 | HTTP 请求执行 | ⏳ 0% | 待开始 |
| 5 | 验证系统 | ⏳ 0% | 待开始 |
| 6 | 变量提取 | ⏳ 0% | 待开始 |
| 7 | 步骤执行类型 | ⏳ 0% | 待开始 |
| 8 | 测试用例执行 | ⏳ 0% | 待开始 |
| 9 | 数据驱动测试 | ⏳ 0% | 待开始 |
| 10 | 结果收集与输出 | ⏳ 0% | 待开始 |
| 11 | 实用工具 | ⏳ 0% | 待开始 |
| 12 | 命令行接口 | ⏳ 0% | 待开始 |
| 13 | 项目清理 | ⏳ 0% | 待开始 |

**总进度**: 0 / 13 阶段完成 (0%)

---

## 📚 相关文档

### 重构工作文档
- `重构任务清单.md`（本文档）- 项目重构工作清单
- `docs/template_docs.md` - 使用文档编写模板
- `.claude/commands/refactor.md` - 重构工作流程自定义命令

### 使用学习文档（docs/ 目录，面向用户）
> 这些文档在重构过程中逐步创建和完善

- `docs/01_基础配置与环境管理.md` - 待创建
- `docs/02_变量使用与模板语法.md` - 待创建
- `docs/03_YAML测试用例结构.md` - 待创建
- `docs/04_HTTP请求测试.md` - 待创建
- `docs/05_响应验证与断言.md` - 待创建
- `docs/06_变量提取技巧.md` - 待创建
- `docs/07_高级步骤控制.md` - 待创建
- `docs/08_测试流程控制.md` - 待创建
- `docs/09_数据驱动测试.md` - 待创建
- `docs/10_测试结果与报告.md` - 待创建

### 现有规范文档
- `docs/API-Engine输入协议规范.md` - YAML 语法完整规范
- `docs/API-Engine输出协议规范.md` - 输出格式规范
- `README.md` - 项目说明
- `CHANGELOG.md` - 版本更新日志

---

## ⚠️ 重要注意事项

### 1. 注释规范
- 使用 Google Python Style Guide 的中文注释
- 所有类和函数必须有 docstring
- 最大行长度：100 字符

### 2. 测试规范
- **不参考旧测试文件**，从零编写
- 充分考虑测试场景
- 目标覆盖率：80%+

### 3. 文档定位
- `docs/` 目录文档是**使用教程**，面向 YAML 测试用例编写者
- 不是代码架构文档，不要围绕"理解代码"展开
- 围绕"如何使用 Sisyphus 编写测试"展开

### 4. 提交规范
- 原子化提交，不同改动分开
- 提交信息：`<type>(<scope>): <emoji> <description>`
- Types: refactor, test, docs, feat, fix, chore

---

## 🚀 快速开始

### 启动重构工作
```bash
# 使用自定义命令
/refactor

# 或手动查看
cat 重构任务清单.md
```

### 常用命令
```bash
# 运行测试
pytest tests/<module>/ -v

# 运行 YAML 案例
sisyphus --cases examples/yaml/<test_case>.yaml

# 验证 YAML 语法
sisyphus-validate examples/yaml/<test_case>.yaml
```

---

**文档维护**: 本文档随重构进度持续更新
**开始日期**: 2026-02-04
**预计完成**: 待定
