# Sisyphus API Engine 功能改进任务清单

> 最后更新: 2026-02-02
> 总进度: 2/12 (17%)

---

## 📊 总体进度

| 优先级 | 总数 | 已完成 | 进行中 | 待开始 |
|--------|------|--------|--------|--------|
| 🔴 高 | 2 | 2 | 0 | 0 |
| 🟠 中高 | 2 | 0 | 0 | 2 |
| 🟠 中 | 3 | 0 | 0 | 3 |
| 🟢 低 | 5 | 0 | 0 | 5 |
| **合计** | **12** | **2** | **0** | **10** |

---

## 🔴 高优先级任务

### ✅ 任务 1: 变量作用域与嵌套引用增强

**状态**: ✅ 已完成 (2026-02-02)
**工作量**: 实际 0.5 天
**价值**: ⭐⭐⭐⭐⭐

**子任务**:
- [x] 分析当前变量管理器实现 (`apirun/core/variable_manager.py`)
- [x] 设计嵌套引用解析机制
- [x] 实现变量递归解析逻辑
- [x] 支持在顶层 `variables` 中引用 `config.profiles.*`
- [x] 编写单元测试
- [x] 编写集成测试和示例
- [x] 更新文档

**验收标准**:
- ✅ 支持在 `variables` 中嵌套引用 `config` 变量
- ✅ 支持多层级嵌套引用
- ✅ 提供清晰的错误提示
- ✅ 不影响现有功能

**实现文件**:
- `apirun/core/variable_manager.py` - 添加 config_context 支持
- `apirun/parser/v2_yaml_parser.py` - 解析器集成
- `tests/core/test_variable_manager.py` - 单元测试
- `tests/parser/test_nested_variable_reference.py` - 集成测试
- `examples/变量嵌套引用示例.yaml` - 使用示例
- `问题跟踪文档/功能实现-变量嵌套引用.md` - 功能文档

**测试结果**: 61 个测试全部通过 (16 个新增 + 45 个现有)

---

### ✅ 任务 2: 异步轮询机制

**状态**: ✅ 已完成 (2026-02-02)
**工作量**: 实际 0.5 天
**价值**: ⭐⭐⭐⭐⭐

**子任务**:
- [x] 设计轮询步骤的数据模型 (`TestStep`)
- [x] 创建 `PollStepExecutor` 执行器
- [x] 实现轮询条件判断 (JSONPath/状态码)
- [x] 实现轮询策略 (固定间隔/指数退避/线性增长)
- [x] 支持超时处理
- [x] 集成到测试用例执行器
- [x] 编写单元测试
- [x] 编写集成测试和示例
- [x] 更新输入协议文档

**验收标准**:
- ✅ 支持 `poll` 类型步骤
- ✅ 支持多种轮询条件判断方式
- ✅ 支持可配置的轮询策略
- ✅ 提供清晰的超时错误信息
- ✅ 向后兼容现有代码

**实现文件**:
- `apirun/core/models.py` - 添加 poll_config 和 on_timeout 字段
- `apirun/executor/poll_executor.py` - 轮询执行器(新文件)
- `apirun/executor/test_case_executor.py` - 注册 poll 类型
- `apirun/parser/v2_yaml_parser.py` - 解析轮询配置
- `tests/executor/test_poll_executor.py` - 单元测试
- `examples/异步轮询示例.yaml` - 使用示例
- `问题跟踪文档/功能实现-异步轮询机制.md` - 功能文档

**测试结果**: 20 个测试全部通过

---

## 🟠 中高优先级任务
**工作量**: 3-5 天
**价值**: ⭐⭐⭐⭐⭐

**子任务**:
- [ ] 设计轮询步骤的数据模型 (`TestStep`)
- [ ] 创建 `PollStepExecutor` 执行器
- [ ] 实现轮询条件判断 (JSONPath/状态码/脚本)
- [ ] 实现轮询策略 (固定间隔/指数退避)
- [ ] 支持超时处理
- [ ] 集成到测试用例执行器
- [ ] 编写单元测试
- [ ] 编写集成测试和示例
- [ ] 更新输入协议文档

**验收标准**:
- ✅ 支持 `poll` 类型步骤
- ✅ 支持多种轮询条件判断方式
- ✅ 支持可配置的轮询策略
- ✅ 提供清晰的超时错误信息
- ✅ 向后兼容现有代码

---

## 🟠 中高优先级任务

### ✅ 任务 3: JSONPath 表达式增强

**状态**: ⏸️ 待开始
**工作量**: 2-3 天
**价值**: ⭐⭐⭐⭐

**子任务**:
- [ ] 评估 JSONPath 库 (jsonpath-ng 等)
- [ ] 增强 JSONPath 提取器
- [ ] 支持 filter 表达式 `[?(@.field == 'value')]`
- [ ] 支持复杂条件 `&&`、`||`
- [ ] 添加内置辅助函数 (first, find, filter)
- [ ] 编写单元测试
- [ ] 编写使用示例
- [ ] 更新文档

**验收标准**:
- ✅ 支持 filter 表达式
- ✅ 支持多条件组合
- ✅ 提供常用辅助函数
- ✅ 兼容现有 JSONPath 语法

---

### ✅ 任务 4: 条件执行增强

**状态**: ⏸️ 待开始
**工作量**: 1-2 天
**价值**: ⭐⭐⭐⭐

**子任务**:
- [ ] 扩展 `condition` 字段数据模型
- [ ] 支持 AND/OR/NOT 逻辑组合
- [ ] 支持嵌套条件
- [ ] 添加 `skip` 原因说明
- [ ] 支持 `expect_fail` 标记
- [ ] 编写单元测试
- [ ] 编写使用示例
- [ ] 更新文档

**验收标准**:
- ✅ 支持复杂的条件逻辑
- ✅ 支持嵌套条件
- ✅ 提供清晰的跳过原因
- ✅ 向后兼容简单条件语法

---

## 🟠 中优先级任务

### ✅ 任务 5: 循环支持

**状态**: ⏸️ 待开始
**工作量**: 3-4 天
**价值**: ⭐⭐⭐

**子任务**:
- [ ] 设计循环步骤数据模型
- [ ] 创建 `ForeachStepExecutor` 执行器
- [ ] 支持数组遍历
- [ ] 支持字典遍历
- [ ] 支持循环控制 (max_iterations, break_on_error)
- [ ] 处理循环变量作用域
- [ ] 编写单元测试
- [ ] 编写集成测试和示例
- [ ] 更新文档

**验收标准**:
- ✅ 支持 `foreach` 步骤类型
- ✅ 支持数组和字典遍历
- ✅ 支持循环控制参数
- ✅ 正确处理变量作用域

---

### ✅ 任务 6: 错误处理与重试机制

**状态**: ⏸️ 待开始
**工作量**: 2-3 天
**价值**: ⭐⭐⭐

**子任务**:
- [ ] 检查现有重试机制实现
- [ ] 扩展重试策略 (fixed/exponential/linear)
- [ ] 支持基于错误码的重试
- [ ] 支持网络错误重试
- [ ] 添加 `on_failure` 和 `on_success` 钩子
- [ ] 支持条件重试
- [ ] 编写单元测试
- [ ] 编写使用示例
- [ ] 更新文档

**验收标准**:
- ✅ 支持多种重试策略
- ✅ 支持智能重试条件
- ✅ 提供失败/成功钩子
- ✅ 向后兼容现有重试机制

---

### ✅ 任务 7: 验证断言增强

**状态**: ⏸️ 待开始
**工作量**: 2-3 天
**价值**: ⭐⭐⭐

**子任务**:
- [ ] 扩展验证规则数据模型
- [ ] 实现 AND/OR/NOT 复合验证
- [ ] 实现范围验证 (range)
- [ ] 实现集合验证 (in)
- [ ] 实现脚本验证 (script)
- [ ] 添加正则表达式验证
- [ ] 编写单元测试
- [ ] 编写使用示例
- [ ] 更新文档

**验收标准**:
- ✅ 支持复合验证逻辑
- ✅ 支持范围和集合验证
- ✅ 支持自定义脚本验证
- ✅ 向后兼容现有验证器

---

## 🟢 低优先级任务

### ✅ 任务 8: 数据驱动测试改进

**状态**: ⏸️ 待开始
**工作量**: 1-2 天
**价值**: ⭐⭐

**子任务**:
- [ ] 优化数据驱动语法
- [ ] 支持更清晰的数据定义
- [ ] 支持标签和元数据
- [ ] 编写使用示例
- [ ] 更新文档

---

### ✅ 任务 9: 内置辅助函数

**状态**: ⏸️ 待开始
**工作量**: 2-3 天
**价值**: ⭐⭐

**子任务**:
- [ ] 扩展随机字符串函数
- [ ] 添加时间函数 (相对时间)
- [ ] 添加数组操作函数
- [ ] 添加字符串操作函数
- [ ] 添加数值操作函数
- [ ] 编写单元测试
- [ ] 编写使用示例
- [ ] 更新文档

**验收标准**:
- ✅ 提供丰富的内置函数库
- ✅ 函数命名清晰直观
- ✅ 提供完整的使用文档

---

### ✅ 任务 10: 性能监控与分析

**状态**: ⏸️ 待开始
**工作量**: 2-3 天
**价值**: ⭐

**子任务**:
- [ ] 扩展性能指标收集
- [ ] 添加慢步骤标记
- [ ] 实现性能评分机制
- [ ] 支持性能报告导出
- [ ] 添加 CLI 参数 `--performance-report`
- [ ] 编写使用示例
- [ ] 更新文档

**验收标准**:
- ✅ 记录详细的性能数据
- ✅ 提供性能分析报告
- ✅ 标记慢步骤

---

### ✅ 任务 11: 测试依赖可视化

**状态**: ⏸️ 待开始
**工作量**: 2-3 天
**价值**: ⭐

**子任务**:
- [ ] 实现依赖关系分析
- [ ] 生成依赖图数据
- [ ] 支持 Mermaid 格式输出
- [ ] 检测循环依赖
- [ ] 添加 CLI 参数 `--graph-deps`
- [ ] 编写使用示例
- [ ] 更新文档

**验收标准**:
- ✅ 正确分析步骤依赖
- ✅ 生成标准格式的依赖图
- ✅ 检测并警告循环依赖

---

### ✅ 任务 12: Mock/Stub 支持

**状态**: ⏸️ 待开始
**工作量**: 3-4 天
**价值**: ⭐

**子任务**:
- [ ] 设计 Mock 配置模型
- [ ] 实现 Mock 服务器
- [ ] 支持请求匹配和响应模拟
- [ ] 集成到测试执行流程
- [ ] 编写单元测试
- [ ] 编写使用示例
- [ ] 更新文档

**验收标准**:
- ✅ 支持灵活的 Mock 配置
- ✅ 支持多种请求匹配方式
- ✅ 提供清晰的 Mock 日志

---

## 📝 实现说明

### 兼容性保证

所有功能实现都遵循以下原则:

1. **向后兼容**: 新功能不影响现有测试用例
2. **渐进增强**: 新语法为可选项,旧语法继续支持
3. **充分测试**: 每个功能都有完整的单元测试和集成测试
4. **文档完善**: 每个功能都有清晰的文档和示例

### 测试策略

- **单元测试**: 覆盖核心逻辑,覆盖率 > 80%
- **集成测试**: 验证端到端场景
- **回归测试**: 确保现有功能不受影响
- **示例验证**: 提供实际可运行的示例

### 发布计划

- 每完成一个任务,更新本文档状态
- 每完成一个优先级阶段,发布一个小版本
- 全部完成后发布 v2.0.0 大版本

---

## 📅 版本历史

| 版本 | 日期 | 完成任务 | 说明 |
|------|------|----------|------|
| v1.0.0 | 2026-02-02 | - | 初始任务清单创建 |
