# å˜é‡åµŒå¥—å¼•ç”¨åŠŸèƒ½å®ç°è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

**åŠŸèƒ½åç§°**: å˜é‡ä½œç”¨åŸŸä¸åµŒå¥—å¼•ç”¨å¢å¼º
**å®ç°æ—¥æœŸ**: 2026-02-02
**ä¼˜å…ˆçº§**: ğŸ”´ é«˜ä¼˜å…ˆçº§
**çŠ¶æ€**: âœ… å·²å®Œæˆ

## é—®é¢˜æè¿°

åœ¨ä¹‹å‰çš„ç‰ˆæœ¬ä¸­,ç”¨æˆ·æ— æ³•åœ¨ YAML é¡¶å±‚çš„ `variables` éƒ¨åˆ†åµŒå¥—å¼•ç”¨é…ç½®å˜é‡,å¯¼è‡´å¿…é¡»é‡å¤å†™é•¿é•¿çš„è·¯å¾„ã€‚

### ä¹‹å‰çš„é™åˆ¶

```yaml
# âŒ ä¸æ”¯æŒåµŒå¥—å¼•ç”¨
config:
  profiles:
    ci_62:
      variables:
        test_suffix: "0202093000"

variables:
  # æ— æ³•è¿™æ ·å†™
  category_name: "test_${config.profiles.ci_62.variables.test_suffix}"

  # å¿…é¡»åœ¨æ¯ä¸ªæ­¥éª¤ä¸­é‡å¤å®Œæ•´çš„å€¼
```

## è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒæ”¹è¿›

1. **åœ¨ `VariableManager` ä¸­æ·»åŠ  `config_context` å±æ€§**
   - å­˜å‚¨å®Œæ•´çš„ config å¯¹è±¡,åŒ…æ‹¬ profilesã€variables ç­‰
   - é€šè¿‡ `set_config_context()` æ–¹æ³•è®¾ç½®

2. **ä¿®æ”¹ `get_all_variables()` æ–¹æ³•**
   - åœ¨è¿”å›çš„å˜é‡å­—å…¸ä¸­åŒ…å« config ä¸Šä¸‹æ–‡
   - å…è®¸åœ¨æ¨¡æ¿ä¸­å¼•ç”¨ `config.*`

3. **æ›´æ–° `V2YamlParser`**
   - åœ¨æ¸²æŸ“ variables ä¹‹å‰å…ˆè®¾ç½® config ä¸Šä¸‹æ–‡
   - æ”¯æŒ profiles ä¹‹é—´çš„åµŒå¥—å¼•ç”¨

### ç°åœ¨æ”¯æŒçš„åŠŸèƒ½

```yaml
# âœ… æ”¯æŒåœ¨ variables ä¸­åµŒå¥—å¼•ç”¨
config:
  profiles:
    ci_62:
      variables:
        test_suffix: "0202093000"

variables:
  # å¯ä»¥åµŒå¥—å¼•ç”¨ config å˜é‡
  category_name: "test_${config.profiles.ci_62.variables.test_suffix}"
  datasource_name: "ds_${config.profiles.ci_62.variables.test_suffix}"

steps:
  - name: "åˆ›å»ºç±»ç›®"
    body:
      nodeName: "${category_name}"  # ç®€æ´å¼•ç”¨

  - name: "åˆ›å»ºæ•°æ®æº"
    body:
      dataName: "${datasource_name}"  # ç®€æ´å¼•ç”¨
```

## ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: ç®€å•åµŒå¥—å¼•ç”¨

```yaml
config:
  profiles:
    dev:
      variables:
        test_suffix: "0202093000"
  active_profile: "dev"

  variables:
    category_name: "test_${config.profiles.dev.variables.test_suffix}"
```

æ¸²æŸ“å:
```python
{
  "category_name": "test_0202093000"
}
```

### ç¤ºä¾‹ 2: å¤šä¸ªåµŒå¥—å¼•ç”¨

```yaml
config:
  profiles:
    ci_62:
      variables:
        test_suffix: "0202093000"
        env: "ci"

  variables:
    combined: "${config.profiles.ci_62.variables.test_suffix}_${config.profiles.ci_62.variables.env}"
```

æ¸²æŸ“å:
```python
{
  "combined": "0202093000_ci"
}
```

### ç¤ºä¾‹ 3: å¼•ç”¨ active_profile

```yaml
config:
  profiles:
    dev:
      base_url: "http://dev.api.com"
  active_profile: "dev"

  variables:
    environment: "${config.active_profile}"
    api_url: "${config.profiles.dev.base_url}"
```

æ¸²æŸ“å:
```python
{
  "environment": "dev",
  "api_url": "http://dev.api.com"
}
```

## å®ç°ç»†èŠ‚

### ä¿®æ”¹çš„æ–‡ä»¶

1. **apirun/core/variable_manager.py**
   - æ·»åŠ  `config_context` å±æ€§
   - æ·»åŠ  `set_config_context()` æ–¹æ³•
   - ä¿®æ”¹ `get_all_variables()` åŒ…å« config ä¸Šä¸‹æ–‡

2. **apirun/parser/v2_yaml_parser.py**
   - åœ¨ `_parse_config()` ä¸­æ„å»º config ä¸Šä¸‹æ–‡
   - åœ¨æ¸²æŸ“ variables ä¹‹å‰è®¾ç½® config ä¸Šä¸‹æ–‡

### ä»£ç å˜æ›´

#### VariableManager åˆå§‹åŒ–

```python
def __init__(self, ...):
    # ...
    # Config context for supporting nested references
    self.config_context: Dict[str, Any] = {}
```

#### è®¾ç½® config ä¸Šä¸‹æ–‡

```python
def set_config_context(self, config: Dict[str, Any]) -> None:
    """Set config context for supporting nested references."""
    self.config_context = config
    self._invalidate_cache()
```

#### è·å–æ‰€æœ‰å˜é‡

```python
def get_all_variables(self) -> Dict[str, Any]:
    merged = {}

    # Add config context first for nested references support
    if self.config_context:
        merged["config"] = self.config_context

    # Merge in priority order
    merged.update(self.global_vars)
    merged.update(self.profile_vars)
    merged.update(self.profile_overrides)
    merged.update(self.extracted_vars)

    return merged
```

#### è§£æå™¨ä¸­çš„ä½¿ç”¨

```python
# Build config context
config_context = {
    "profiles": {},
    "active_profile": active_profile,
}

# Add profiles to config context
for profile_name, profile_config in profiles.items():
    config_context["profiles"][profile_name] = {
        "base_url": profile_config.base_url,
        "variables": profile_config.variables,
        # ...
    }

# Set config context in variable manager
vm.set_config_context(config_context)

# Now variables can reference config.profiles.*
```

## å·²çŸ¥é™åˆ¶

### 1. åŠ¨æ€é”®è®¿é—®

âŒ **ä¸æ”¯æŒ**:
```yaml
variables:
  # Jinja2 ä¸å…è®¸åµŒå¥—çš„ ${}
  api_url: "${config.profiles.${config.active_profile}.base_url}"
```

âœ… **æ­£ç¡®åšæ³•**:
```yaml
variables:
  # ç›´æ¥æŒ‡å®š profile åç§°
  api_url: "${config.profiles.dev.base_url}"
```

## æµ‹è¯•è¦†ç›–

### å•å…ƒæµ‹è¯•

- `tests/core/test_variable_manager.py::TestConfigContext`
  - 7 ä¸ªæµ‹è¯•ç”¨ä¾‹
  - è¦†ç›– config ä¸Šä¸‹æ–‡è®¾ç½®ã€æ¸²æŸ“ã€ç¼“å­˜å¤±æ•ˆç­‰åŠŸèƒ½

### é›†æˆæµ‹è¯•

- `tests/parser/test_nested_variable_reference.py`
  - 9 ä¸ªæµ‹è¯•ç”¨ä¾‹
  - è¦†ç›–å„ç§åµŒå¥—å¼•ç”¨åœºæ™¯

### æµ‹è¯•ç»“æœ

```
61 passed in 0.14s
```

æ‰€æœ‰æµ‹è¯•é€šè¿‡,åŒ…æ‹¬:
- æ–°å¢çš„ 16 ä¸ªæµ‹è¯•
- ç°æœ‰çš„ 45 ä¸ªå˜é‡ç®¡ç†å™¨æµ‹è¯•

## å‘åå…¼å®¹æ€§

âœ… **å®Œå…¨å‘åå…¼å®¹**
- æ‰€æœ‰ç°æœ‰æµ‹è¯•é€šè¿‡
- æ—§è¯­æ³•ç»§ç»­æ”¯æŒ
- æ–°åŠŸèƒ½ä¸ºå¯é€‰é¡¹

## ä½¿ç”¨å»ºè®®

### æ¨èåšæ³•

1. **ä½¿ç”¨åµŒå¥—å¼•ç”¨å‡å°‘é‡å¤**
   ```yaml
   variables:
     base_suffix: "${config.profiles.dev.variables.test_suffix}"
     category: "cat_${base_suffix}"
     datasource: "ds_${base_suffix}"
   ```

2. **ç»„ç»‡å¥½å˜é‡ç»“æ„**
   ```yaml
   config:
     profiles:
       dev:
         variables:
           env: "dev"
           suffix: "001"

   variables:
     # å…ˆæå–å¸¸ç”¨å€¼
     env: "${config.profiles.dev.variables.env}"
     suffix: "${config.profiles.dev.variables.suffix}"

     # å†ç»„åˆä½¿ç”¨
     resource_name: "${env}_${suffix}"
   ```

3. **ä¿æŒæ¸…æ™°çš„å¯è¯»æ€§**
   ```yaml
   # âœ… å¥½ - æ¸…æ™°æ˜“æ‡‚
   category_name: "test_${config.profiles.dev.variables.test_suffix}"

   # âŒ é¿å… - è¿‡äºå¤æ‚
   category: "test_${config.profiles.${config.active_profile}.variables.${config.some_var}}"
   ```

## æ€§èƒ½å½±å“

- **ç¼“å­˜æœºåˆ¶**: config ä¸Šä¸‹æ–‡å˜æ›´æ—¶ä¼šè‡ªåŠ¨å¤±æ•ˆç¼“å­˜
- **æ¸²æŸ“æ€§èƒ½**: ä¸ä¹‹å‰ç›¸åŒ,ä½¿ç”¨ Jinja2 æ¨¡æ¿å¼•æ“
- **å†…å­˜å ç”¨**: config å¯¹è±¡åœ¨å˜é‡ç®¡ç†å™¨ä¸­åªæœ‰ä¸€ä»½å‰¯æœ¬

## ç›¸å…³æ–‡æ¡£

- åŠŸèƒ½æ”¹è¿›å»ºè®®: `é—®é¢˜è·Ÿè¸ªæ–‡æ¡£/SisyphusåŠŸèƒ½æ”¹è¿›å»ºè®®.md` (ä»»åŠ¡ 1)
- ç¤ºä¾‹æ–‡ä»¶: `examples/å˜é‡åµŒå¥—å¼•ç”¨ç¤ºä¾‹.yaml`
- æµ‹è¯•æ–‡ä»¶:
  - `tests/core/test_variable_manager.py`
  - `tests/parser/test_nested_variable_reference.py`

## æœªæ¥æ”¹è¿›æ–¹å‘

å¯èƒ½çš„å¢å¼ºåŠŸèƒ½:
1. æ”¯æŒåŠ¨æ€é”®è®¿é—® (éœ€è¦è‡ªå®šä¹‰æ¨¡æ¿å‡½æ•°)
2. æ·»åŠ å¾ªç¯å¼•ç”¨æ£€æµ‹
3. æä¾›å˜é‡å¼•ç”¨è°ƒè¯•å·¥å…·
4. æ”¯æŒæ›´å¤šçš„è·¯å¾„ç®€å†™è¯­æ³•

## æ€»ç»“

è¿™ä¸ªåŠŸèƒ½å¤§å¤§æå‡äº† YAML æµ‹è¯•ç”¨ä¾‹çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§:

- âœ… å‡å°‘é‡å¤ä»£ç 
- âœ… æé«˜å¯è¯»æ€§
- âœ… ç®€åŒ–å˜é‡ç®¡ç†
- âœ… å®Œå…¨å‘åå…¼å®¹
- âœ… å……åˆ†æµ‹è¯•è¦†ç›–

**ç”¨æˆ·ä»·å€¼**: â­â­â­â­â­
**å®ç°éš¾åº¦**: ğŸŸ¢ ä½
**ç»´æŠ¤æˆæœ¬**: ğŸŸ¢ ä½
