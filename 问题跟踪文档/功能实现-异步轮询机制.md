# å¼‚æ­¥è½®è¯¢æœºåˆ¶åŠŸèƒ½å®ç°è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

**åŠŸèƒ½åç§°**: å¼‚æ­¥è½®è¯¢æœºåˆ¶ (Async Polling Mechanism)
**å®ç°æ—¥æœŸ**: 2026-02-02
**ä¼˜å…ˆçº§**: ğŸ”´ é«˜ä¼˜å…ˆçº§
**çŠ¶æ€**: âœ… å·²å®Œæˆ

## é—®é¢˜æè¿°

åœ¨æµ‹è¯•å¼‚æ­¥æ“ä½œ(å¦‚é¡¹ç›®åˆ›å»ºã€å…ƒæ•°æ®åŒæ­¥)æ—¶,éœ€è¦ç­‰å¾…æ“ä½œå®Œæˆåæ‰èƒ½æ‰§è¡Œä¸‹ä¸€æ­¥ã€‚å½“å‰æ¡†æ¶ä¸æ”¯æŒè½®è¯¢æœºåˆ¶,å¯¼è‡´æµ‹è¯•ä¸ç¨³å®šæˆ–éœ€è¦äººå·¥ä¼°ç®—ç­‰å¾…æ—¶é—´ã€‚

### ä¹‹å‰çš„é™åˆ¶

```yaml
# âŒ é¡¹ç›®åˆšåˆ›å»ºæ— æ³•ç«‹å³åˆ é™¤ (error code 272)
- name: "åˆ›å»ºé¡¹ç›®"
  # åˆ›å»ºé¡¹ç›®éœ€è¦æ—¶é—´åˆå§‹åŒ–

- name: "åˆ é™¤é¡¹ç›®"
  # å¤±è´¥!é¡¹ç›®è¿˜åœ¨åˆå§‹åŒ–ä¸­
  # é”™è¯¯: {"code": 272, "message": "é¡¹ç›®ä¸èƒ½è¢«åˆ é™¤"}
```

### å½“å‰çš„å˜é€šæ–¹æ¡ˆ(ä¸ç¨³å®š)

```yaml
# âŒ å¼ºåˆ¶ç­‰å¾…,å¯èƒ½ä¸å¤Ÿæˆ–å¤ªé•¿
- name: "å¼ºåˆ¶ç­‰å¾…"
  type: sleep
  duration: 10000  # ç­‰å¾…10ç§’,ä½†å¯èƒ½ä¸å¤Ÿæˆ–å¤ªé•¿

- name: "åˆ é™¤é¡¹ç›®"
  # å¸Œæœ›å·²ç»åˆå§‹åŒ–å®Œæˆ
```

## è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒæ”¹è¿›

1. **æ–°å¢ `poll` æ­¥éª¤ç±»å‹**
   - æ”¯æŒè½®è¯¢æ£€æŸ¥æ¡ä»¶æ˜¯å¦æ»¡è¶³
   - æ”¯æŒå¤šç§æ¡ä»¶åˆ¤æ–­æ–¹å¼(JSONPath/çŠ¶æ€ç )
   - æ”¯æŒå¯é…ç½®çš„è½®è¯¢ç­–ç•¥(å›ºå®šé—´éš”/æŒ‡æ•°é€€é¿/çº¿æ€§å¢é•¿)
   - æ”¯æŒè¶…æ—¶å¤„ç†(å¤±è´¥/ç»§ç»­)

2. **åˆ›å»º PollStepExecutor æ‰§è¡Œå™¨**
   - ç»§æ‰¿ StepExecutor åŸºç±»
   - å®ç°è½®è¯¢é€»è¾‘å’Œæ¡ä»¶æ£€æŸ¥
   - æ”¯æŒå¤šç§é€€é¿ç­–ç•¥

3. **é›†æˆåˆ°æµ‹è¯•ç”¨ä¾‹æ‰§è¡Œå™¨**
   - åœ¨ TestCaseExecutor ä¸­æ³¨å†Œ poll ç±»å‹
   - åœ¨ V2YamlParser ä¸­è§£æ poll_config å’Œ on_timeout

### ç°åœ¨æ”¯æŒçš„åŠŸèƒ½

```yaml
# âœ… æ”¯æŒè½®è¯¢ç­‰å¾…
- name: "ç­‰å¾…é¡¹ç›®å°±ç»ª"
  type: poll
  url: "/api/rdos/batch/project/getProjectList"
  method: POST
  body:
    projectId: "${project_id}"
  poll_config:
    # è½®è¯¢æ¡ä»¶
    condition:
      type: jsonpath
      path: "$.data[?(@.projectId == ${project_id})].status"
      operator: "eq"
      expect: "ACTIVE"
    # è½®è¯¢ç­–ç•¥
    max_attempts: 30        # æœ€å¤š30æ¬¡
    interval: 2000          # æ¯2ç§’ä¸€æ¬¡
    timeout: 60000          # æ€»è¶…æ—¶60ç§’
    backoff: "fixed"        # å›ºå®šé—´éš” / exponential æŒ‡æ•°é€€é¿ / linear çº¿æ€§
  on_timeout:
    behavior: "fail"        # fail / continue
    message: "é¡¹ç›®åˆå§‹åŒ–è¶…æ—¶"

- name: "åˆ é™¤é¡¹ç›®"
  depends_on: "ç­‰å¾…é¡¹ç›®å°±ç»ª"
  # ç°åœ¨å¯ä»¥å®‰å…¨åˆ é™¤,ä¿è¯é¡¹ç›®å·²å°±ç»ª
```

## ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: è½®è¯¢ç­‰å¾…çŠ¶æ€

```yaml
- name: "è½®è¯¢ç­‰å¾…é¡¹ç›®å°±ç»ª"
  type: poll
  url: "https://api.example.com/project/status"
  method: GET
  poll_config:
    condition:
      type: jsonpath
      path: "$.data.status"
      operator: "eq"
      expect: "ACTIVE"
    max_attempts: 30
    interval: 2000
    timeout: 60000
    backoff: "fixed"
```

### ç¤ºä¾‹ 2: è½®è¯¢ç­‰å¾…æ•°å€¼æ¡ä»¶

```yaml
- name: "è½®è¯¢ç­‰å¾…è¿›åº¦å®Œæˆ"
  type: poll
  url: "https://api.example.com/progress"
  method: GET
  poll_config:
    condition:
      type: jsonpath
      path: "$.data.progress"
      operator: "ge"  # å¤§äºç­‰äº
      expect: 100
    max_attempts: 10
    interval: 1000
    timeout: 30000
    backoff: "exponential"
```

### ç¤ºä¾‹ 3: è½®è¯¢ç­‰å¾…çŠ¶æ€ç 

```yaml
- name: "è½®è¯¢ç­‰å¾…æœåŠ¡å¯ç”¨"
  type: poll
  url: "https://api.example.com/health"
  method: GET
  poll_config:
    condition:
      type: status_code
      operator: "eq"
      expect: 200
    max_attempts: 20
    interval: 3000
    timeout: 120000
    backoff: "linear"
```

### ç¤ºä¾‹ 4: è¶…æ—¶å¤„ç†

```yaml
- name: "è½®è¯¢ç­‰å¾…(è¶…æ—¶ç»§ç»­)"
  type: poll
  url: "https://api.example.com/status"
  method: GET
  poll_config:
    condition:
      type: jsonpath
      path: "$.status"
      operator: "eq"
      expect: "ready"
    max_attempts: 5
    interval: 2000
    timeout: 10000
    backoff: "fixed"
  on_timeout:
    behavior: "continue"  # è¶…æ—¶åç»§ç»­æ‰§è¡Œ
    message: "æœåŠ¡å¯åŠ¨è¶…æ—¶,è·³è¿‡æ­¤æ­¥éª¤"
```

## å®ç°ç»†èŠ‚

### ä¿®æ”¹çš„æ–‡ä»¶

1. **apirun/core/models.py**
   - åœ¨ TestStep ä¸­æ·»åŠ  `poll_config` å’Œ `on_timeout` å­—æ®µ

2. **apirun/executor/poll_executor.py** (æ–°æ–‡ä»¶)
   - å®ç° PollStepExecutor ç±»
   - æ”¯æŒå¤šç§æ¡ä»¶æ£€æŸ¥æ–¹å¼
   - å®ç°é€€é¿ç­–ç•¥ç®—æ³•

3. **apirun/executor/test_case_executor.py**
   - å¯¼å…¥ PollStepExecutor
   - åœ¨ _execute_step ä¸­æ³¨å†Œ poll ç±»å‹

4. **apirun/parser/v2_yaml_parser.py**
   - è§£æ poll_config å’Œ on_timeout å­—æ®µ
   - ä¼ é€’ç»™ TestStep æ„é€ å‡½æ•°

### è½®è¯¢é…ç½®å‚æ•°

#### poll_config

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| condition | object | å¿…å¡« | è½®è¯¢æ¡ä»¶é…ç½® |
| max_attempts | int | 30 | æœ€å¤§è½®è¯¢æ¬¡æ•° |
| interval | int | 2000 | è½®è¯¢é—´éš”(æ¯«ç§’) |
| timeout | int | 60000 | æ€»è¶…æ—¶æ—¶é—´(æ¯«ç§’) |
| backoff | string | "fixed" | é€€é¿ç­–ç•¥(fixed/exponential/linear) |

#### condition

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| type | string | "jsonpath" | æ¡ä»¶ç±»å‹(jsonpath/status_code) |
| path | string | å¿…å¡« | JSONPath è¡¨è¾¾å¼ |
| operator | string | "eq" | æ¯”è¾ƒè¿ç®—ç¬¦(eq/ne/gt/lt/ge/le/contains/exists) |
| expect | any | å¿…å¡« | æœŸæœ›å€¼ |

#### on_timeout

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| behavior | string | "fail" | è¶…æ—¶è¡Œä¸º(fail/continue) |
| message | string | - | è¶…æ—¶é”™è¯¯æ¶ˆæ¯ |

### é€€é¿ç­–ç•¥

1. **fixed (å›ºå®šé—´éš”)**
   - æ¯æ¬¡è½®è¯¢é—´éš”ç›¸åŒ
   - ä¾‹å¦‚: interval=2000 â†’ æ¯2ç§’è½®è¯¢ä¸€æ¬¡

2. **exponential (æŒ‡æ•°é€€é¿)**
   - æ¯æ¬¡é—´éš”ç¿»å€
   - ä¾‹å¦‚: interval=1000 â†’ 1s, 2s, 4s, 8s, ...

3. **linear (çº¿æ€§å¢é•¿)**
   - æ¯æ¬¡é—´éš”çº¿æ€§å¢åŠ 
   - ä¾‹å¦‚: interval=1000 â†’ 1s, 2s, 3s, 4s, ...

### æ”¯æŒçš„æ¯”è¾ƒè¿ç®—ç¬¦

| è¿ç®—ç¬¦ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|
| eq | ç­‰äº | expect: "ACTIVE" |
| ne | ä¸ç­‰äº | expect: "PENDING" |
| gt | å¤§äº | expect: 100 |
| lt | å°äº | expect: 10 |
| ge | å¤§äºç­‰äº | expect: 100 |
| le | å°äºç­‰äº | expect: 10 |
| contains | åŒ…å« | expect: "target" |
| exists | å­˜åœ¨ | æ— éœ€expect |

## æµ‹è¯•è¦†ç›–

### å•å…ƒæµ‹è¯•

- `tests/executor/test_poll_executor.py`
  - 20 ä¸ªæµ‹è¯•ç”¨ä¾‹
  - è¦†ç›–æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½

### æµ‹è¯•ç»“æœ

```
20 passed in 0.70s
```

æµ‹è¯•è¦†ç›–:
- âœ… JSONPath æ¡ä»¶æ£€æŸ¥
- âœ… çŠ¶æ€ç æ¡ä»¶æ£€æŸ¥
- âœ… æ•°å€¼æ¯”è¾ƒ
- âœ… é€€é¿ç­–ç•¥(fixed/exponential/linear)
- âœ… è¶…æ—¶å¤„ç†(fail/continue)
- âœ… å¤šæ¬¡è½®è¯¢
- âœ… é”™è¯¯å¤„ç†

## å‘åå…¼å®¹æ€§

âœ… **å®Œå…¨å‘åå…¼å®¹**
- æ–°å¢æ­¥éª¤ç±»å‹,ä¸å½±å“ç°æœ‰æ­¥éª¤
- æ‰€æœ‰ç°æœ‰æµ‹è¯•ç»§ç»­é€šè¿‡
- æ—§è¯­æ³•ç»§ç»­æ”¯æŒ

## ä½¿ç”¨å»ºè®®

### æ¨èåšæ³•

1. **è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´**
   ```yaml
   poll_config:
     timeout: 120000  # æ ¹æ®å®é™…æ“ä½œæ—¶é—´è®¾ç½®
   ```

2. **é€‰æ‹©åˆé€‚çš„é€€é¿ç­–ç•¥**
   - **fixed**: é€‚åˆå¿«é€Ÿå®Œæˆçš„æ“ä½œ
   - **exponential**: é€‚åˆå¯èƒ½è€—æ—¶çš„æ“ä½œ
   - **linear**: é€‚åˆæ“ä½œæ—¶é—´å¯é¢„æµ‹çš„åœºæ™¯

3. **æä¾›æ¸…æ™°çš„é”™è¯¯æ¶ˆæ¯**
   ```yaml
   on_timeout:
     message: "é¡¹ç›®åˆå§‹åŒ–è¶…æ—¶,é¢„æœŸ30ç§’å†…å®Œæˆ"
   ```

4. **ç»“åˆ depends_on ä½¿ç”¨**
   ```yaml
   - name: "åˆ›å»ºé¡¹ç›®"
     # ...

   - name: "ç­‰å¾…é¡¹ç›®å°±ç»ª"
     type: poll
     depends_on: "åˆ›å»ºé¡¹ç›®"
     # ...
   ```

### æ³¨æ„äº‹é¡¹

1. **é¿å…è½®è¯¢æ—¶é—´è¿‡é•¿**
   - å»ºè®®æ€»è¶…æ—¶ä¸è¶…è¿‡ 5 åˆ†é’Ÿ
   - è¿‡é•¿çš„è½®è¯¢å¯èƒ½å½±å“æµ‹è¯•æ•ˆç‡

2. **åˆç†è®¾ç½®è½®è¯¢é—´éš”**
   - é—´éš”å¤ªçŸ­ä¼šå¢åŠ æœåŠ¡å™¨è´Ÿè½½
   - é—´éš”å¤ªé•¿ä¼šå»¶é•¿æµ‹è¯•æ—¶é—´
   - å»ºè®®: 1-5 ç§’

3. **å¤„ç†è¶…æ—¶æƒ…å†µ**
   - æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹© fail æˆ– continue
   - å…³é”®æ“ä½œå»ºè®®ä½¿ç”¨ fail
   - å¯é€‰æ“ä½œå¯ä»¥ä½¿ç”¨ continue

## æ€§èƒ½å½±å“

- **ç½‘ç»œè¯·æ±‚**: æ¯æ¬¡è½®è¯¢éƒ½ä¼šå‘é€ HTTP è¯·æ±‚
- **ç­‰å¾…æ—¶é—´**: æ€»ç­‰å¾…æ—¶é—´ = attempts Ã— interval (å—é€€é¿ç­–ç•¥å½±å“)
- **èµ„æºå ç”¨**: æœ€å°åŒ–,è½®è¯¢æœŸé—´åªæ˜¯ç­‰å¾…å’Œå‘é€è¯·æ±‚

## ç›¸å…³æ–‡æ¡£

- åŠŸèƒ½æ”¹è¿›å»ºè®®: `é—®é¢˜è·Ÿè¸ªæ–‡æ¡£/SisyphusåŠŸèƒ½æ”¹è¿›å»ºè®®.md` (ä»»åŠ¡ 2)
- ç¤ºä¾‹æ–‡ä»¶: `examples/å¼‚æ­¥è½®è¯¢ç¤ºä¾‹.yaml`
- æµ‹è¯•æ–‡ä»¶: `tests/executor/test_poll_executor.py`

## æœªæ¥æ”¹è¿›æ–¹å‘

å¯èƒ½çš„å¢å¼ºåŠŸèƒ½:
1. æ”¯æŒè‡ªå®šä¹‰è„šæœ¬æ¡ä»¶
2. æ”¯æŒåŒæ—¶æ£€æŸ¥å¤šä¸ªæ¡ä»¶(AND/OR)
3. æä¾›è½®è¯¢è¿›åº¦å›è°ƒ
4. æ”¯æŒæ¡ä»¶å˜åŒ–çš„æ—¥å¿—è®°å½•
5. æ”¯æŒåŠ¨æ€è°ƒæ•´è½®è¯¢é—´éš”

## æ€»ç»“

è¿™ä¸ªåŠŸèƒ½å¤§å¤§æå‡äº†å¼‚æ­¥æ“ä½œæµ‹è¯•çš„ç¨³å®šæ€§å’Œå¯é æ€§:

- âœ… è§£å†³å¼‚æ­¥æ“ä½œæµ‹è¯•éš¾é¢˜
- âœ… æé«˜æµ‹è¯•ç¨³å®šæ€§
- âœ… å‡å°‘ç¡¬ç¼–ç ç­‰å¾…æ—¶é—´
- âœ… çµæ´»çš„æ¡ä»¶æ£€æŸ¥
- âœ… å¯é…ç½®çš„è½®è¯¢ç­–ç•¥
- âœ… å®Œå…¨å‘åå…¼å®¹
- âœ… å……åˆ†æµ‹è¯•è¦†ç›–

**ç”¨æˆ·ä»·å€¼**: â­â­â­â­â­
**å®ç°éš¾åº¦**: ğŸŸ¡ ä¸­
**ç»´æŠ¤æˆæœ¬**: ğŸŸ¢ ä½
