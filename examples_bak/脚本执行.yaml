# Sisyphus API Engine - Script Execution Example
# 测试自定义脚本执行功能

name: "脚本执行测试"
description: "测试 Python 脚本在测试用例中的执行"

config:
  name: "脚本测试配置"
  variables:
    base_value: 100
    multiplier: 2

steps:
  # 测试1: 基本变量计算
  - 基本计算脚本:
      type: script
      script_type: python
      script: |
        # 访问配置变量
        base = get_var("base_value", 0)
        mult = get_var("multiplier", 1)

        # 执行计算
        result = base * mult

        # 设置新变量
        set_var("calculated_value", result)
        set_var("calculation_log", f"{base} * {mult} = {result}")

        # 打印输出
        print(f"计算完成: {base} * {mult} = {result}")

  # 测试2: 使用标准库
  - 使用标准库脚本:
      type: script
      script_type: python
      allow_imports: true
      script: |
        import json
        import datetime
        import random

        # 创建复杂数据
        data = {
            "timestamp": datetime.datetime.now().isoformat(),
            "random_value": random.randint(1, 100),
            "items": [1, 2, 3, 4, 5]
        }

        # JSON 序列化
        json_str = json.dumps(data, indent=2)

        # 设置变量
        set_var("json_data", json_str)
        set_var("random_number", data["random_value"])

        print(f"生成的数据: {json_str}")

  # 测试3: 字符串处理
  - 字符串处理脚本:
      type: script
      script_type: python
      allow_imports: true
      script: |
        import re
        import string

        # 字符串操作
        text = "Hello, Sisyphus API Engine!"
        words = text.split()

        # 正则表达式匹配
        pattern = r"S\w+"
        matches = re.findall(pattern, text)

        # 设置结果变量
        set_var("word_count", len(words))
        set_var("matches", matches)
        set_var("uppercase_text", text.upper())

        print(f"单词数量: {len(words)}")
        print(f"匹配结果: {matches}")

  # 测试4: 数据转换
  - 数据转换脚本:
      type: script
      script_type: python
      script: |
        # 列表和字典操作
        numbers = [1, 2, 3, 4, 5]

        # 计算统计信息
        total = sum(numbers)
        average = total / len(numbers)
        squares = [n ** 2 for n in numbers]

        # 创建结果字典
        result = {
            "sum": total,
            "avg": average,
            "squares": squares,
            "count": len(numbers)
        }

        # 设置变量
        set_var("stats", result)
        set_var("total_sum", total)

        print(f"统计结果: {result}")

  # 测试5: 访问之前计算的变量
  - 使用之前变量的脚本:
      type: script
      script_type: python
      script: |
        # 获取之前步骤设置的变量
        calc_value = get_var("calculated_value", 0)
        total = get_var("total_sum", 0)

        # 组合计算
        final_result = calc_value + total

        # 设置最终结果
        set_var("final_result", final_result)
        set_var("result_description", f"Calculated: {calc_value} + Total: {total} = {final_result}")

        print(f"最终结果: {final_result}")

  # 测试6: 验证脚本结果
  - 验证脚本结果:
      type: script
      script_type: python
      script: |
        # 验证所有变量是否正确设置
        expected_values = {
            "calculated_value": 200,  # 100 * 2
            "final_result": 220,  # 200 + 20 (1+2+3+4+5)
        }

        validation_results = []
        for var_name, expected in expected_values.items():
            actual = get_var(var_name)
            if actual == expected:
                validation_results.append(f"✓ {var_name} = {actual} (正确)")
            else:
                validation_results.append(f"✗ {var_name} = {actual} (期望: {expected})")

        # 设置验证结果
        set_var("validation_results", validation_results)

        # 打印结果
        for result in validation_results:
            print(result)

tags:
  - "script"
  - "advanced"

enabled: true
