---
description: 执行项目重构工作流程（代码review、中文注释、测试、文档）
---

# Sisyphus API Engine 重构工作流程

> 🎯 本命令用于新窗口快速恢复重构上下文，并规范化整个重构流程。

---

## 📋 第一步：上下文恢复

每次开始工作时，**必须先执行以下步骤**：

### 1.1 读取核心文档
```bash
# 必读文档（按顺序）
1. 重构任务清单.md       # 了解整体进度和当前阶段
2. docs/RoadMap.md       # 了解学习路径和文档结构
3. docs/template_docs.md # 了解文档编写规范
```

### 1.2 确认当前状态
- 查看 `重构任务清单.md` 中的 `📊 进度统计` 和 `📝 更新日志`
- 识别**进行中**的任务（标记为 `[/]`）
- 识别**下一个待开始**的任务

### 1.3 输出状态摘要
向用户汇报：
- 当前阶段和进度百分比
- 上次完成的任务
- 本次建议执行的任务
- 是否有未完成的中间工作

---

## 🔍 第二步：功能发现与调整

在代码 review 过程中，若发现**重构任务清单中未列出的功能**：

### 2.1 功能评估
- **分析功能**：确定功能名称、用途、依赖关系
- **确定归属**：属于哪个模块/阶段
- **评估影响**：是否影响现有文档结构

### 2.2 调整任务清单
更新 `重构任务清单.md`：
- 在对应阶段添加新任务项
- 如需新建阶段，调整所有后续阶段序号
- 更新 `📊 进度统计` 中的总任务数
- 在 `📝 更新日志` 记录调整原因

### 2.3 同步文档结构
更新 `docs/` 目录：
```bash
# 如果新功能需要独立文档
1. 创建 docs/<新序号>_<功能名称>.md
2. 调整受影响文档的序号（mv 旧序号_xxx.md 新序号_xxx.md）
3. 更新 docs/RoadMap.md 中的学习路径
4. 更新所有文档中的相互引用链接
```

### 2.4 规划测试和案例
确定新增内容的位置：
- 单元测试：`tests/<module>/test_<file>.py`
- YAML案例：`examples/<序号>_<功能名称>.yaml`

---

## 🔧 第三步：代码 Review 与重构

### 3.1 代码审查
- 逐个查看当前阶段涉及的文件
- 理解代码逻辑和设计意图
- 识别不合理设计并记录

### 3.2 中文注释改写
- 将英文注释改为 Google Python Style 的中文注释
- 保持 docstring 格式规范：
  ```python
  def function_name(arg1: str, arg2: int) -> bool:
      """函数简要描述。

      详细描述（如需要）。

      参数：
          arg1: 参数1描述
          arg2: 参数2描述

      返回：
          返回值描述

      异常：
          ValueError: 异常情况描述
      """
  ```

### 3.3 逻辑优化
- 如发现问题，先向用户确认再修改
- 重构后保证功能不变

---

## 🧪 第四步：测试与验证

### 4.1 单元测试
- **从零编写**，不参考旧测试文件
- 使用中文注释
- 覆盖场景：正常、边界、异常
- 目标覆盖率：80%+

### 4.2 运行测试
```bash
# 运行指定模块测试
pytest tests/<module>/ -v --tb=short

# 运行全部测试
pytest tests/ -v
```

### 4.3 YAML 案例
- 位置：`examples/<序号>_<功能名称>.yaml`
- 覆盖所有关键字和使用场景
- 确保能正常执行

---

## 📝 第五步：文档更新

### 5.1 详细文档
- 按 `docs/template_docs.md` 模板规范
- 更新 `docs/<序号>_<功能名称>.md`
- 包含：概述、核心概念、关键字参考、示例、最佳实践

### 5.2 其他文档
- `README.md` - 更新功能描述和使用示例
- `CHANGELOG.md` - 记录变更内容
- `pyproject.toml` - 版本号和依赖（如需）

---

## 📤 第六步：提交与记录

### 6.1 更新任务清单
```markdown
# 在重构任务清单.md中
- [ ] 任务名称   →   - [x] 任务名称
```

### 6.2 更新进度统计
```markdown
## 📊 进度统计
- 已完成：+N 项
```

### 6.3 更新日志
```markdown
## 📝 更新日志
| 日期 | 更新内容 | 操作人 |
|-----|---------|--------|
| YYYY-MM-DD | 完成xxx模块重构 | AI |
```

### 6.4 Git 提交（原子化）
格式：`<type>(<scope>): <emoji> <description>`
- `refactor(core)`: ♻️ 重构代码逻辑
- `test(core)`: ✅ 添加单元测试
- `docs(validation)`: 📝 更新验证文档
- `feat(extractor)`: ✨ 新增提取器功能
- `fix(parser)`: 🐛 修复解析问题

---

## ⚠️ 重要注意事项

1. **每次开新窗口必须先读取 `重构任务清单.md`**
2. **发现新功能必须同步调整所有相关文档**
3. **测试文件命名必须与源文件对应**：`xxx.py` → `test_xxx.py`
4. **YAML案例序号必须与文档序号对应**
5. **每完成一个模块必须更新任务清单状态**
6. **大改动前先向用户确认**

---

## 📂 项目关键路径

| 类别 | 路径 | 说明 |
|-----|------|------|
| 任务清单 | `重构任务清单.md` | 进度追踪 |
| 学习路径 | `docs/RoadMap.md` | 文档结构 |
| 文档模板 | `docs/template_docs.md` | 编写规范 |
| 详细文档 | `docs/<序号>_<名称>.md` | 功能文档 |
| 源代码 | `apirun/` | 核心代码 |
| 单元测试 | `tests/<module>/` | 测试代码 |
| YAML案例 | `examples/` | 使用示例 |
